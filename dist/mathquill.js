(()=>{"use strict";
/* @license
 * MathQuill, by Han, Jeanine, and Mary
 * http://mathquill.com | maintainers@mathquill.com
 *
 * Rewritten for the purposes of WeBWorK.
 * https://github.com/openwebwork
 *
 * This Source Code Form is subject to the terms of the
 * Mozilla Public License, v. 2.0. If a copy of the MPL
 * was not distributed with this file, You can obtain
 * one at http://mozilla.org/MPL/2.0/.
 */
const t="data-mathquill-command-id",e="data-mathquill-block-id",s=-1,n=1,i=()=>{},r=t=>(e,s,n)=>t("function"==typeof e?e:t=>{if(e in t)return t[e](s,n)}),o=(t,...e)=>class extends t{constructor(...t){super(...e)}},l=(t,e=!1)=>{if(!e)throw new Error(`prayer failed: ${t}`)},a=t=>{l("a direction was passed",t===s||t===n)},c=(t,e,i)=>{l("a parent is always present",!!t),l("leftward is properly set up",e?e[n]===i&&e.parent===t:(null==t?void 0:t.ends[s])===i),l("rightward is properly set up",i?i[s]===e&&i.parent===t:(null==t?void 0:t.ends[n])===e)},h={},d={},u={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{","\\{":"\\}","\\}":"\\{","&lang;":"&rang;","&rang;":"&lang;","\\langle ":"\\rangle ","\\rangle ":"\\langle ","|":"|","\\lVert ":"\\rVert ","\\rVert ":"\\lVert "},p={},f={};for(const t of["arg","det","dim","exp","gcd","hom","ker","lg","lim","max","min","sup","limsup","liminf","injlim","projlim","Pr"])f[t]=1;const m={limsup:1,liminf:1,projlim:1,injlim:1};var v,g,b,w,x,q,O,k,E,y,S,L,_,C,T,$,D,A,I,R,B,M,z,F,N,W,P,H,j,U,V,Q,K,G=function(t,e,s,n){if("a"===s&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(t):n?n.value:e.get(t)},Z=function(t,e,s,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(t,s):i?i.value=s:e.set(t,s),s};class X{constructor(){b.set(this,void 0),x.set(this,void 0),O.set(this,void 0),E.set(this,void 0),S.set(this,void 0),_.set(this,void 0),T.set(this,void 0),D.set(this,void 0),I.set(this,void 0),B.set(this,void 0),z.set(this,void 0),N.set(this,void 0),P.set(this,void 0),j.set(this,void 0),V.set(this,void 0),K.set(this,void 0),this.ignoreNextMousedown=()=>!1}static config(t,e){Object.assign(t,e)}get mouseEvents(){var t;return null!==(t=G(this,b,"f"))&&void 0!==t?t:G(X,v,"f",g)}set mouseEvents(t){this instanceof X?Z(this,b,t,"f"):Z(X,v,t,"f",g)}get autoCommands(){var t;return null!==(t=G(this,x,"f"))&&void 0!==t?t:G(X,v,"f",w)}set autoCommands(t){if("object"==typeof t)return void(this instanceof X?(Z(this,x,{_maxLength:0},"f"),Object.assign(G(this,x,"f"),t)):Object.assign(G(X,v,"f",w),t));if(!/^\s*[a-z]+(?:\s+[a-z]+)*\s*$/i.test(t))throw`"${t}" not a space-delimited list of only letters`;const e=t.trim().split(/\s+/),s={_maxLength:0};for(const t of e){if(t.length<2)throw`autocommand "${t}" not minimum length of 2`;if(t in f)throw`"${t}" is a built-in operator name`;s[t]=1,s._maxLength=Math.max(s._maxLength,t.length)}this instanceof X?Z(this,x,s,"f"):Z(X,v,s,"f",w)}addAutoCommands(t){if(G(this,x,"f")||(this.autoCommands=G(X,v,"f",w)),!G(this,x,"f"))throw"autoCommands setter not working";const e=t instanceof Array?t.map((t=>t.trim())):[t.trim()];for(const t of e){if(/\s/.test(t)||!/^[a-z]*$/i.test(t))throw`${t} is not a valid autocommand name`;if(t.length<2)throw`autocommand "${t}" not minimum length of 2`;if(t in f)throw`"${t}" is a built-in operator name`;G(this,x,"f")[t]=1,G(this,x,"f")._maxLength=Math.max(G(this,x,"f")._maxLength,t.length)}}removeAutoCommands(t){if(G(this,x,"f")||(this.autoCommands=G(X,v,"f",w)),!G(this,x,"f"))throw"autoCommands setter not working";const e=t instanceof Array?t.map((t=>t.trim())):[t.trim()];for(const t of e)delete G(this,x,"f")[t];G(this,x,"f")._maxLength=Object.keys(G(this,x,"f")).reduce(((t,e)=>"_maxLength"===e?t:e.length>t?e.length:t),0)}get autoOperatorNames(){var t;return null!==(t=G(this,O,"f"))&&void 0!==t?t:G(X,v,"f",q)}set autoOperatorNames(t){if("object"==typeof t)return void(this instanceof X?(Z(this,O,{_maxLength:0},"f"),Object.assign(G(this,O,"f"),t)):Object.assign(G(X,v,"f",q),t));if(!/^\s*[a-z]+(?:\s+[a-z]+)*\s*$/i.test(t))throw`"${t}" not a space-delimited list of only letters`;const e=t.trim().split(/\s+/),s={_maxLength:0};for(const t of e){if(t.length<2)throw`"${t}" not minimum length of 2`;s[t]=1,s._maxLength=Math.max(s._maxLength,t.length)}this instanceof X?Z(this,O,s,"f"):Z(X,v,s,"f",q)}addAutoOperatorNames(t){if(G(this,O,"f")||(this.autoOperatorNames=G(X,v,"f",q)),!G(this,O,"f"))throw"autoOperatorNames setter not working";const e=t instanceof Array?t.map((t=>t.trim())):[t.trim()];for(const t of e){if(/\s/.test(t)||!/^[a-z]*$/i.test(t))throw`${t} is not a valid autocommand name`;if(t.length<2)throw`"${t}" not minimum length of 2`;G(this,O,"f")[t]=1,G(this,O,"f")._maxLength=Math.max(G(this,O,"f")._maxLength,t.length)}}removeAutoOperatorNames(t){if(G(this,O,"f")||(this.autoOperatorNames=G(X,v,"f",q)),!G(this,O,"f"))throw"autoOperatorNames setter not working";const e=t instanceof Array?t.map((t=>t.trim())):[t.trim()];for(const t of e)delete G(this,O,"f")[t];G(this,O,"f")._maxLength=Object.keys(G(this,O,"f")).reduce(((t,e)=>"_maxLength"===e?t:e.length>t?e.length:t),0)}get charsThatBreakOutOfSupSub(){var t;return null!==(t=G(this,E,"f"))&&void 0!==t?t:G(X,v,"f",k)}set charsThatBreakOutOfSupSub(t){this instanceof X?Z(this,E,t,"f"):Z(X,v,t,"f",k)}get statelessClipboard(){var t;return null!==(t=G(this,S,"f"))&&void 0!==t?t:G(X,v,"f",y)}set statelessClipboard(t){this instanceof X?Z(this,S,t,"f"):Z(X,v,t,"f",y)}get spaceBehavesLikeTab(){var t;return null!==(t=G(this,_,"f"))&&void 0!==t?t:G(X,v,"f",L)}set spaceBehavesLikeTab(t){this instanceof X?Z(this,_,t,"f"):Z(X,v,t,"f",L)}get leftRightIntoCmdGoes(){var t;return null!==(t=G(this,T,"f"))&&void 0!==t?t:G(X,v,"f",C)}set leftRightIntoCmdGoes(t){if(t&&"up"!==t&&"down"!==t)throw`"up" or "down" required for leftRightIntoCmdGoes option, got "${t}"`;this instanceof X?Z(this,T,t,"f"):Z(X,v,t,"f",C)}get restrictMismatchedBrackets(){var t;return null!==(t=G(this,D,"f"))&&void 0!==t?t:G(X,v,"f",$)}set restrictMismatchedBrackets(t){this instanceof X?Z(this,D,t,"f"):Z(X,v,t,"f",$)}get sumStartsWithNEquals(){var t;return null!==(t=G(this,I,"f"))&&void 0!==t?t:G(X,v,"f",A)}set sumStartsWithNEquals(t){this instanceof X?Z(this,I,t,"f"):Z(X,v,t,"f",A)}get supSubsRequireOperand(){var t;return null!==(t=G(this,B,"f"))&&void 0!==t?t:G(X,v,"f",R)}set supSubsRequireOperand(t){this instanceof X?Z(this,B,t,"f"):Z(X,v,t,"f",R)}get rootsAreExponents(){var t;return null!==(t=G(this,z,"f"))&&void 0!==t?t:G(X,v,"f",M)}set rootsAreExponents(t){this instanceof X?Z(this,z,t,"f"):Z(X,v,t,"f",M)}get logsChangeBase(){var t;return null!==(t=G(this,N,"f"))&&void 0!==t?t:G(X,v,"f",F)}set logsChangeBase(t){this instanceof X?Z(this,N,t,"f"):Z(X,v,t,"f",F)}get maxDepth(){var t;return null!==(t=G(this,P,"f"))&&void 0!==t?t:G(X,v,"f",W)}set maxDepth(t){"number"==typeof t&&(this instanceof X?Z(this,P,t,"f"):Z(X,v,t,"f",W))}get autoSubscriptNumerals(){var t;return null!==(t=G(this,j,"f"))&&void 0!==t?t:G(X,v,"f",H)}set autoSubscriptNumerals(t){this instanceof X?Z(this,j,t,"f"):Z(X,v,t,"f",H)}get typingSlashWritesDivisionSymbol(){var t;return null!==(t=G(this,V,"f"))&&void 0!==t?t:G(X,v,"f",U)}set typingSlashWritesDivisionSymbol(t){this instanceof X?Z(this,V,t,"f"):Z(X,v,t,"f",U)}get typingAsteriskWritesTimesSymbol(){var t;return null!==(t=G(this,K,"f"))&&void 0!==t?t:G(X,v,"f",Q)}set typingAsteriskWritesTimesSymbol(t){this instanceof X?Z(this,K,t,"f"):Z(X,v,t,"f",Q)}substituteTextarea(){const t=document.createElement("textarea");return t.setAttribute("autocapitalize","off"),t.setAttribute("autocomplete","off"),t.setAttribute("spellcheck","false"),t}}v=X,b=new WeakMap,x=new WeakMap,O=new WeakMap,E=new WeakMap,S=new WeakMap,_=new WeakMap,T=new WeakMap,D=new WeakMap,I=new WeakMap,B=new WeakMap,z=new WeakMap,N=new WeakMap,P=new WeakMap,j=new WeakMap,V=new WeakMap,K=new WeakMap,g={value:!0},w={value:{_maxLength:0}},q={value:(()=>{const t={_maxLength:9};for(const e of["arg","det","dim","exp","gcd","hom","ker","lg","lim","max","min","sup","limsup","liminf","injlim","projlim","Pr"])t[e]=1;for(const e of["gcf","hcf","lcm","proj","span"])t[e]=1;return t})()},k={value:""},y={value:!1},L={value:!1},C={value:void 0},$={value:!1},A={value:!1},R={value:!1},M={value:!1},F={value:!1},W={value:void 0},H={value:!1},U={value:!1},Q={value:!1};class Y{constructor(t){if(this.contents=[],t instanceof Y)this.contents.push(...t.contents);else if(t instanceof Node)this.contents.push(t);else if(t instanceof Array)this.contents.push(...t);else if(t){const e=document.createRange().createContextualFragment(t);this.contents.push(...e.children)}}add(t){this.contents.push(...t instanceof Y?t.contents:t instanceof Array?t:[t]),this.contents.sort(((t,e)=>{if(t===e)return 0;const s=t.compareDocumentPosition(e);return s&Node.DOCUMENT_POSITION_FOLLOWING||s&Node.DOCUMENT_POSITION_CONTAINED_BY?-1:s&Node.DOCUMENT_POSITION_PRECEDING||s&Node.DOCUMENT_POSITION_CONTAINS?1:0}))}get first(){return this.contents[0]instanceof Element||this.contents[0]instanceof CharacterData?this.contents[0]:document.createElement("span")}get last(){const t=this.contents[this.contents.length-1];return t instanceof Element||t instanceof CharacterData?t:document.createElement("span")}get firstElement(){return this.first instanceof HTMLElement?this.first:document.createElement("span")}get lastElement(){return this.last instanceof HTMLElement?this.last:document.createElement("span")}detach(){this.contents.forEach((t=>t.remove()))}remove(){this.detach(),this.contents=[]}empty(){this.contents.forEach((t=>{for(;t.firstChild;)t.firstChild.remove();t.textContent=""}))}children(t){return new Y(this.contents.reduce(((e,s)=>(e.push(...Array.from(s.childNodes).filter((e=>3!==e.nodeType&&(!t||e instanceof Element&&e.matches(t))))),e)),[]))}find(t){return new Y(this.contents.reduce(((e,s)=>(e.push(...s.querySelectorAll(t)),e)),[]))}addClass(...t){this.contents.forEach((e=>{e instanceof Element&&e.classList.add(...t)}))}removeClass(...t){this.contents.forEach((e=>{e instanceof Element&&e.classList.remove(...t)}))}toggleClass(t,e){this.contents.forEach((s=>{s instanceof Element&&s.classList.toggle(t,e)}))}hasClass(t){for(const e of this.contents)if(e instanceof Element&&e.classList.contains(t))return!0;return!1}html(t){var e,s;return"string"==typeof t?(this.contents.forEach((e=>{e instanceof Element&&(e.innerHTML=t)})),this):null!==(s=null===(e=this.firstElement)||void 0===e?void 0:e.innerHTML)&&void 0!==s?s:""}text(t){return t?(this.contents.forEach((e=>{e instanceof Element&&(e.textContent=t)})),this):this.contents.reduce(((t,e)=>{var s;return`${t}${null!==(s=e.textContent)&&void 0!==s?s:""}`}),"")}insDirOf(t,e){e instanceof Y&&!e.contents.length||(t===s?(e instanceof Y?e.first:e).before(...this.contents):(e instanceof Y?e.last:e).after(...this.contents))}insAtDirEnd(t,e){e instanceof Y&&!e.contents.length||(t===s?(e instanceof Y?e.firstElement:e).prepend(...this.contents):(e instanceof Y?e.lastElement:e).append(...this.contents))}}class J{constructor(t,e,i=s){if(this.elements=new Y,this.ends={},this.each=r((t=>{var e;let i=this.ends[s];if(!i)return this;for(;i!==(null===(e=this.ends[n])||void 0===e?void 0:e[n])&&!1!==t(i);i=null==i?void 0:i[n]);return this})),l("no half-empty fragments",!t==!e),!t)return;l("withDir is passed to Fragment",t instanceof st),l("oppDir is passed to Fragment",e instanceof st),l("withDir and oppDir have the same parent",t.parent===(null==e?void 0:e.parent)),this.ends[i]=t,this.ends[i===s?n:s]=e;const o=this.fold([],((t,e)=>(t.push(...e.elements.contents),t)));this.elements.add(o)}withDirAdopt(t,e,n,i){return t===s?this.adopt(e,n,i):this.adopt(e,i,n)}adopt(t,e,i){c(t,e,i),this.disowned=!1;const r=this.ends[s];if(!r)return this;const o=this.ends[n];return e||(t.ends[s]=r),i?i[s]=o:t.ends[n]=o,this.ends[n][n]=i,this.each((i=>{i[s]=e,i.parent=t,e&&(e[n]=i),e=i})),this}disown(){const t=this.ends[s];if(!t||this.disowned)return this;this.disowned=!0;const e=this.ends[n],i=t.parent;return c(i,t[s],t),c(i,e,null==e?void 0:e[n]),t[s]?t[s][n]=null==e?void 0:e[n]:i.ends[s]=null==e?void 0:e[n],(null==e?void 0:e[n])?e[n][s]=t[s]:i.ends[n]=t[s],this}remove(){return this.elements.remove(),this.each("postOrder","dispose"),this.disown()}fold(t,e){let s=t;return this.each((t=>{s=e(s,t)})),s}}class tt extends J{constructor(t,e,n=s){super(t,e,n);const i=document.createElement("span");i.classList.add("mq-selection"),this.elements.first.before(i),i.append(...this.elements.contents),this.elements=new Y(i)}adopt(t,e,s){const n=this.elements.children();return this.elements.first.replaceWith(...n.contents),this.elements=n,super.adopt(t,e,s)}clear(){return this.elements.first.replaceWith(...this.elements.first.childNodes),this}join(t){return this.fold("",((e,s)=>e+s[t]()))}}const et=t=>l(`"${t}" should be overridden or never called on this node`);class st{constructor(){this.elements=new Y,this.ends={},this.ctrlSeq="",this.bubble=r((t=>{for(let e=this;e&&!1!==t(e);e=e.parent);return this})),this.postOrder=r((t=>(function e(s){s.eachChild(e),t(s)}(this),this))),this.id=st.uniqueNodeId(),st.byId[this.id]=this}dispose(){delete st.byId[this.id]}toString(){return`{{ MathQuill TNode #${this.id} }}`}addToElements(t){this.elements.add(t)}domify(s){const n=s instanceof Y?s:new Y(this.html()),i=s=>{var n,r;if(s instanceof HTMLElement){const i=parseInt(null!==(n=s.getAttribute(t))&&void 0!==n?n:"0"),o=parseInt(null!==(r=s.getAttribute(e))&&void 0!==r?r:"0");i&&st.byId[i].addToElements(s),o&&st.byId[o].addToElements(s)}for(let t=s.firstChild;t;t=t.nextSibling)i(t)};return n.contents.forEach((t=>i(t))),n}createDir(t,e){return a(t),this.domify(),this.elements.insDirOf(t,e.element),e[t]=this.adopt(e.parent,e[s],e[n]),this}createLeftOf(t){this.createDir(s,t)}selectChildren(t,e){return new tt(t,e)}isEmpty(){return!this.ends[s]&&!this.ends[n]}isStyleBlock(){return!1}children(){return new J(this.ends[s],this.ends[n])}eachChild(t,e){return this.children().each(t,e),this}foldChildren(t,e){return this.children().fold(t,e)}withDirAdopt(t,e,s,n){return new J(this,this).withDirAdopt(t,e,s,n),this}adopt(t,e,s){return new J(this,this).adopt(t,e,s),this}disown(){return new J(this,this).disown(),this}remove(){return this.elements.remove(),this.postOrder("dispose"),this.disown()}keystroke(t,e,i){const r=i.cursor;switch(t){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":i.ctrlDeleteDir(s);break;case"Shift-Backspace":case"Backspace":i.backspace();break;case"Escape":case"Tab":return void i.escapeDir(n,t,e);case"Shift-Tab":case"Shift-Escape":return void i.escapeDir(s,t,e);case"End":i.notify("move").cursor.insAtRightEnd(r.parent);break;case"Ctrl-End":i.notify("move").cursor.insAtRightEnd(i.root);break;case"Shift-End":for(;r[n];)i.selectRight();break;case"Ctrl-Shift-End":for(;r[n]||r.parent!==i.root;)i.selectRight();break;case"Home":i.notify("move").cursor.insAtLeftEnd(r.parent);break;case"Ctrl-Home":i.notify("move").cursor.insAtLeftEnd(i.root);break;case"Shift-Home":for(;r[s];)i.selectLeft();break;case"Ctrl-Shift-Home":for(;r[s]||r.parent!==i.root;)i.selectLeft();break;case"Left":i.moveLeft();break;case"Shift-Left":i.selectLeft();break;case"Ctrl-Left":case"Ctrl-Right":case"Ctrl-Up":case"Ctrl-Down":break;case"Right":i.moveRight();break;case"Shift-Right":i.selectRight();break;case"Up":i.moveUp();break;case"Down":i.moveDown();break;case"Shift-Up":if(r[s])for(;r[s];)i.selectLeft();else i.selectLeft();break;case"Shift-Down":if(r[n])for(;r[n];)i.selectRight();else i.selectRight();break;case"Ctrl-Shift-Delete":case"Ctrl-Delete":i.ctrlDeleteDir(n);break;case"Shift-Delete":case"Delete":i.deleteForward();break;case"Meta-A":case"Ctrl-A":for(i.notify("move").cursor.insAtRightEnd(i.root);r[s];)i.selectLeft();break;default:return}e.preventDefault(),i.scrollHoriz()}html(){return""}text(){return""}latex(){return""}focus(){}blur(t){}seek(t,e){}writeLatex(t,e){}finalizeInsert(t,e){}write(t,e){}replaces(t){}setOptions(t){return this}chToCmd(t,e){return this}getController(){return function t(e){return e.controller?e.controller:e.parent?t(e.parent):void 0}(this)}moveOutOf(t,e,s){et("moveOutOf")}moveTowards(t,e,s){et("moveTowards")}deleteOutOf(t,e){et("deleteOutOf")}deleteTowards(t,e){et("deleteTowards")}unselectInto(t,e){et("unselectInto")}selectOutOf(t,e){et("selectOutOf")}selectTowards(t,e){et("selectTowards")}}st.id=0,st.byId={},st.uniqueNodeId=()=>++st.id;const nt=(()=>{const t={ArrowRight:"Right",ArrowLeft:"Left",ArrowDown:"Down",ArrowUp:"Up"," ":"Spacebar"};return(e,s)=>{let n=!1;const i=(t,e)=>{s.options.overrideKeystroke?s.options.overrideKeystroke(t,e):s.keystroke(t,e)};return e.addEventListener("keydown",(s=>{s.target===e&&(n="Unidentified"===s.key,i((e=>{var s;const n=1===(i=e.key).length&&i>="a"&&i<="z"?e.key.toUpperCase():null!==(s=t[e.key])&&void 0!==s?s:e.key;var i;const r=[];return e.ctrlKey&&r.push("Ctrl"),e.metaKey&&r.push("Meta"),e.altKey&&r.push("Alt"),e.shiftKey&&r.push("Shift"),r.length?("Alt"!==n&&"Control"!==n&&"Meta"!==n&&"Shift"!==n&&r.push(n),r.join("-")):n})(s),s))})),e.addEventListener("cut",(()=>{s.options.overrideCut?s.options.overrideCut():s.cut()})),e.addEventListener("copy",(()=>{s.options.overrideCopy?s.options.overrideCopy():s.copy()})),e.addEventListener("paste",(t=>{var n,i;if(t.target!==e)return;e.focus();const r=null!==(i=null===(n=t.clipboardData)||void 0===n?void 0:n.getData("text"))&&void 0!==i?i:"";e.value="",r&&(s.options.overridePaste?s.options.overridePaste(r):s.paste(r))})),e.addEventListener("input",(t=>{var r;if("insertFromPaste"===t.inputType)return;const o=null!==(r=t.data)&&void 0!==r?r:"";1===o.length?s.options.overrideTypedText?s.options.overrideTypedText(o):" "===o&&n&&s.options.spaceBehavesLikeTab&&s.cursor.depth()>1?(i("Spacebar",t),setTimeout((()=>e.value=""))):(s.typedText(o),setTimeout((()=>e.value=""))):e.value.length>1&&e.select()})),{select:t=>{e.value=t,t&&e instanceof HTMLTextAreaElement&&e.select()}}}})();class it{constructor(t,e,i){this.parent=t,this[s]=e,this[n]=i}static copy(t){return new it(t.parent,t[s],t[n])}}const rt=t=>{t.moveOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("moveOutOf",e)},t.deleteOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("deleteOutOf",e)},t.selectOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("selectOutOf",e)},t.upOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("upOutOf",e)},t.downOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("downOutOf",e)},t.reflow=()=>{var e,s,n;null===(e=t.controller)||void 0===e||e.handle("reflow"),null===(s=t.controller)||void 0===s||s.handle("edited"),null===(n=t.controller)||void 0===n||n.handle("edit")}},ot=t=>class extends t{moveTowards(t,e,i){const r=i&&this[`${i}Into`];e.insAtDirEnd(t===s?n:s,r||this.ends[t===s?n:s])}deleteTowards(t,e){this.isEmpty()?e[t]=this.remove()[t]:this.moveTowards(t,e)}selectTowards(t,e){e[t===s?n:s]=this,e[t]=this[t]}},lt=(t,e,s)=>t.forEach((t=>t.style.transform=`scale(${e},${s})`)),at=t=>class extends t{constructor(){super(...arguments),this.reflow=()=>{var t,e,s;const n=this.content?getComputedStyle(this.content):void 0,i=null===(t=this.content)||void 0===t?void 0:t.getBoundingClientRect(),r=(null!==(e=null==i?void 0:i.height)&&void 0!==e?e:0)/parseFloat(null!==(s=null==n?void 0:n.fontSize)&&void 0!==s?s:"1");lt(this.delims,Math.min(1+.2*(r-1),1.2),1.2*r)}}addToElements(t){super.addToElements(t);const e=this.elements.children();this.delims=[e.firstElement,e.lastElement],this.content=e.contents[1]}};class ct{constructor(t){this._=t}parse(t){return this.skip(ct.eof)._(`${t}`,((t,e)=>e),((t,e)=>{throw`Parse Error: ${e} at ${t||"EOF"}`}))}or(t){return l("or is passed a parser",t instanceof ct),new ct(((e,s,n)=>this._(e,s,(()=>t._(e,s,n)))))}then(t){return new ct(((e,s,n)=>this._(e,((e,i)=>{const r=t instanceof ct?t:"function"==typeof t?t(i):void 0;return l("a parser is returned",r instanceof ct),r._(e,s,n)}),n)))}many(){return new ct(((t,e)=>{const s=[];for(;this._(t,((e,n)=>(t=e,s.push(n),!0)),(()=>!1)););return e(t,s)}))}times(t,e=t){return new ct(((s,n,i)=>{const r=[];let o=!0;for(let n=0;n<e&&o;++n){let e;if(o=this._(s,((t,e)=>(r.push(e),s=t,!0)),((t,n)=>(e=n,s=t,!1))),n<t&&!o)return i(s,e)}return n(s,r)}))}result(t){return this.then(ct.succeed(t))}atMost(t){return this.times(0,t)}atLeast(t){return this.times(t).then((t=>this.many().map((e=>t.concat(e)))))}map(t){return this.then((e=>"function"==typeof t&&/^\s*class\s+/.test(t.toString())?ct.succeed(new t(e)):"function"==typeof t?ct.succeed(t(e)):ct.fail("Invalid map function")))}skip(t){return this.then((e=>t.result(e)))}static string(t){return new ct(((e,s,n)=>{const i=e.slice(0,t.length);return i===t?s(e.slice(t.length),i):n(e,`expected '${t}'`)}))}static regex(t){return l("regexp parser is anchored","^"===t.toString().charAt(1)),new ct(((e,s,n)=>{const i=t.exec(e);return i?s(e.slice(i[0].length),i[0]):n(e,`expected ${t.toString()}`)}))}static succeed(t){return new ct(((e,s)=>s(e,t)))}static fail(t){return new ct(((e,s,n)=>n(e,t)))}}ct.letter=ct.regex(/^[a-z]/i),ct.letters=ct.regex(/^[a-z]*/i),ct.digit=ct.regex(/^[0-9]/),ct.digits=ct.regex(/^[0-9]*/),ct.whitespace=ct.regex(/^\s+/),ct.optWhitespace=ct.regex(/^\s*/),ct.any=new ct(((t,e,s)=>t?e(t.slice(1),t.charAt(0)):s(t,"expected any character"))),ct.all=new ct(((t,e)=>e("",t))),ct.eof=new ct(((t,e,s)=>t?s(t,"expected EOF"):e(t,t)));const ht=t=>class extends t{focusBlurEvents(){var t,e,s;this.focusHandler=()=>{var t;this.blurred=!1,this.container.classList.add("mq-focused"),this.cursor.parent||this.cursor.insAtRightEnd(this.root),this.cursor.selection?(this.cursor.selection.elements.removeClass("mq-blur"),null===(t=this.selectionChanged)||void 0===t||t.call(this)):this.cursor.show()},null===(t=this.textarea)||void 0===t||t.addEventListener("focus",this.focusHandler),this.blurHandler=()=>{var t;this.blurred=!0,this.container.classList.remove("mq-focused"),null===(t=this.cursor.hide().parent)||void 0===t||t.blur(),this.cursor.selection&&this.cursor.selection.elements.addClass("mq-blur")},null===(e=this.textarea)||void 0===e||e.addEventListener("blur",this.blurHandler),this.blurred=!0,null===(s=this.cursor.hide().parent)||void 0===s||s.blur()}unbindFocusBlurEvents(){var t,e;this.focusHandler&&(null===(t=this.textarea)||void 0===t||t.removeEventListener("focus",this.focusHandler)),this.blurHandler&&(null===(e=this.textarea)||void 0===e||e.removeEventListener("blur",this.blurHandler)),delete this.focusHandler,delete this.blurHandler}},dt=t=>class extends t{focus(){this.elements.addClass("mq-has-cursor"),this.elements.removeClass("mq-empty")}blur(){this.elements.removeClass("mq-has-cursor"),this.isEmpty()&&this.elements.addClass("mq-empty")}};class ut extends st{finalizeInsert(t,e){var i,r,o,l;this.postOrder("finalizeTree",t),this.postOrder("contactWeld",e),this.postOrder("blur"),this.postOrder("reflow"),null===(r=null===(i=this[n])||void 0===i?void 0:i.siblingCreated)||void 0===r||r.call(i,t,s),null===(l=null===(o=this[s])||void 0===o?void 0:o.siblingCreated)||void 0===l||l.call(o,t,n),this.bubble("reflow")}prepareInsertionAt(t){const e=t.options.maxDepth;if(void 0!==e){const s=t.depth();if(s>e)return!1;this.removeNodesDeeperThan(e-s)}return!0}removeNodesDeeperThan(t){var e;let s=0;const n=[[this,s]];for(;n.length;){const i=n.shift();null===(e=null==i?void 0:i[0].children())||void 0===e||e.each((e=>{const r=e instanceof Dt?1:0;s=i[1]+r,s<=t?n.push([e,s]):(r?e.children():e).remove()}))}}}class pt extends(ot(ut)){constructor(t,e,s){super(),this.contentIndex=0,this.blocks=[],this.ctrlSeq=null!=t?t:"",this.htmlTemplate=null!=e?e:"",this.textTemplate=null!=s?s:[""]}replaces(t){null==t||t.disown(),this.replacedFragment=t}isEmpty(){return this.foldChildren(!0,((t,e)=>t&&e.isEmpty()))}parser(){return Tt.block.times(this.numBlocks()).map((t=>{this.blocks=t;for(const e of t)e.adopt(this,this.ends[n]);return this}))}createLeftOf(t){var e;const s=this.replacedFragment;this.createBlocks(),super.createLeftOf(t),s&&(s.adopt(this.blocks[this.contentIndex]),null===(e=this.blocks[this.contentIndex])||void 0===e||e.elements.firstElement.append(...s.elements.contents),this.placeCursor(t),this.prepareInsertionAt(t)),this.finalizeInsert(t.options),this.placeCursor(t)}createBlocks(){const t=this.numBlocks();this.blocks=Array(t);for(let e=0;e<t;++e)this.blocks[e]=new Dt,this.blocks[e].adopt(this,this.ends[n])}placeCursor(t){t.insAtRightEnd(this.foldChildren(this.ends[s],((t,e)=>t.isEmpty()?t:e)))}selectChildren(){return new tt(this,this)}unselectInto(t,e){var i,r;e.insAtDirEnd(t===s?n:s,null===(r=null===(i=e.anticursor)||void 0===i?void 0:i.ancestors)||void 0===r?void 0:r[this.id])}seek(t,e){const i=t=>{const e=t.elements.firstElement.getBoundingClientRect();return{[s]:e.left,[n]:e.left+e.width}},r=i(this);if(t<r[s])return void e.insLeftOf(this);if(t>r[n])return void e.insRightOf(this);let o=r[s];this.eachChild((l=>{const a=i(l);return t<a[s]?(t-o<a[s]-t?l[s]?e.insAtRightEnd(l[s]):e.insLeftOf(this):e.insAtLeftEnd(l),!1):t>a[n]?void(l[n]?o=a[n]:r[n]-t<t-a[n]?e.insRightOf(this):e.insAtRightEnd(l)):(l.seek(t,e),!1)}))}numBlocks(){const t=this.htmlTemplate.match(/&\d+/g);return t?t.length:0}html(){const s=this.blocks,n=` ${t}=${this.id}`,i=this.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);l("no unmatched angle brackets",i.join("")===this.htmlTemplate);for(let t=0,e=i[0];e;++t,e=i[t])if("/>"===e.slice(-2))i[t]=`${e.slice(0,-2)}${n}/>`;else if("<"===e.charAt(0)){l("not an unmatched top-level close tag","/"!==e.charAt(1)),i[t]=`${e.slice(0,-1)}${n}>`;let s=1;do{t+=1,e=i[t],l("no missing close tags",!!e),"</"===e.slice(0,2)?s-=1:"<"===e.charAt(0)&&"/>"!==e.slice(-2)&&(s+=1)}while(s>0)}return i.join("").replace(/>&(\d+)/g,((t,n)=>{var i,r,o,l;return` ${e}=${null!==(r=null===(i=s[n])||void 0===i?void 0:i.id)&&void 0!==r?r:""}>${null!==(l=null===(o=s[n])||void 0===o?void 0:o.join("html"))&&void 0!==l?l:""}`}))}latex(){return this.foldChildren(this.ctrlSeq,((t,e)=>`${t}{${e.latex()||" "}}`))}text(){let t=0;return this.foldChildren(this.textTemplate[t],((e,s)=>{++t;const n=s.text();return e&&"("===this.textTemplate[t]&&"("===n[0]&&")"===n.slice(-1)?e+n.slice(1,-1)+this.textTemplate[t]:e+n+(this.textTemplate[t]||"")}))}}class ft extends pt{constructor(t,e,s){const n=s||(t&&t.length>1?t.slice(1):null!=t?t:"");super(t,e,[n]),this.createBlocks=i,this.isSymbol=!0}parser(){return ct.succeed(this)}numBlocks(){return 0}replaces(t){null==t||t.remove()}moveTowards(t,e){t===s?this.elements.first.before(e.element):this.elements.last.after(e.element),e[t===s?n:s]=this,e[t]=this[t]}deleteTowards(t,e){e[t]=this.remove()[t]}seek(t,e){const s=this.elements.firstElement.getBoundingClientRect();t-s.left<s.width/2?e.insLeftOf(this):e.insRightOf(this)}latex(){return this.ctrlSeq}text(){return this.textTemplate.join("")}placeCursor(){}isEmpty(){return!0}}class mt extends ft{constructor(t,e,s){super(t,`<span>${e||t}</span>`,s)}}class vt extends ft{constructor(t,e,s,n=!1){super(t,!0===n?e:`<span class="mq-binary-operator">${null!=e?e:""}</span>`,s),this.isUnary=!1}}class gt extends vt{constructor(t,e){const s=e?"Strict":"";super(t[`ctrlSeq${s}`],t[`html${s}`],t[`text${s}`]),this.data=t,this.strict=e}swap(t){this.strict=t;const e=t?"Strict":"";this.ctrlSeq=this.data[`ctrlSeq${e}`],this.elements.html(this.data[`html${e}`]),this.textTemplate=[this.data[`text${e}`]]}deleteTowards(t,e){if(t===s&&!this.strict)return this.swap(!0),void this.bubble("reflow");super.deleteTowards(t,e)}}class bt extends vt{constructor(){super("=","=")}createLeftOf(t){var e;if(t[s]instanceof gt&&t[s].strict)return t[s].swap(!1),void(null===(e=t[s])||void 0===e||e.bubble("reflow"));super.createLeftOf(t)}}class wt extends mt{createLeftOf(t){var e,n,i,r,o;t.options.autoSubscriptNumerals&&t.parent!==(null===(n=null===(e=t.parent)||void 0===e?void 0:e.parent)||void 0===n?void 0:n.sub)&&(t[s]instanceof xt&&!1!==t[s].isItalic||t[s]instanceof yt&&(null===(i=t[s])||void 0===i?void 0:i[s])instanceof xt&&!1!==(null===(r=t[s])||void 0===r?void 0:r[s].isItalic))?((new h._).createLeftOf(t),super.createLeftOf(t),t.insRightOf(null===(o=t.parent)||void 0===o?void 0:o.parent)):super.createLeftOf(t)}}class xt extends ft{constructor(t,e){super(t,`<var>${e||t}</var>`),this.isItalic=!1,this.isPartOfOperator=!1}text(){let t=this.ctrlSeq;return"\\"==t[0]?t=t.startsWith("\\operatorname{")?t.slice(14,t.length):t.slice(1,t.length):" "!=t[t.length-1]&&"}"!=t[t.length-1]||(t=t.slice(0,-1),this[n]instanceof _t||this[n]instanceof kt||this[n]instanceof yt||(t+=" ")),t}}class qt extends xt{constructor(t,e){super(t,e),this.letter=t,this.siblingDeleted=this.siblingCreated=(t,e)=>this.finalizeTree(t,e)}createLeftOf(t){super.createLeftOf(t);const e=t.options.autoCommands,n=e._maxLength;if(n>0){let i="",r=this,o=0;for(;r instanceof qt&&(null==r?void 0:r.ctrlSeq)===(null==r?void 0:r.letter)&&o<n;)i=r.letter+i,r=r[s],++o;for(;i.length;){if(e[i]){for(o=1,r=this;o<i.length;++o,r=null==r?void 0:r[s]);return new J(r,this).remove(),t[s]=null==r?void 0:r[s],new h[i](i).createLeftOf(t)}i=i.slice(1)}}}italicize(t){return this.isItalic=t,this.isPartOfOperator=!t,this.elements.toggleClass("mq-operator-name",!t),this}finalizeTree(t,e){e!==s&&this[n]instanceof qt||this.autoUnItalicize(t)}autoUnItalicize(t){var e,i,r,o,l,a,c;const h=t.autoOperatorNames;if(0===h._maxLength)return;let d=this.letter,u=this[s],p=this[n];for(;u instanceof qt;u=u[s])d=u.letter+d;for(;p instanceof qt;p=p[n])d+=p.letter;new J((null==u?void 0:u[n])||(null===(e=this.parent)||void 0===e?void 0:e.ends[s]),(null==p?void 0:p[s])||(null===(i=this.parent)||void 0===i?void 0:i.ends[n])).each((t=>{t.italicize(!0).elements.removeClass("mq-first","mq-last","mq-followed-by-supsub"),t.ctrlSeq=t.letter}));for(let e=0,i=(null==u?void 0:u[n])||(null===(r=this.parent)||void 0===r?void 0:r.ends[s]);e<d.length;++e,i=null==i?void 0:i[n])for(let r=Math.min(h._maxLength,d.length-e);r>0;--r){const u=d.slice(e,e+r);if(h[u]){let h;for(let t=0,e=i;t<r;t+=1,e=null==e?void 0:e[n])e.italicize(!1),h=e;const d=f[u];if(i.ctrlSeq=(d?"\\":"\\operatorname{")+(null!==(o=null==i?void 0:i.ctrlSeq)&&void 0!==o?o:""),h.ctrlSeq+=d?" ":"}",u in m&&(null===(c=null===(a=null===(l=null==h?void 0:h[s])||void 0===l?void 0:l[s])||void 0===a?void 0:a[s])||void 0===c||c.elements.addClass("mq-last")),this.shouldOmitPadding(null==i?void 0:i[s])||null==i||i.elements.addClass("mq-first"),!this.shouldOmitPadding(null==h?void 0:h[n]))if((null==h?void 0:h[n])instanceof yt){const e=h[n];e.siblingCreated=e.siblingDeleted=()=>{e.elements.toggleClass("mq-after-operator-name",!(e[n]instanceof _t))},e.siblingCreated(t)}else null==h||h.elements.toggleClass("mq-last",!((null==h?void 0:h[n])instanceof _t));e+=r-1,i=h;break}}}shouldOmitPadding(t){return!t||t instanceof vt||t instanceof St}}function Ot(t){var e;const s=this.parent;let i=t;do{if(null==i?void 0:i[n])return t.insLeftOf(s);i=null===(e=null==i?void 0:i.parent)||void 0===e?void 0:e.parent}while(i!==s);t.insRightOf(s)}class kt extends pt{constructor(){super(),this.ctrlSeq="\\frac",this.htmlTemplate='<span class="mq-fraction mq-non-leaf"><span class="mq-numerator">&0</span><span class="mq-denominator">&1</span><span style="display:inline-block;width:0">&#8203;</span></span>',this.textTemplate=["((",")/(","))"]}text(){var t;let e=this[s];for(;e&&"\\ "===e.ctrlSeq;e=e[s]);const i=t=>{var e,n,i;let r=!1,o=0,l=!1;null===(e=this.ends[t])||void 0===e||e.eachChild((t=>(t instanceof wt&&(l=!0),t instanceof wt||t instanceof vt&&t.isUnary||t instanceof yt||++o,(l&&o||o>1||t instanceof vt&&!t.isUnary||"text"in h&&t instanceof h.text||t instanceof St||t instanceof kt||"\\ "===t.ctrlSeq||/^[,;:]$/.test(t.ctrlSeq))&&(r=!0),!r)));const a=t===s?0:1,c=" "!==(null===(n=this.ends[t])||void 0===n?void 0:n.text())&&(null===(i=this.ends[t])||void 0===i?void 0:i.text());return c?r?`(${c})`:c:a};return e instanceof vt&&e.isUnary||(null==e?void 0:e.elements.hasClass("mq-operator-name"))||e instanceof yt&&(null===(t=e[s])||void 0===t?void 0:t.elements.hasClass("mq-operator-name"))?`(${i(s)}/${i(n)})`:` ${i(s)}/${i(n)} `}finalizeTree(){this.upInto=this.ends[n].upOutOf=this.ends[s],this.downInto=this.ends[s].downOutOf=this.ends[n]}}const Et=(t,e)=>{let s=!1,n=0,i=!1;null==e||e.eachChild((t=>(t instanceof wt&&(i=!0),t instanceof wt||t instanceof vt&&t.isUnary||++n,(i&&n||n>1||t instanceof vt&&!t.isUnary||"text"in h&&t instanceof h.text||t instanceof St||t instanceof kt||"\\ "===t.ctrlSeq||/^[,;:]$/.test(t.ctrlSeq))&&(s=!0),!s)));const r=" "!==(null==e?void 0:e.text())&&(null==e?void 0:e.text());return r?t+(s?`(${r})`:r):""};class yt extends pt{constructor(t,e,s){super("_{...}^{...}",e,s),this.supsub="sup",this.reflow=()=>{const t=this.elements,e=t.first.previousElementSibling;if(!e)return;const s=t.children(".mq-sup").firstElement;if(s){const t=getComputedStyle(s),n=s.getBoundingClientRect(),i=parseInt(t.fontSize),r=n.top+n.height-parseFloat(t.paddingTop)-parseFloat(t.paddingBottom)-e.getBoundingClientRect().top-.7*i,o=parseInt(t.marginBottom);s.style.marginBottom=`${o+r}px`}}}hasValidBase(t){var e,n,i,r;return!t.options.supSubsRequireOperand||t[s]&&"\\ "!==(null===(e=t[s])||void 0===e?void 0:e.ctrlSeq)&&!(t[s]instanceof vt)&&!/^[,;:]$/.test(null!==(i=null===(n=t[s])||void 0===n?void 0:n.ctrlSeq)&&void 0!==i?i:"")||!t[s]&&(null===(r=t.parent)||void 0===r?void 0:r.parent)instanceof Ct&&t.parent==t.parent.parent.blocks[0]}createLeftOf(t){if(this.hasValidBase(t)){if(t[s]instanceof kt){const e=new _t(n,"(",")","(",")");t.selection=t[s].selectChildren(),e.replaces(t.replaceSelection()),e.createLeftOf(t)}super.createLeftOf(t)}else this.replacedFragment&&(this.replacedFragment.adopt(t.parent,t[s],t[n]),t[s]=this.replacedFragment.ends[n])}contactWeld(t){var e,i,r;for(const e of[s,n])if(this[e]instanceof yt){let i;for(const t of["sub","sup"]){const r=this[t],o=this[e][t];if(r){if(o)if(r.isEmpty())i=new it(o,void 0,o.ends[s]);else{r.elements.children().insAtDirEnd(e===s?n:s,o.elements);const t=r.children().disown();i=new it(o,t.ends[n],o.ends[s]),e===s?t.adopt(o,o.ends[n]):t.adopt(o,void 0,o.ends[s])}else this[e].addBlock(r.disown());this.placeCursor=t=>t.insAtDirEnd(e===s?n:s,o||r)}}return this.remove(),void(t&&(t[s]===this?e===n&&i?i[s]?t.insRightOf(i[s]):t.insAtLeftEnd(i.parent):t.insRightOf(this[e]):(null==i?void 0:i[n])&&t.insRightOf(i[n])))}if(t&&t[n]===this&&(!this.hasValidBase(t)||t[s]instanceof kt)){for(const r of["sub","sup"]){const o=this[r];o&&(o.children().disown().adopt(t.parent,t[s],t[n]).elements.insDirOf(n,t.element),(null===(e=t[s])||void 0===e?void 0:e[n])?t.insLeftOf(null===(i=t[s])||void 0===i?void 0:i[n]):t.insAtDirEnd(s,t.parent))}this.remove()}if((null===(r=this.parent)||void 0===r?void 0:r.parent)instanceof Ct&&this.parent==this.parent.parent.blocks[0]&&(!this.sup||!this.sub)){const t=this.parent.parent.blocks[0];for(const e of["sub","sup"]){const s=this[e];s&&(s.deleteOutOf=(e,n)=>{s.isEmpty()&&this.remove(),n.insAtDirEnd(e,t)})}}}finalizeTree(){this.ends[s].isSupSubLeft=!0}moveTowards(t,e,s){e.options.autoSubscriptNumerals&&!this.sup?e.insDirOf(t,this):super.moveTowards(t,e,s)}deleteTowards(t,e){if(e.options.autoSubscriptNumerals&&this.sub){const i=this.sub.ends[t===s?n:s];i instanceof ft?i.remove():i&&i.deleteTowards(t,e.insAtDirEnd(t===s?n:s,this.sub)),this.sub.isEmpty()&&(this.sub.deleteOutOf(s,e.insAtLeftEnd(this.sub)),this.sup&&e.insDirOf(t===s?n:s,this))}else super.deleteTowards(t,e)}latex(){const t=(t,e)=>{const s=e&&e.latex();return e?t+(1===(null==s?void 0:s.length)?s:`{${s||" "}}`):""};return t("_",this.sub)+t("^",this.sup)}text(){const t=Et("_",this.sub)+Et("^",this.sup);return t+(t&&this[n]instanceof wt?" ":"")}addBlock(t){var i;if("sub"===this.supsub){this.sup=this.upInto=this.sub.upOutOf=t,t.adopt(this,this.sub).downOutOf=this.sub;const s=document.createElement("span");s.classList.add("mq-sup"),s.append(...t.elements.children().contents),s.setAttribute(e,t.id.toString()),this.elements.firstElement.prepend(s),t.elements=new Y(s)}else{this.sub=this.downInto=this.sup.downOutOf=t,t.adopt(this,void 0,this.sup).upOutOf=this.sup;const s=document.createElement("span");s.classList.add("mq-sub"),s.append(...t.elements.children().contents),s.setAttribute(e,t.id.toString()),this.elements.removeClass("mq-sup-only"),this.elements.firstElement.append(s),t.elements=new Y(s);const n=document.createElement("span");n.style.display="inline-block",n.style.width="0",n.textContent="​",this.elements.firstElement.append(n)}for(const t of["sub","sup"]){const e="sub"===t?"sup":"sub",r="sub"===t?"down":"up",o=this[t];(null===(i=this.parent)||void 0===i?void 0:i.parent)instanceof Ct&&this.parent===this.parent.parent.blocks[0]?o.deleteOutOf=(i,l)=>{var a;if(o.isEmpty()){l[i===s?n:s]=o.ends[i],this.supsub=e,delete this[t],delete this[`${r}Into`];const c=this[e];c[`${r}OutOf`]=Ot,c.deleteOutOf=(t,e)=>{c.isEmpty()&&this.remove(),e.insAtDirEnd(t,this.parent)},"sub"===t&&(this.elements.addClass("mq-sup-only"),null===(a=this.elements.first.lastChild)||void 0===a||a.remove()),o.remove()}l.insDirOf(o[i]?i===s?n:s:i,o.parent)}:o.deleteOutOf=(i,l)=>{var a;if(l.insDirOf(o[i]?i===s?n:s:i,o.parent),!o.isEmpty()){const t=o.ends[i];o.children().disown().withDirAdopt(i,l.parent,l[i],l[i===s?n:s]).elements.insDirOf(i===s?n:s,l.element),l[i===s?n:s]=t}this.supsub=e,delete this[t],delete this[`${r}Into`],this[e][`${r}OutOf`]=Ot,delete this[e].deleteOutOf,"sub"===t&&(this.elements.addClass("mq-sup-only"),null===(a=this.elements.first.lastChild)||void 0===a||a.remove()),o.remove()}}}}class St extends pt{latex(){var t,e,i,r;const o=t=>1===t.length?t:`{${t||" "}}`;return`${this.ctrlSeq}_${o(null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.latex())&&void 0!==e?e:"")}^${o(null!==(r=null===(i=this.ends[n])||void 0===i?void 0:i.latex())&&void 0!==r?r:"")}`}text(){var t,e,i,r;return`${this.ctrlSeq.slice(1,this.ctrlSeq.length-1)}(${null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.text())&&void 0!==e?e:""},${null!==(r=null===(i=this.ends[n])||void 0===i?void 0:i.text())&&void 0!==r?r:""})`}parser(){const t=this.blocks=[new Dt,new Dt];for(const e of t)e.adopt(this,this.ends[n]);return ct.optWhitespace.then(ct.string("_").or(ct.string("^"))).then((e=>{const s=t["_"===e?0:1];return Tt.block.then((t=>(t.children().adopt(s,s.ends[n]),ct.succeed(this))))})).many().result(this)}finalizeTree(){this.downInto=this.ends[s],this.upInto=this.ends[n],this.ends[s].upOutOf=this.ends[n],this.ends[n].downOutOf=this.ends[s]}}const Lt=t=>class extends(at(t)){constructor(){super(...arguments),this.side=s,this.sides={[s]:{ch:"(",ctrlSeq:"("},[n]:{ch:")",ctrlSeq:")"}},this.inserted=!1}matchBrack(t,e,i){var r;return(i instanceof _t&&(!(this instanceof Ct)||")"===(null===(r=i.sides[i.side])||void 0===r?void 0:r.ch))||i instanceof Ct&&")"===this.sides[this.side].ch)&&!!i.side&&i.side!==(e===s?n:e===n?s:0)&&(!t.restrictMismatchedBrackets||u[this.sides[this.side].ch]===i.sides[i.side].ch||{"(":"]","[":")"}[this.sides[s].ch]===i.sides[n].ch)&&i}closeOpposing(t){var e;t.side=0,t.sides[this.side]=this.sides[this.side];const n=null===(e=t.delims)||void 0===e?void 0:e[this.side===s?0:1];n&&(n.classList.remove("mq-ghost"),n.innerHTML=this.sides[this.side].ch)}createLeftOf(t){var e,i,r,o,l,a,c,h,d,u;let p,f;if(!this.replacedFragment){const r=t.options;if("|"===this.sides[s].ch)p=this.matchBrack(r,n,t[n])||this.matchBrack(r,s,t[s])||this.matchBrack(r,void 0,null===(e=t.parent)||void 0===e?void 0:e.parent);else{const e=this.side===s?n:s;p=this.matchBrack(r,e,t[e])||this.matchBrack(r,e,null===(i=t.parent)||void 0===i?void 0:i.parent)}}if(p){if(f=this.side=p.side===s?n:s,p===(null===(r=t.parent)||void 0===r?void 0:r.parent)&&t[f]&&new J(t[f],null===(o=t.parent)||void 0===o?void 0:o.ends[f],f===s?n:s).disown().withDirAdopt(f===s?n:s,p.parent,p,p[f]).elements.insDirOf(f,p.elements),this instanceof Ct&&f===s){const e=p===(null===(l=t.parent)||void 0===l?void 0:l.parent)&&t[n]!==(null===(a=p.ends[n])||void 0===a?void 0:a[n])?new J(t[n],null===(c=p.ends[n])||void 0===c?void 0:c.ends[n],s).disown():void 0;return t.insRightOf(p),this.side=0,e&&this.replaces(e),super.createLeftOf(t),p.remove(),void this.bubble("reflow")}this.closeOpposing(p),p.bubble("reflow")}else{if(this instanceof Ct&&!this.replacedFragment&&t[n]instanceof _t&&"("===t[n].sides[s].ch&&")"===t[n].sides[n].ch){const e=t[n];return this.side=e.side,this.replaces(new J(null===(h=e.ends[s])||void 0===h?void 0:h.ends[s],null===(d=e.ends[n])||void 0===d?void 0:d.ends[n],s)),super.createLeftOf(t),e.remove(),void this.bubble("reflow")}p=this,f=p.side,p.replacedFragment?p.side=0:t[f===s?n:s]&&(p.replaces(new J(t[f===s?n:s],null===(u=t.parent)||void 0===u?void 0:u.ends[f===s?n:s],f)),delete t[f===s?n:s]),super.createLeftOf(t)}f===s?t.insAtLeftEnd(p.ends[s]):t.insRightOf(p)}unwrap(){const t=this.blocks[this.contentIndex].children().disown().adopt(this.parent,this,this[n]);t&&this.elements.last.after(...t.elements.contents),this.remove()}deleteSide(t,e,i){var r,o,l,a,c,h;const d=this.parent,p=this[t],f=d.ends[t];if(t===this.side)return this.unwrap(),void(p?i.insDirOf(t===s?n:s,p):i.insAtDirEnd(t,d));const m=!this.side;if(this.side=t===s?n:s,this.matchBrack(i.options,t,this.blocks[this.contentIndex].ends[this.side])){this.closeOpposing(this.blocks[this.contentIndex].ends[this.side]);const e=this.blocks[this.contentIndex].ends[t];this.unwrap(),null===(r=null==e?void 0:e.siblingCreated)||void 0===r||r.call(e,i.options,t),p?i.insDirOf(t===s?n:s,p):i.insAtDirEnd(t,d)}else{if(this.matchBrack(i.options,t,null===(o=this.parent)||void 0===o?void 0:o.parent))(null===(l=this.parent)||void 0===l?void 0:l.parent).closeOpposing(this),(null===(a=this.parent)||void 0===a?void 0:a.parent).unwrap();else{if(e&&m)return this.unwrap(),void(p?i.insDirOf(t===s?n:s,p):i.insAtDirEnd(t,d));this.sides[t]={ch:u[this.sides[this.side].ch],ctrlSeq:u[this.sides[this.side].ctrlSeq]},null===(c=this.delims)||void 0===c||c.forEach(((e,n)=>{e.classList.remove("mq-ghost"),n===(t===s?0:1)&&(e.classList.add("mq-ghost"),e.innerHTML=this.sides[t].ch)}))}if(p){const e=this.blocks[this.contentIndex].ends[t];this.blocks[this.contentIndex].elements.removeClass("mq-empty"),new J(p,f,t===s?n:s).disown().withDirAdopt(t===s?n:s,this.blocks[this.contentIndex],e).elements.insAtDirEnd(t,this.blocks[this.contentIndex].elements),null===(h=null==e?void 0:e.siblingCreated)||void 0===h||h.call(e,i.options,t),i.insDirOf(t===s?n:s,p)}else e?i.insDirOf(t,this):i.insAtDirEnd(t,this.blocks[this.contentIndex])}}deleteTowards(t,e){this.deleteSide(t===s?n:s,!1,e)}finalizeTree(){var t;if(!this.inserted)return this.blocks[this.contentIndex].deleteOutOf=(t,e)=>this.deleteSide(t,!0,e),void(this.inserted=!0);null===(t=this.delims)||void 0===t||t[this.side===s?1:0].classList.remove("mq-ghost"),this.side=0}};class _t extends(Lt(pt)){constructor(t,e,r,o,l){super(`\\left${o}`,void 0,[e,r]),this.side=t,this.sides={[s]:{ch:e,ctrlSeq:o},[n]:{ch:r,ctrlSeq:l}},this.placeCursor=i,this.siblingCreated=(t,e)=>{e===(this.side===s?n:s)&&this.finalizeTree()}}numBlocks(){return 1}html(){return this.htmlTemplate=`<span class="mq-non-leaf"><span class="mq-scaled mq-paren${this.side===n?" mq-ghost":""}">`+this.sides[s].ch+'</span><span class="mq-non-leaf">&0</span>'+`<span class="mq-scaled mq-paren${this.side===s?" mq-ghost":""}">`+this.sides[n].ch+"</span></span>",super.html()}latex(){var t,e,i,r,o,l;return`\\left${null!==(e=null===(t=this.sides[s])||void 0===t?void 0:t.ctrlSeq)&&void 0!==e?e:""}${null!==(r=null===(i=this.ends[s])||void 0===i?void 0:i.latex())&&void 0!==r?r:""}\\right${null!==(l=null===(o=this.sides[n])||void 0===o?void 0:o.ctrlSeq)&&void 0!==l?l:""}`}text(){var t,e,i,r,o,l;return`${null!==(e=null===(t=this.sides[s])||void 0===t?void 0:t.ch)&&void 0!==e?e:""}${null!==(r=null===(i=this.ends[s])||void 0===i?void 0:i.text())&&void 0!==r?r:""}${null!==(l=null===(o=this.sides[n])||void 0===o?void 0:o.ch)&&void 0!==l?l:""}`}}class Ct extends(Lt(pt)){constructor(t){super(t,void 0,[`${t.slice(1)}(`,")"]),this.contentIndex=1,this.siblingCreated=(t,e)=>{e===n?this.finalizeTree():this.updateFirst()},this.siblingDeleted=()=>this.updateFirst()}updateFirst(){!this[s]||this[s]instanceof vt||this[s]instanceof xt&&this[s].isPartOfOperator?this.elements.first.classList.remove("mq-first"):this.elements.first.classList.add("mq-first")}addToElements(t){this.elements.add(t);const e=new Y(this.elements.children().last).children();this.delims=[e.contents[0],e.contents[2]],this.content=e.contents[1]}numBlocks(){return 2}html(){return this.htmlTemplate=`<span class="mq-non-leaf mq-math-function"><span class="mq-non-leaf mq-function-name">${this.ctrlSeq.slice(1)}</span><span class="mq-non-leaf mq-function-supsub">&0</span><span class="mq-non-leaf mq-function-params"><span class="mq-scaled mq-paren">(</span><span class="mq-non-leaf">&1</span><span class="mq-scaled mq-paren${this.side===s?" mq-ghost":""}">)</span></span></span>`,this.blocks[0].writeHandler=(t,e)=>{var n;return"_"!==e&&"^"!==e&&(!t[s]&&(null===(n=h[`${this.ctrlSeq.slice(1)}${e}`])||void 0===n?void 0:n.prototype)instanceof Ct?(this.ctrlSeq=`${this.ctrlSeq}${e}`,this.elements.children().first.textContent+=e,this.bubble("reflow"),!0):(this.enterContentBlock(s,t),"("===e))},super.html()}enterContentBlock(t,e){t===s?e.insAtLeftEnd(this.blocks[1]):e.insAtRightEnd(this.blocks[1])}deleteSide(t,e,i){var r;if(t!==s||this.blocks[0].isEmpty()&&this.blocks[1].isEmpty())super.deleteSide(t,e,i);else{let t,e;if(this.blocks[1].isEmpty()||(i.insLeftOf(this),t=new _t(s,"(",")","(",")"),t.replaces(this.blocks[1].children()),t.createLeftOf(i),this.side&&(null===(r=t.delims)||void 0===r||r[n].classList.add("mq-ghost"),t.side=s)),!this.blocks[0].isEmpty()&&this.blocks[0].ends[s]instanceof yt){i.insLeftOf(null!=t?t:this);const n=new xt("x");n.createLeftOf(i);const r=this.blocks[0].ends[s];for(const t of["sub","sup"]){const s=r[t];if(s){e&&i.insRightOf(e);const n=new h["sub"===t?"subscript":"superscript"];n.replaces(s.children()),n.createLeftOf(i),e||(e=n)}}n.remove()}this.remove(),e?i.insLeftOf(e):t&&i.insLeftOf(t)}}finalizeTree(){const t=this.inserted;super.finalizeTree(),t||(this.blocks[0].deleteOutOf=(t,e)=>{var n;if(!e[s]&&(null===(n=h[this.ctrlSeq.slice(1,-1)])||void 0===n?void 0:n.prototype)instanceof Ct)return this.ctrlSeq=this.ctrlSeq.slice(0,-1),this.elements.children().first.textContent=this.ctrlSeq.slice(1),void this.bubble("reflow");t===s?this.deleteSide(t,!0,e):this.enterContentBlock(s,e)},this.blocks[1].deleteOutOf=(t,e)=>{t===s?null==e||e.insAtRightEnd(this.blocks[0]):this.deleteSide(t,!0,e)}),this.updateFirst()}latex(){var t,e,s,n;return`${this.ctrlSeq}${null!==(e=null===(t=this.blocks[0])||void 0===t?void 0:t.latex())&&void 0!==e?e:""}\\left(${null!==(n=null===(s=this.blocks[1])||void 0===s?void 0:s.latex())&&void 0!==n?n:""}\\right)`}text(){var t,e,s,n;return`${this.ctrlSeq.slice(1)}${null!==(e=null===(t=this.blocks[0])||void 0===t?void 0:t.text())&&void 0!==e?e:""}(${null!==(n=null===(s=this.blocks[1])||void 0===s?void 0:s.text())&&void 0!==n?n:""})`}parser(){this.side=0,this.blocks=[new Dt,new Dt];for(const t of this.blocks)t.adopt(this,this.ends[n]);return ct.optWhitespace.then(ct.regex(/^(?=[_^])/)).then(Tt.block.map((t=>{t.children().adopt(this.blocks[0],this.blocks[0].ends[n])}))).many().or(ct.succeed(this)).then(ct.optWhitespace).then(ct.regex(/^(?=\))|^(?=\\right\))/).or(ct.string("\\left(").then(Tt.block.many().map((t=>{for(const e of t)e.children().adopt(this.blocks[1],this.blocks[1].ends[n])})).then(ct.optWhitespace).skip(ct.string("\\right)"))).or(ct.string("(").then(Tt.block.many().map((t=>{")"===t[t.length-1].text()&&t.splice(-1);for(const e of t)e.children().adopt(this.blocks[1],this.blocks[1].ends[n])})).then(ct.optWhitespace).skip(ct.string(")").or(ct.succeed(this)))).or(ct.regex(/^\d+\.?\d*|^\d*\.?\d+/).map((t=>{for(const e of t){("."===e?new mt("."):new wt(e)).adopt(this.blocks[1],this.blocks[1].ends[n])}})).or(Tt.block.map((t=>{t.children().adopt(this.blocks[1],this.blocks[1].ends[n])}))))).or(ct.succeed(this)))).result(this)}}const Tt=(()=>{const t=t=>{const e=t[0]||new Dt;for(const s of t.slice(1))s.children().adopt(e,e.ends[n]);return e},e=ct.letter.map((t=>new qt(t))),s=ct.regex(/^\d/).map((t=>new wt(t))),i=ct.regex(/^[^${}\\_^]/).map((t=>new mt(t))),r=ct.regex(/^[^\\a-eg-zA-Z]/).or(ct.string("\\").then(ct.regex(/^[a-z]+/i).or(ct.regex(/^\s+/).result(" ")).or(ct.any))).then((t=>{const e=h[t];return e?new e(t).parser():ct.fail(`unknown command: \\${t}`)})).or(e).or(s).or(i),o=ct.string("{").then((()=>a)).skip(ct.string("}")),l=ct.optWhitespace.then(o.or(r.map((t=>{const e=new Dt;return t.adopt(e),e})))),a=l.many().map(t).skip(ct.optWhitespace),c=ct.string("[").then(l.then((t=>"]"!==t.join("latex")?ct.succeed(t):ct.fail())).many().map(t).skip(ct.optWhitespace)).skip(ct.string("]")),d=a;return d.block=l,d.optBlock=c,d})(),$t=t=>class extends t{chToCmd(t,e){const s=d[t]||h[t];return t.match(/^[a-eg-zA-Z]$/)?new qt(t):/^\d$/.test(t)?new wt(t):e&&e.typingSlashWritesDivisionSymbol&&"/"===t?new h["÷"](t):e&&e.typingAsteriskWritesTimesSymbol&&"*"===t?new h["×"](t):s?new s(t):new mt(t)}write(t,e){var i,r;if(null===(i=this.writeHandler)||void 0===i?void 0:i.call(this,t,e))return;if(this.isSupSubLeft){if(t.options.autoSubscriptNumerals&&this===(null===(r=this.parent)||void 0===r?void 0:r.sub)){if("_"===e)return;const s=this.chToCmd(e,t.options);return s.isSymbol?t.deleteSelection():t.clearSelection().insRightOf(this.parent),void s.createLeftOf(t.show())}t[s]&&!t[n]&&!t.selection&&t.options.charsThatBreakOutOfSupSub.indexOf(e)>-1&&t.insRightOf(this.parent)}const o=this.chToCmd(e,t.options);t.selection&&o.replaces(t.replaceSelection()),t.isTooDeep()||o.createLeftOf(t.show())}};class Dt extends(dt($t(ut))){join(t){return this.foldChildren("",((e,s)=>e+s[t]()))}html(){return this.join("html")}latex(){return this.join("latex")}text(){var t,e;return this.ends[s]&&this.ends[s]===this.ends[n]?null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.text())&&void 0!==e?e:"":this.join("text")}keystroke(t,e,i){return i.options.spaceBehavesLikeTab&&i.cursor.depth()>1&&("Spacebar"===t||"Shift-Spacebar"===t)?(e.preventDefault(),void i.escapeDir("Shift-Spacebar"===t?s:n,t,e)):super.keystroke(t,e,i)}moveOutOf(t,e,i){var r;!(i&&(null===(r=this.parent)||void 0===r?void 0:r[`${i}Into`]))&&this[t]?e.insAtDirEnd(t===s?n:s,this[t]):e.insDirOf(t,this.parent)}selectOutOf(t,e){e.insDirOf(t,this.parent)}deleteOutOf(t,e){e.unwrapGramp()}seek(t,e){var i,r,o,l,a,c;let h=this.ends[n];const d=null!==(i=null==h?void 0:h.elements.firstElement.getBoundingClientRect())&&void 0!==i?i:void 0;if(!h||(null!==(r=null==d?void 0:d.left)&&void 0!==r?r:0)+(null!==(o=null==d?void 0:d.width)&&void 0!==o?o:0)<t)e.insAtRightEnd(this);else if(t<(null!==(a=null===(l=this.ends[s])||void 0===l?void 0:l.elements.firstElement.getBoundingClientRect().left)&&void 0!==a?a:0))e.insAtLeftEnd(this);else{for(;t<(null!==(c=null==h?void 0:h.elements.firstElement.getBoundingClientRect().left)&&void 0!==c?c:0);)h=null==h?void 0:h[s];null==h||h.seek(t,e)}}writeLatex(t,e){var i,r,o,l,a,c,h;const d=ct.all,u=ct.eof,p=Tt.skip(u).or(d.result(!1)).parse(e);if(p&&!p.isEmpty()&&p.prepareInsertionAt(t)){p.children().adopt(t.parent,t[s],t[n]);const e=p.domify();t.element.before(...e.contents),t[s]=p.ends[n],p.finalizeInsert(t.options,t),null===(o=null===(r=null===(i=p.ends[n])||void 0===i?void 0:i[n])||void 0===r?void 0:r.siblingCreated)||void 0===o||o.call(r,t.options,s),null===(c=null===(a=null===(l=p.ends[s])||void 0===l?void 0:l[s])||void 0===a?void 0:a.siblingCreated)||void 0===c||c.call(a,t.options,n),null===(h=t.parent)||void 0===h||h.bubble("reflow")}}focus(){return super.focus(),this}blur(){return super.blur(),this}}class At extends Dt{constructor(){super(),rt(this)}}class It extends($t(pt)){constructor(t){super("$"),this.cursor=t,this.htmlTemplate='<span class="mq-math-mode">&0</span>'}createBlocks(){super.createBlocks();const t=this.ends[s];t.write=(e,i)=>{var r;"$"!==i?this.write(e,i):t.isEmpty()?(e.insRightOf(t.parent),null===(r=t.parent)||void 0===r||r.deleteTowards(s,e),new mt("\\$","$").createLeftOf(e.show())):e[n]?e[s]?this.write(e,i):e.insLeftOf(t.parent):e.insRightOf(t.parent)}}latex(){var t,e;return`$${null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.latex())&&void 0!==e?e:""}$`}}class Rt extends it{constructor(t,e){super(t),this.element=document.createElement("span"),this.upDownCache={},this.blink=()=>this.element.classList.toggle("mq-blink"),this.options=e,this.element.classList.add("mq-cursor"),this.element.textContent="​"}show(){var t,e;return this.element.classList.remove("mq-blink"),this.element.style.display="",this.intervalId?clearInterval(this.intervalId):(this[n]?this.selection&&(null===(t=this.selection.ends[s])||void 0===t?void 0:t[s])===this[s]?this.selection.elements.first.before(this.element):this[n].elements.first.before(this.element):this.parent.elements.firstElement.append(this.element),null===(e=this.parent)||void 0===e||e.focus()),this.intervalId=setInterval(this.blink,500),this}hide(){return this.intervalId&&clearInterval(this.intervalId),delete this.intervalId,this.element.style.display="none",this.element.remove(),this}withDirInsertAt(t,e,i,r){const o=this.parent;this.parent=e,this[t]=i,this[t===s?n:s]=r,o!==e&&o.blur&&o.blur(this)}insDirOf(t,e){var n;return a(t),t===s?e.elements.first.before(this.element):e.elements.last.after(this.element),this.withDirInsertAt(t,e.parent,e[t],e),null===(n=this.parent)||void 0===n||n.elements.addClass("mq-has-cursor"),this}insLeftOf(t){return this.insDirOf(s,t)}insRightOf(t){return this.insDirOf(n,t)}insAtDirEnd(t,e){return a(t),t===s?e.elements.firstElement.prepend(this.element):e.elements.lastElement.append(this.element),this.withDirInsertAt(t,e,void 0,e.ends[t]),e.focus(),this}insAtLeftEnd(t){return this.insAtDirEnd(s,t)}insAtRightEnd(t){return this.insAtDirEnd(n,t)}jumpUpDown(t,e){this.upDownCache[t.id]=it.copy(this);const s=this.upDownCache[e.id];s?s[n]?this.insLeftOf(s[n]):this.insAtRightEnd(s.parent):e.seek(this.offset().left,this)}offset(){return this.element.getBoundingClientRect()}unwrapGramp(){var t,e,i,r,o,l,a,c,h,d;const u=null===(t=this.parent)||void 0===t?void 0:t.parent,p=u.parent,f=u[n];let m=u[s];if(u.disown().eachChild((t=>{t.isEmpty()||(t.children().adopt(p,m,f).each((t=>{u.elements.first.before(...t.elements.contents)})),m=t.ends[n])})),!this[n])if(this[s])this[n]=null===(e=this[s])||void 0===e?void 0:e[n];else for(;!this[n];){if(this.parent=null===(i=this.parent)||void 0===i?void 0:i[n],!this.parent){this[n]=u[n],this.parent=p;break}this[n]=null===(r=this.parent)||void 0===r?void 0:r.ends[s]}this[n]?this.insLeftOf(this[n]):this.insAtRightEnd(p),u.elements.remove(),(null===(o=u[s])||void 0===o?void 0:o.siblingDeleted)&&(null===(a=null===(l=u[s])||void 0===l?void 0:l.siblingDeleted)||void 0===a||a.call(l,this.options,n)),(null===(c=u[n])||void 0===c?void 0:c.siblingDeleted)&&(null===(d=null===(h=u[n])||void 0===h?void 0:h.siblingDeleted)||void 0===d||d.call(h,this.options,s))}startSelection(){this.anticursor=it.copy(this),this.anticursor.ancestors={};for(let t=this.anticursor;t.parent;t=t.parent)this.anticursor.ancestors[t.parent.id]=t}endSelection(){delete this.anticursor}select(){var t,e,i,r,o;if(this[s]===(null===(t=this.anticursor)||void 0===t?void 0:t[s])&&this.parent===(null===(e=this.anticursor)||void 0===e?void 0:e.parent))return!1;if(l("selection well formed",!!this.anticursor&&!!this.anticursor.ancestors),!this.anticursor||!this.anticursor.ancestors)return!1;let a=this,c=null;for(;a.parent;a=a.parent)if(a.parent.id in this.anticursor.ancestors){c=a.parent;break}l("cursor and anticursor in the same tree",!!c);const h=this.anticursor.ancestors[null!==(i=null==c?void 0:c.id)&&void 0!==i?i:0];let d,u,p=n;if(a[s]!==h)for(let t=a;t;t=t[n])if(t[n]===h[n]){p=s,d=a,u=h;break}return p===n&&(d=h,u=a),d instanceof it&&(d=d[n]),u instanceof it&&(u=u[s]),this.hide().selection=null==c?void 0:c.selectChildren(d,u),this.insDirOf(p,null===(r=this.selection)||void 0===r?void 0:r.ends[p]),null===(o=this.selectionChanged)||void 0===o||o.call(this),!0}clearSelection(){var t;return this.selection&&(this.selection.clear(),delete this.selection,null===(t=this.selectionChanged)||void 0===t||t.call(this)),this}deleteSelection(){var t,e,i;this.selection&&(this[s]=null===(t=this.selection.ends[s])||void 0===t?void 0:t[s],this[n]=null===(e=this.selection.ends[n])||void 0===e?void 0:e[n],this.selection.remove(),null===(i=this.selectionChanged)||void 0===i||i.call(this),delete this.selection)}replaceSelection(){var t,e;const i=this.selection;return i&&(this[s]=null===(t=i.ends[s])||void 0===t?void 0:t[s],this[n]=null===(e=i.ends[n])||void 0===e?void 0:e[n],delete this.selection),i}depth(){let t=this.parent,e=0;for(;t;)e+=t instanceof Dt?1:0,t=t.parent;return e}isTooDeep(t){if(void 0!==this.options.maxDepth)return this.depth()+(t||0)>this.options.maxDepth}}const Bt=t=>class extends t{scrollHoriz(){const t=this.root.elements.firstElement.getBoundingClientRect();let e=0;if(this.cursor.selection){const i=this.cursor.selection.elements.firstElement.getBoundingClientRect(),r=i.left-(t.left+20),o=i.right-(t.right-20);if(this.cursor.selection.ends[s]===this.cursor[n])if(r<0)e=r;else{if(!(o>0))return;e=i.left-o<t.left+20?r:o}else if(o>0)e=o;else{if(!(r<0))return;e=i.right-r>t.right-20?o:r}}else{const s=this.cursor.element.getBoundingClientRect().left;if(s>t.right-20)e=s-(t.right-20);else{if(!(s<t.left+20))return;e=s-(t.left+20)}}setTimeout((()=>this.root.elements.firstElement.scrollLeft+=e),100)}},Mt=t=>class extends t{exportLatex(){return this.root.latex().replace(/(\\[a-z]+) (?![a-z])/gi,"$1")}writeLatex(t){var e;const s=this.notify("edit").cursor;return null===(e=s.parent)||void 0===e||e.writeLatex(s,t),this}renderLatexMath(t){const e=Tt.skip(ct.eof).or(ct.all.result(!1)).parse(t);if(this.root.eachChild("postOrder","dispose"),delete this.root.ends[s],delete this.root.ends[n],e&&e.prepareInsertionAt(this.cursor)){e.children().adopt(this.root);const t=e.join("html");this.root.elements.html(t),this.root.domify(this.root.elements.children()),this.root.finalizeInsert(this.cursor.options)}else this.root.elements.empty();delete this.cursor.selection,this.cursor.insAtRightEnd(this.root)}renderLatexText(t){this.root.elements.children().contents.slice(1).forEach((t=>t.remove())),this.root.eachChild("postOrder","dispose"),delete this.root.ends[s],delete this.root.ends[n],delete this.cursor.selection,this.cursor.show().insAtRightEnd(this.root);const e=ct.string("$").then(Tt).skip(ct.string("$").or(ct.eof)).map((t=>{const e=new It(this.cursor);e.createBlocks();const n=e.ends[s];return t.children().adopt(n),e})),i=ct.string("\\$").result("$").or(ct.regex(/^[^$]/)).map(mt),r=e.or(i).many().skip(ct.eof).or(ct.all.result(!1)).parse(t);if(r){for(const t of r)t.adopt(this.root,this.root.ends[n]);this.root.elements.lastElement.append(...this.root.domify().contents),this.root.finalizeInsert(this.cursor.options)}}};class zt extends(dt(ot(st))){constructor(){super(),this.anticursorPosition=0,this.ctrlSeq="\\text"}replaces(t){t instanceof J?this.replacedText=t.remove().elements.text():"string"==typeof t&&(this.replacedText=t)}addToElements(t){var e;super.addToElements(t),null===(e=this.ends[s])||void 0===e||e.addToElements(this.elements.first.firstChild)}createLeftOf(t){var e,i,r,o;if(super.createLeftOf(t),t.insAtRightEnd(this),this.replacedText)for(const e of this.replacedText)this.write(t,e);null===(i=null===(e=this[n])||void 0===e?void 0:e.siblingCreated)||void 0===i||i.call(e,t.options,s),null===(o=null===(r=this[s])||void 0===r?void 0:r.siblingCreated)||void 0===o||o.call(r,t.options,n),this.bubble("reflow")}parser(){return ct.optWhitespace.then(ct.string("{")).then(ct.regex(/^(\\}|[^}])*/)).skip(ct.string("}")).map((t=>0===t.length?new J:(new Ft(t.replace(/\\{/g,"{").replace(/\\}/g,"}")).adopt(this),this)))}textContents(){return this.foldChildren("",((t,e)=>t+e.text()))}text(){return this.textContents()}latex(){const t=this.textContents();return 0===t.length?"":"\\text{"+t.replace(/[{}]/g,"\\$&")+"}"}html(){return`<span class="mq-text-mode" ${t}=${this.id}>${this.textContents()}</span>`}moveTowards(t,e){e.insAtDirEnd(t===s?n:s,this)}moveOutOf(t,e){e.insDirOf(t,this)}unselectInto(t,e){e.insAtDirEnd(t===s?n:s,this);const i=e[t].splitRight(this.anticursorPosition);t===s&&(e[s]=i),e.anticursor=new it(this,i[s],i),e.anticursor.ancestors={};for(let t=e.anticursor;t.parent;t=t.parent)e.anticursor.ancestors[t.parent.id]=t}selectOutOf(t,e){var n,i,r,o,l,a;this.anticursorPosition=t===s?(null!==(r=null===(i=null===(n=e.selection)||void 0===n?void 0:n.elements.first.textContent)||void 0===i?void 0:i.length)&&void 0!==r?r:1)-1:this.textContents().length-(null!==(a=null===(l=null===(o=e.selection)||void 0===o?void 0:o.elements.first.textContent)||void 0===l?void 0:l.length)&&void 0!==a?a:1)+1,e.insDirOf(t,this)}deleteOutOf(t,e){this.isEmpty()&&e.insRightOf(this)}write(t,e){if(t.show().deleteSelection(),"$"!==e)this.postOrder("reflow"),t[s]?t[s].appendText(e):new Ft(e).createLeftOf(t),this.bubble("reflow");else if(this.isEmpty())t.insRightOf(this),new mt("\\$","$").createLeftOf(t);else if(t[n])if(t[s]){const e=new zt,n=this.ends[s];n.disown().elements.detach(),n.adopt(e),t.insLeftOf(this),super.createLeftOf.call(e,t)}else t.insLeftOf(this);else t.insRightOf(this);this.bubble("reflow")}writeLatex(t,e){t[s]?t[s].appendText(e):new Ft(e).createLeftOf(t),this.bubble("reflow")}seek(t,e){var i,r,o,l,a,c;e.hide();const h=this.fuseChildren(),d=getComputedStyle(this.elements.firstElement),u=(this.elements.firstElement.getBoundingClientRect().width-parseFloat(d.paddingLeft)-parseFloat(d.paddingRight))/this.text().length,p=Math.round((t-this.elements.firstElement.getBoundingClientRect().left)/u);p<=0?e.insAtLeftEnd(this):p>=h.text().length?e.insAtRightEnd(this):e.insLeftOf(h.splitRight(p));let f=t-e.show().offset().left;const m=f&&f<0?s:n;let v=m;for(;e[m]&&f*v>0;)null===(i=e[m])||void 0===i||i.moveTowards(m,e),v=f,f=t-e.offset().left;if(m*f<-m*v&&(null===(r=e[m===s?n:s])||void 0===r||r.moveTowards(m===s?n:s,e)),e.anticursor){if(e.anticursor.parent===this){const t=null!==(c=e[s]&&(null===(a=e[s])||void 0===a?void 0:a.text().length))&&void 0!==c?c:0;if(this.anticursorPosition===t)e.startSelection();else{let i;this.anticursorPosition<t?(i=e[s].splitRight(this.anticursorPosition),e[s]=i):i=e[n].splitRight(this.anticursorPosition-t),e.anticursor=new it(this,i[s],i),e.anticursor.ancestors={};for(let t=e.anticursor;t.parent;t=t.parent)e.anticursor.ancestors[t.parent.id]=t}}}else this.anticursorPosition=null!==(l=e[s]&&(null===(o=e[s])||void 0===o?void 0:o.text().length))&&void 0!==l?l:0}blur(t){var e;super.blur(),t&&(""===this.textContents()?(this.remove(),t[s]===this?t[s]=this[s]:t[n]===this&&(t[n]=this[n])):(this.elements.find(".mq-selection").contents.length&&t.clearSelection(),this.fuseChildren()),null===(e=null==this?void 0:this.getController())||void 0===e||e.handle("textBlockExit"))}fuseChildren(){this.elements.first.normalize();const t=this.elements.first.firstChild;if(!t)return;l("only node in TextBlock span is Text node",3===t.nodeType);const e=new Ft(t.data);return e.addToElements(t),this.children().disown(),e.adopt(this)}focus(){var t;super.focus(),null===(t=this.getController())||void 0===t||t.handle("textBlockEnter")}}class Ft extends st{constructor(t){super(),this.textStr=t}text(){return this.textStr}addToElements(t){this.dom=t,this.elements=new Y(t)}domify(){return this.addToElements(document.createTextNode(this.textStr)),this.elements}appendText(t){var e;this.textStr+=t,null===(e=this.dom)||void 0===e||e.appendData(t)}prependText(t){var e;this.textStr=t+this.textStr,null===(e=this.dom)||void 0===e||e.insertData(0,t)}insTextAtDirEnd(t,e){a(e),e===n?this.appendText(t):this.prependText(t)}splitRight(t){var e;const s=new Ft(this.textStr.slice(t)).adopt(this.parent,this,this[n]);return s.addToElements(null===(e=this.dom)||void 0===e?void 0:e.splitText(t)),this.textStr=this.textStr.slice(0,t),s}endChar(t,e){return e.charAt(t===s?0:-1+e.length)}moveTowards(t,e){a(t);const i=this.endChar(t===s?n:s,this.textStr),r=this[t===s?n:s];return r?r.insTextAtDirEnd(i,t):new Ft(i).createDir(t===s?n:s,e),this.deleteTowards(t,e)}latex(){return this.textStr}deleteTowards(t,e){var s,i;this.textStr.length>1?t===n?(null===(s=this.dom)||void 0===s||s.deleteData(0,1),this.textStr=this.textStr.slice(1)):(null===(i=this.dom)||void 0===i||i.deleteData(-1+this.textStr.length,1),this.textStr=this.textStr.slice(0,-1)):(this.remove(),this.elements.remove(),e[t]=this[t])}selectTowards(t,e){a(t);const i=e.anticursor,r=this.endChar(t===s?n:s,this.textStr);if((null==i?void 0:i[t])===this){const s=new Ft(r).createDir(t,e);i[t]=s,e.insDirOf(t,s)}else{const o=this[t===s?n:s];if(o)o.insTextAtDirEnd(r,t);else{const i=new Ft(r).createDir(t===s?n:s,e);e.selection&&i.elements.insDirOf(t===s?n:s,e.selection.elements)}1===this.textStr.length&&(null==i?void 0:i[t===s?n:s])===this&&(i[t===s?n:s]=this[t===s?n:s])}return this.deleteTowards(t,e)}}h.text=h.textnormal=h.textrm=h.textup=d['"']=h.textmd=zt;const Nt=(t,e,s)=>class extends zt{constructor(){super(),this.ctrlSeq=t,this.htmlTemplate=`<${e} ${s}>&0</${e}>`}};h.em=h.italic=h.italics=h.emph=h.textit=h.textsl=Nt("\\textit","i",'class="mq-text-mode"'),h.strong=h.bold=h.textbf=Nt("\\textbf","b",'class="mq-text-mode"'),h.sf=h.textsf=Nt("\\textsf","span",'class="mq-sans-serif mq-text-mode"'),h.tt=h.texttt=Nt("\\texttt","span",'class="mq-monospace mq-text-mode"'),h.textsc=Nt("\\textsc","span",'style="font-variant:small-caps" class="mq-text-mode"'),h.uppercase=Nt("\\uppercase","span",'style="text-transform:uppercase" class="mq-text-mode"'),h.lowercase=Nt("\\lowercase","span",'style="text-transform:lowercase" class="mq-text-mode"');const Wt=r=>class extends r{delegateMouseEvents(){const t=this.root.elements.firstElement;this.mouseDownHandler=r=>{var o,l,a,c,h;const d=r.target.closest(".mq-root-block"),u=st.byId[parseInt(null!==(o=(null==d?void 0:d.getAttribute(e))||(null==t?void 0:t.getAttribute(e)))&&void 0!==o?o:"0")];if(!u.controller)throw"controller undefined... what?";const p=u.controller,f=p.cursor,m=f.blink,v=p.textareaSpan,g=p.textarea;if(r.preventDefault(),f.options.ignoreNextMousedown(r))return;f.options.ignoreNextMousedown=()=>!1,f.endSelection();const b=r.target.ownerDocument;let w;const x=t=>w=t.target,q=t=>{var e;f.anticursor||f.startSelection(),p.seek(w,null!==(e=t.pageX)&&void 0!==e?e:0).cursor.select(),w=void 0},O=()=>{f.blink=m,f.selection||(p.editable?f.show():null==v||v.remove()),null==d||d.removeEventListener("mousemove",x),b.removeEventListener("mousemove",q),b.removeEventListener("mouseup",O)};if(3!==r.detail){if(2===r.detail){if(p.seek(r.target,null!==(l=r.pageX)&&void 0!==l?l:0),f[n]||(null===(a=f[s])||void 0===a?void 0:a.parent)!==u||p.moveLeft(),f[n]instanceof qt){const t=f[n];for(;f[s]&&f[s]instanceof qt&&f[s].isPartOfOperator===t.isPartOfOperator;)p.moveLeft();for(f.startSelection();f[n]&&f[n]instanceof qt&&f[n].isPartOfOperator===t.isPartOfOperator;)p.selectRight()}else if(f[n]instanceof wt){for(;f[s]&&f[s]instanceof wt;)p.moveLeft();for(f.startSelection();f[n]&&f[n]instanceof wt;)p.selectRight()}else f.startSelection(),p.selectRight();return(null===(c=f[s])||void 0===c?void 0:c.parent)instanceof zt&&(f[s].parent.moveOutOf(s,f),p.selectRight()),void O()}p.blurred&&(p.editable||null==d||d.prepend(v),null==g||g.focus()),f.blink=i,p.seek(r.target,null!==(h=r.pageX)&&void 0!==h?h:0).cursor.startSelection(),null==d||d.addEventListener("mousemove",x),b.addEventListener("mousemove",q),b.addEventListener("mouseup",O)}else{for(p.notify("move").cursor.insAtRightEnd(p.root);f[s];)p.selectLeft();O()}},this.container.addEventListener("mousedown",this.mouseDownHandler)}seek(s,n){var i,r;const o=this.notify("select").cursor;let a=0;if(s&&(a=parseInt(null!==(i=s.getAttribute(e)||s.getAttribute(t))&&void 0!==i?i:"0"),!a)){const n=s.parentElement;a=parseInt(null!==(r=(null==n?void 0:n.getAttribute(e))||(null==n?void 0:n.getAttribute(t)))&&void 0!==r?r:"0")}const c=a?st.byId[a]:this.root;return l("nodeId is the id of some TNode that exists",!!c),o.clearSelection().show(),c.seek(n,o),this.scrollHoriz(),this}},Pt=t=>class extends t{exportText(){return this.root.foldChildren("",((t,e)=>t+e.text()))}},Ht=t=>class extends t{createTextarea(){this.textareaSpan=document.createElement("span"),this.textareaSpan.classList.add("mq-textarea");const t=this.options.substituteTextarea();if(!t.nodeType)throw"substituteTextarea() must return a DOM element, got "+t.toString();this.textareaSpan.append(t),this.textarea=t,this.cursor.selectionChanged=()=>this.selectionChanged()}selectionChanged(){this.textareaSelectionTimeout||(this.textareaSelectionTimeout=setTimeout((()=>this.setTextareaSelection())))}setTextareaSelection(){var t;delete this.textareaSelectionTimeout;let e="";this.cursor.selection&&(e=this.cursor.selection.join("latex"),this.options.statelessClipboard&&(e=`$${e}$`)),null===(t=this.selectFn)||void 0===t||t.call(this,e)}staticMathTextareaEvents(){var t,e,s,n,i;const r=document.createElement("span");r.classList.add("mq-selectable"),r.textContent=`$${this.exportLatex()}$`,this.container.prepend(r),this.blurred=!0,null===(t=this.textarea)||void 0===t||t.addEventListener("cut",(t=>{t.stopPropagation(),t.preventDefault()})),null===(e=this.textarea)||void 0===e||e.addEventListener("paste",(t=>{t.stopPropagation(),t.preventDefault()})),null===(s=this.textarea)||void 0===s||s.addEventListener("copy",(()=>this.setTextareaSelection())),null===(n=this.textarea)||void 0===n||n.addEventListener("focus",(()=>this.blurred=!1)),null===(i=this.textarea)||void 0===i||i.addEventListener("blur",(()=>{this.cursor.selection&&this.cursor.selection.clear(),setTimeout((()=>{var t;null===(t=this.textareaSpan)||void 0===t||t.remove(),this.blurred=!0}))})),this.selectFn=t=>{var e;this.textarea&&(this.textarea.value=t),t&&(null===(e=this.textarea)||void 0===e||e.select())}}editablesTextareaEvents(){const{select:t}=nt(this.textarea,this);this.selectFn=e=>t(e),this.container.prepend(this.textareaSpan),this.focusBlurEvents()}unbindEditablesEvents(){var t,e,s;this.selectFn=t=>{var e;this.textarea&&(this.textarea.value=t),t&&(null===(e=this.textarea)||void 0===e||e.select())},null===(t=this.textareaSpan)||void 0===t||t.remove(),this.unbindFocusBlurEvents(),this.blurred=!0,null===(e=this.textarea)||void 0===e||e.addEventListener("cut",(t=>{t.stopPropagation(),t.preventDefault()})),null===(s=this.textarea)||void 0===s||s.addEventListener("paste",(t=>{t.stopPropagation(),t.preventDefault()}))}keystroke(t,e){var s;null===(s=this.cursor.parent)||void 0===s||s.keystroke(t,e,this)}typedText(t){var e;if("\n"===t)return this.handle("enter");const s=this.notify().cursor;null===(e=s.parent)||void 0===e||e.write(s,t),this.scrollHoriz()}cut(){this.cursor.selection&&setTimeout((()=>{var t;this.notify("edit"),null===(t=this.cursor.parent)||void 0===t||t.bubble("reflow")}))}copy(){this.setTextareaSelection()}paste(t){this.options.statelessClipboard&&(t="$"===t.slice(0,1)&&"$"===t.slice(-1)?t.slice(1,-1):`\\text{${t}}`),this.writeLatex(t).cursor.show()}};class jt{constructor(t,e,s){this.KIND_OF_MQ="",this.editable=!1,this.id=t.id,this.root=t,this.container=e,this.options=s,this.cursor=new Rt(t,s)}handle(t,e){var i,r;const o=this.options.handlers;o&&o[t]&&(e===s||e===n?null===(i=o[t])||void 0===i||i.call(o,e,this.apiClass):null===(r=o[t])||void 0===r||r.call(o,this.apiClass))}notify(t){return"move"!==t&&"upDown"!==t||this.cursor.show().clearSelection(),"upDown"!==t&&(this.cursor.upDownCache={}),"edit"===t&&this.cursor.show().deleteSelection(),"select"!==t&&this.cursor.endSelection(),this}selectionChanged(){}}class Ut extends(Pt(Ht(Mt(ht(Wt(Bt(jt))))))){constructor(t,e,s){super(t,e,s),t.controller=this}escapeDir(t,e,s){var n;a(t);const i=this.cursor;if(i.parent!==this.root&&s.preventDefault(),i.parent!==this.root)return null===(n=i.parent)||void 0===n||n.moveOutOf(t,i),this.notify("move")}moveDir(t){var e,s;a(t);const n=this.cursor,i=n.options.leftRightIntoCmdGoes;return n.selection?n.insDirOf(t,n.selection.ends[t]):n[t]?null===(e=n[t])||void 0===e||e.moveTowards(t,n,i):null===(s=n.parent)||void 0===s||s.moveOutOf(t,n,i),this.notify("move")}moveLeft(){return this.moveDir(s)}moveRight(){return this.moveDir(n)}moveUpDown(t){var e,i,r,o,l;const a=this.notify("upDown").cursor,c=`${t}Into`,h=`${t}OutOf`;return(null===(e=a[n])||void 0===e?void 0:e[c])?a.insAtLeftEnd(null===(i=a[n])||void 0===i?void 0:i[c]):(null===(r=a[s])||void 0===r?void 0:r[c])?a.insAtRightEnd(null===(o=a[s])||void 0===o?void 0:o[c]):null===(l=a.parent)||void 0===l||l.bubble((t=>{if(t[h]&&("function"==typeof t[h]&&t[h](a),t[h]instanceof st&&a.jumpUpDown(t,t[h]),!0!==t[h]))return!1})),this}moveUp(){return this.moveUpDown("up")}moveDown(){return this.moveUpDown("down")}deleteDir(t){var e,i,r,o,l,c,h,d;a(t);const u=this.cursor,p=u.selection;return this.notify("edit"),p||(u[t]?null===(e=u[t])||void 0===e||e.deleteTowards(t,u):null===(i=u.parent)||void 0===i||i.deleteOutOf(t,u)),null===(r=u[n])||void 0===r||r.postOrder("contactWeld",u),null===(l=null===(o=u[s])||void 0===o?void 0:o.siblingDeleted)||void 0===l||l.call(o,u.options,n),null===(h=null===(c=u[n])||void 0===c?void 0:c.siblingDeleted)||void 0===h||h.call(c,u.options,s),null===(d=u.parent)||void 0===d||d.bubble("reflow"),this}ctrlDeleteDir(t){var e,i,r,o,l,c,h,d;a(t);const u=this.cursor;return!u[t]||u.selection?this.deleteDir(t):(this.notify("edit"),t===s?new J(null===(e=u.parent)||void 0===e?void 0:e.ends[s],u[s]).remove():new J(u[n],null===(i=u.parent)||void 0===i?void 0:i.ends[n]).remove(),u.insAtDirEnd(t,u.parent),null===(r=u[n])||void 0===r||r.postOrder("contactWeld",u),null===(l=null===(o=u[s])||void 0===o?void 0:o.siblingDeleted)||void 0===l||l.call(o,u.options,n),null===(h=null===(c=u[n])||void 0===c?void 0:c.siblingDeleted)||void 0===h||h.call(c,u.options,s),null===(d=u.parent)||void 0===d||d.bubble("reflow"),this)}backspace(){return this.deleteDir(s)}deleteForward(){return this.deleteDir(n)}selectDir(t){var e,i;const r=this.notify("select").cursor,o=r.selection;a(t),r.anticursor||r.startSelection();const l=r[t];l?o&&(null==o?void 0:o.ends[t])===l&&(null===(e=r.anticursor)||void 0===e?void 0:e[t===s?n:s])!==l?l.unselectInto(t,r):l.selectTowards(t,r):null===(i=r.parent)||void 0===i||i.selectOutOf(t,r),r.clearSelection(),r.select()||r.show()}selectLeft(){return this.selectDir(s)}selectRight(){return this.selectDir(n)}}class Vt{constructor(t){this.__controller=t,this.__controller.apiClass=this,this.__options=t.options,this.id=t.id}__mathquillify(...t){const s=this.__controller.root,n=this.__controller.container;this.__controller.createTextarea(),n.classList.add(...t);const i=Array.from(n.childNodes).map((t=>n.removeChild(t))),r=document.createElement("span");r.classList.add("mq-root-block"),r.setAttribute(e,s.id.toString()),s.elements.add(r),n.append(r),this.latex(i.reduce(((t,e)=>{var s;return 8===e.nodeType?t:`${t}${null!==(s=e.textContent)&&void 0!==s?s:""}`}),"")),this.revert=()=>{for(;n.firstChild;)n.firstChild.remove();return n.classList.remove("mq-editable-field","mq-math-mode","mq-text-mode"),this.__controller.mouseDownHandler&&n.removeEventListener("mousedown",this.__controller.mouseDownHandler),n.append(...i),n}}get options(){return this.__options}config(t){return X.config(this.__options,t),this}el(){return this.__controller.container}text(){return this.__controller.exportText()}latex(t){var e;return void 0!==t?(this.__controller.renderLatexMath(t),this.__controller.blurred&&(null===(e=this.__controller.cursor.hide().parent)||void 0===e||e.blur()),this):this.__controller.exportLatex()}html(){return this.__controller.root.elements.html().replace(new RegExp(` (?:${e}|${t})="?\\d+"?`,"g"),"").replace(/<span class="?mq-cursor( mq-blink)?"?>.?<\/span>/i,"").replace(/ mq-has-cursor|mq-has-cursor ?/,"").replace(/ class=(""|(?= |>))/g,"")}reflow(){return this.__controller.root.postOrder("reflow"),this}}class Qt extends Vt{__mathquillify(...t){return super.__mathquillify(...t),this.__controller.editable=!0,this.__controller.delegateMouseEvents(),this.__controller.editablesTextareaEvents(),this}focus(){var t,e;return document.activeElement===this.__controller.textarea?null===(t=this.__controller.textarea)||void 0===t||t.dispatchEvent(new FocusEvent("focus")):null===(e=this.__controller.textarea)||void 0===e||e.focus(),this}blur(){var t,e;return document.activeElement!==this.__controller.textarea?null===(t=this.__controller.textarea)||void 0===t||t.dispatchEvent(new FocusEvent("blur")):null===(e=this.__controller.textarea)||void 0===e||e.blur(),this}write(t){var e;return this.__controller.writeLatex(t),this.__controller.scrollHoriz(),this.__controller.blurred&&(null===(e=this.__controller.cursor.hide().parent)||void 0===e||e.blur()),this}empty(){const t=this.__controller.root,e=this.__controller.cursor;return t.eachChild("postOrder","dispose"),delete t.ends[s],delete t.ends[n],t.elements.empty(),delete e.selection,e.insAtRightEnd(t),this}cmd(t){var e,s;const n=this.__controller.notify(),i=n.cursor;if(/^\\[a-z]+$/i.test(t)&&!i.isTooDeep()){t=t.slice(1);const e=h[t];if(e){const s=new e(t);i.selection&&s.replaces(i.replaceSelection()),s.createLeftOf(i.show()),this.__controller.scrollHoriz()}}else null===(e=i.parent)||void 0===e||e.write(i,t);return n.blurred&&(null===(s=i.hide().parent)||void 0===s||s.blur()),this}select(){const t=this.__controller;for(t.notify("move").cursor.insAtRightEnd(t.root);t.cursor[s];)t.selectLeft();return this}clearSelection(){return this.__controller.cursor.clearSelection(),this}moveToDirEnd(t){return this.__controller.notify("move").cursor.insAtDirEnd(t,this.__controller.root),this}moveToLeftEnd(){return this.moveToDirEnd(s)}moveToRightEnd(){return this.moveToDirEnd(n)}keystroke(t){const e=t.replace(/^\s+|\s+$/g,"").split(/\s+/);for(const t of e){const e=new KeyboardEvent("noop");e.preventDefault=i,this.__controller.keystroke(t,e)}return this}typedText(t){for(const e of t)this.__controller.typedText(e);return this}dropEmbedded(t,e,s){const n=document.elementFromPoint(t-window.pageXOffset,e-window.pageYOffset);this.__controller.seek(n,t);(new h.embed).setOptions(s).createLeftOf(this.__controller.cursor)}clickAt(t,e,s){s=s||document.elementFromPoint(t,e);const n=this.__controller,i=n.root;return i.elements.firstElement.contains(s)||(s=i.elements.firstElement),n.seek(s,t+window.pageXOffset),n.blurred&&this.focus(),this}ignoreNextMousedown(t){return this.__controller.cursor.options.ignoreNextMousedown=t,this}}class Kt{push(t){this[Object.keys(this).length]=t}get length(){return Object.keys(this).length}get(t){for(const e of Object.keys(this)){const s=parseInt(e);if(this[s].name===t)return this[s]}}}class Gt extends Vt{constructor(t){super(t),this.__controller.root.postOrder("registerInnerField",this.innerFields=new Kt,Xt)}__mathquillify(){return super.__mathquillify("mq-math-mode"),this.__options.mouseEvents&&(this.__controller.delegateMouseEvents(),this.__controller.staticMathTextareaEvents()),this}latex(t){const e=super.latex(t);return void 0!==t&&this.__controller.root.postOrder("registerInnerField",this.innerFields=new Kt,Xt),e}}Gt.RootBlock=Dt;class Zt extends Qt{__mathquillify(){const t=this.__controller.root.reflow;return this.__controller.root.reflow=i,super.__mathquillify("mq-editable-field","mq-math-mode"),t?this.__controller.root.reflow=t:delete this.__controller.root.reflow,this}}Zt.RootBlock=At;class Xt extends Zt{constructor(){super(...arguments),this.name=""}makeStatic(){this.__controller.editable=!1,this.__controller.root.blur(),this.__controller.unbindEditablesEvents(),this.__controller.container.classList.remove("mq-editable-field")}makeEditable(){this.__controller.editable=!0,this.__controller.editablesTextareaEvents(),this.__controller.cursor.insAtRightEnd(this.__controller.root),this.__controller.container.classList.add("mq-editable-field")}}class Yt extends Qt{__mathquillify(){return super.__mathquillify("mq-editable-field","mq-text-mode")}latex(t){var e;return void 0!==t?(this.__controller.renderLatexText(t),this.__controller.blurred&&(null===(e=this.__controller.cursor.hide().parent)||void 0===e||e.blur()),this):this.__controller.exportLatex()}}Yt.RootBlock=class extends At{keystroke(t,e,s){if("Spacebar"!==t&&"Shift-Spacebar"!==t)return super.keystroke(t,e,s)}write(t,e){t.show().deleteSelection(),"$"===e?new It(t).createLeftOf(t):new mt(e,"<"===e?"&lt;":">"===e?"&gt;":void 0).createLeftOf(t)}};class Jt extends pt{constructor(t,e,s){super(t,`<${e} ${s}>&0</${e}>`)}}h.mathrm=o(Jt,"\\mathrm","span",'class="mq-roman mq-font"'),h.mathit=o(Jt,"\\mathit","i",'class="mq-font"'),h.mathbf=o(Jt,"\\mathbf","b",'class="mq-font"'),h.mathsf=o(Jt,"\\mathsf","span",'class="mq-sans-serif mq-font"'),h.mathtt=o(Jt,"\\mathtt","span",'class="mq-monospace mq-font"'),h.underline=o(Jt,"\\underline","span",'class="mq-non-leaf mq-underline"'),h.overline=h.bar=o(Jt,"\\overline","span",'class="mq-non-leaf mq-overline"'),h.overrightarrow=o(Jt,"\\overrightarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-right"'),h.overleftarrow=o(Jt,"\\overleftarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-left"'),h.overleftrightarrow=o(Jt,"\\overleftrightarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-both"'),h.overarc=o(Jt,"\\overarc","span",'class="mq-non-leaf mq-overarc"'),h.dot=class extends pt{constructor(){super("\\dot",'<span class="mq-non-leaf"><span class="mq-dot-recurring-inner"><span class="mq-dot-recurring">&#x2d9;</span><span class="mq-empty-box">&0</span></span></span>')}},h.textcolor=class extends pt{setColor(t){this.color=t,this.htmlTemplate=`<span class="mq-textcolor" style="color:${t}">&0</span>`}latex(){var t;return`\\textcolor{${null!==(t=this.color)&&void 0!==t?t:""}}{${this.blocks[0].latex()}}`}parser(){return ct.optWhitespace.then(ct.string("{")).then(ct.regex(/^[#\w\s.,()%-]*/)).skip(ct.string("}")).then((t=>(this.setColor(t),super.parser())))}isStyleBlock(){return!0}},h.class=class extends pt{parser(){return ct.optWhitespace.then(ct.string("{")).then(ct.regex(/^[-\w\s\\\xA0-\xFF]*/)).skip(ct.string("}")).then((t=>(this.cls=t||"",this.htmlTemplate=`<span class="mq-class ${t}">&0</span>`,super.parser())))}latex(){var t;return`\\class{${null!==(t=this.cls)&&void 0!==t?t:""}}{${this.blocks[0].latex()}}`}isStyleBlock(){return!0}},h.subscript=h._=class extends yt{constructor(){super(),this.supsub="sub",this.htmlTemplate='<span class="mq-supsub mq-non-leaf"><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203;</span></span>',this.textTemplate=["_"]}finalizeTree(){this.downInto=this.sub=this.ends[s],this.sub.upOutOf=Ot,super.finalizeTree()}},h.superscript=h.supscript=h["^"]=class extends yt{constructor(){super(),this.supsub="sup",this.htmlTemplate='<span class="mq-supsub mq-non-leaf mq-sup-only"><span class="mq-sup">&0</span></span>',this.textTemplate=["^(",")"]}finalizeTree(){this.upInto=this.sup=this.ends[n],this.sup.downOutOf=Ot,super.finalizeTree()}};class te extends St{constructor(t,e){super(t,`<span class="mq-large-operator mq-non-leaf"><span class="mq-to"><span>&1</span></span><big>${e}</big><span class="mq-from"><span>&0</span></span></span>`,[t.length>1?t.slice(1):t])}createLeftOf(t){super.createLeftOf(t),t.options.sumStartsWithNEquals&&!this.replacedFragment&&(new qt("n").createLeftOf(t),(new bt).createLeftOf(t))}}h["∑"]=h.sum=h.summation=o(te,"\\sum ","&sum;"),h["∏"]=h.prod=h.product=o(te,"\\prod ","&prod;"),h.coprod=h.coproduct=o(te,"\\coprod ","&#8720;"),h["∫"]=h.int=h.integral=class extends St{constructor(){super("\\int ",'<span class="mq-int mq-non-leaf"><big>&int;</big><span class="mq-supsub mq-non-leaf"><span class="mq-sup"><span class="mq-sup-inner">&1</span></span><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203</span></span></span>')}},h.frac=h.dfrac=h.cfrac=h.fraction=kt;const ee=t=>class extends t{createLeftOf(t){var e,i,r;if(!this.replacedFragment){let o=t[s];for(;o&&!(o instanceof vt||"text"in h&&o instanceof h.text||o instanceof St||"\\ "===o.ctrlSeq||/^[,;:]$/.test(o.ctrlSeq));)o=o[s];o instanceof St&&o[n]instanceof yt&&(o=o[n],o&&o[n]instanceof yt&&(null===(e=o[n])||void 0===e?void 0:e.ctrlSeq)!=o.ctrlSeq&&(o=o[n])),o===t[s]||t.isTooDeep(1)||(null===(i=t[s])||void 0===i?void 0:i.elements.hasClass("mq-operator-name"))||(this.replaces(new J((null==o?void 0:o[n])||(null===(r=t.parent)||void 0===r?void 0:r.ends[s]),t[s])),t[s]=o)}super.createLeftOf(t)}};h.over=d["/"]=class extends(ee(kt)){};for(const t of["sin","cos","tan","sec","csc","cot"])for(const e of[t,`arc${t}`,`${t}h`,`arc${t}h`])h[e]=o(Ct,`\\${e}`);h.ln=o(Ct,"\\ln"),h.log=class extends Ct{constructor(){super("\\log")}text(){var t,e,n,i;const r=(null===(e=null===(t=this.blocks[0].ends[s])||void 0===t?void 0:t.sub)||void 0===e?void 0:e.text())||"",o=this.blocks[1].text()||"",l=Et("^",null===(n=this.blocks[0].ends[s])||void 0===n?void 0:n.sup);if(r){if("10"===r)return l?`(log10(${o}))${l}`:`log10(${o})`;if(null===(i=this.getController())||void 0===i?void 0:i.options.logsChangeBase){let t=this[s];for(;t&&"\\ "===t.ctrlSeq;t=t[s]);return l||t&&!(t instanceof vt)||t instanceof vt&&t.isUnary?`(log(${o})/log(${r}))${l}`:`log(${o})/log(${r})`}return l?`(logb(${r},${o}))${l}`:`logb(${r},${o})`}return super.text()}};class se extends pt{constructor(){super(),this.ctrlSeq="\\sqrt",this.htmlTemplate='<span class="mq-non-leaf"><span class="mq-scaled mq-sqrt-prefix">&radic;</span><span class="mq-non-leaf mq-sqrt-stem">&0</span></span>',this.textTemplate=["sqrt(",")"],this.reflow=()=>{var t;const e=null===(t=this.ends[n])||void 0===t?void 0:t.elements.firstElement;e&&lt([e.previousElementSibling],1,e.getBoundingClientRect().height/parseFloat(getComputedStyle(e).fontSize)-.1)}}parser(){return Tt.optBlock.then((t=>Tt.block.map((e=>{const s=new ne;return s.blocks=[t,e],t.adopt(s),e.adopt(s,t),s})))).or(super.parser())}}h.sqrt=h["√"]=se,h.hat=class extends pt{constructor(){super("\\hat",'<span class="mq-non-leaf"><span class="mq-hat-prefix">^</span><span class="mq-hat-stem">&0</span></span>',["hat(",")"])}};class ne extends se{constructor(){super(),this.htmlTemplate='<span class="mq-nthroot mq-non-leaf">&0</span><span class="mq-scaled"><span class="mq-sqrt-prefix mq-scaled">&radic;</span><span class="mq-sqrt-stem mq-non-leaf">&1</span></span>',this.textTemplate=["root(",",",")"]}latex(){var t,e,i,r;return`\\sqrt[${null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.latex())&&void 0!==e?e:""}]{${null!==(r=null===(i=this.ends[n])||void 0===i?void 0:i.latex())&&void 0!==r?r:""}}`}text(){var t,e,i,r,o,l,a,c,h;const d=null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.text())&&void 0!==e?e:"";if(""===d||"2"===d)return`sqrt(${null!==(r=null===(i=this.ends[n])||void 0===i?void 0:i.text())&&void 0!==r?r:""})`;if(null===(o=this.getController())||void 0===o?void 0:o.options.rootsAreExponents){const t=this[n]instanceof yt&&"sup"===this[n].supsub;return`${t?"(":""}(${null!==(a=null===(l=this.ends[n])||void 0===l?void 0:l.text())&&void 0!==a?a:""})^(1/${d})${t?")":""}`}return`root(${d},${null!==(h=null===(c=this.ends[n])||void 0===c?void 0:c.text())&&void 0!==h?h:""})`}}h.root=h.nthroot=ne;class ie extends pt{constructor(t,e,s){super(t,`<span class="mq-non-leaf"><span class="mq-diacritic-above">${e}</span><span class="mq-diacritic-stem">&0</span></span>`,s)}}h.vec=o(ie,"\\vec","&rarr;",["vec(",")"]),h.tilde=o(ie,"\\tilde","~",["tilde(",")"]);const re=(t,e)=>{const i=e||t,r=u[t],l=u[i];d[t]=o(_t,s,t,r,i,l),d[r]=o(_t,n,t,r,i,l)};re("("),re("["),re("{","\\{"),h.langle=o(_t,s,"&lang;","&rang;","\\langle ","\\rangle "),h.rangle=o(_t,n,"&lang;","&rang;","\\langle ","\\rangle "),h.abs=d["|"]=o(_t,s,"|","|","|","|"),h.lVert=o(_t,s,"&#8741;","&#8741;","\\lVert ","\\rVert "),h.rVert=o(_t,n,"&#8741;","&#8741;","\\lVert ","\\rVert "),h.left=class extends pt{parser(){return ct.optWhitespace.then(ct.regex(/^(?:[([|]|\\\{|\\langle(?![a-zA-Z])|\\lVert(?![a-zA-Z]))/)).then((t=>{let e="\\"===t.charAt(0)?t.slice(1):t;return"\\langle"==t&&(e="&lang;",t+=" "),"\\lVert"==t&&(e="&#8741;",t+=" "),Tt.then((s=>ct.string("\\right").skip(ct.optWhitespace).then(ct.regex(/^(?:[\])|]|\\\}|\\rangle(?![a-zA-Z])|\\rVert(?![a-zA-Z]))/)).map((n=>{let i="\\"===n.charAt(0)?n.slice(1):n;"\\rangle"==n&&(i="&rang;",n=`${n} `),"\\rVert"==n&&(i="&#8741;",n=`${n} `);const r=new _t(0,e,i,t,n);return r.blocks=[s],s.adopt(r),r}))))}))}},h.right=class extends pt{parser(){return ct.fail("unmatched \\right")}};class oe extends(at(pt)){constructor(){super("\\binom",'<span class="mq-non-leaf"><span class="mq-paren mq-scaled">(</span><span class="mq-non-leaf"><span class="mq-array mq-non-leaf"><span>&0</span><span>&1</span></span></span><span class="mq-paren mq-scaled">)</span></span>',["choose(",",",")"])}}h.binom=h.binomial=oe,h.choose=class extends(ee(oe)){},h.editable=h.MathQuillMathField=class extends pt{constructor(){super("\\MathQuillMathField",'<span class="mq-editable-field"><span class="mq-root-block">&0</span></span>'),this.name=""}parser(){return ct.string("[").then(ct.regex(/^[a-z][a-z0-9]*/i)).skip(ct.string("]")).map((t=>this.name=t)).or(ct.succeed()).then(super.parser())}finalizeTree(t){const e=new Ut(this.ends[s],this.elements.firstElement,t);e.KIND_OF_MQ="MathField",this.field=new Xt(e),this.field.name=this.name,e.editable=!0,e.createTextarea(),e.editablesTextareaEvents(),e.cursor.insAtRightEnd(e.root),rt(e.root),this.field.blur()}registerInnerField(t){t.push(this.field)}latex(){var t,e;return null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.latex())&&void 0!==e?e:""}text(){var t,e;return null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.text())&&void 0!==e?e:""}},h.embed=class extends ft{setOptions(t){const e=()=>"";return this.text=t.text||e,this.htmlTemplate=t.htmlString||"",this.latex=t.latex||e,this}parser(){return ct.string("{").then(ct.regex(/^[a-z][a-z0-9]*/i)).skip(ct.string("}")).then((t=>ct.string("[").then(ct.regex(/^[-\w\s]*/)).skip(ct.string("]")).or(ct.succeed()).map((e=>this.setOptions(p[t](e))))))}},d["\\"]=class extends pt{constructor(){super(),this.ctrlSeq="\\",this.htmlTemplate='<span class="mq-latex-command-input mq-non-leaf">\\<span>&0</span></span>',this.textTemplate=["\\"]}replaces(t){this._replacedFragment=null==t?void 0:t.disown(),this.isEmpty=()=>!1}createBlocks(){super.createBlocks();const t=this.ends[s];t.focus=()=>{var e,s;return null===(e=t.parent)||void 0===e||e.elements.addClass("mq-has-cursor"),t.isEmpty()&&(null===(s=t.parent)||void 0===s||s.elements.removeClass("mq-empty")),t},t.blur=()=>{var e,s;return null===(e=t.parent)||void 0===e||e.elements.removeClass("mq-has-cursor"),t.isEmpty()&&(null===(s=t.parent)||void 0===s||s.elements.addClass("mq-empty")),t},t.write=(e,s)=>{var n;e.show().deleteSelection(),s.match(/[a-z]/i)?new mt(s).createLeftOf(e):(t.parent.renderCommand(e),"\\"===s&&t.isEmpty()||null===(n=e.parent)||void 0===n||n.write(e,s))},t.keystroke=(e,s,n)=>"Tab"===e||"Enter"===e||"Spacebar"===e?(t.parent.renderCommand(n.cursor),void s.preventDefault()):super.keystroke(e,s,n)}createLeftOf(t){if(super.createLeftOf(t),this._replacedFragment){const t=this.elements.first;this._replacedFragment.elements.addClass("mq-blur"),this.elements.first.before(...this._replacedFragment.elements.contents),this.elements.add(this._replacedFragment.elements);const e=e=>{e.stopPropagation(),e.preventDefault(),t.dispatchEvent(new MouseEvent(e.type,e))};this.elements.firstElement.addEventListener("mousedown",e),this.elements.firstElement.addEventListener("mousemove",e)}}latex(){var t,e;return"\\"+(null!==(e=null===(t=this.ends[s])||void 0===t?void 0:t.latex())&&void 0!==e?e:"")+" "}renderCommand(t){var e;this.elements=new Y(this.elements.last),this.remove(),this[n]?t.insLeftOf(this[n]):t.insAtRightEnd(this.parent);const i=(null===(e=this.ends[s])||void 0===e?void 0:e.latex())||" ";if(i in h){const e=new h[i](i);this._replacedFragment&&e.replaces(this._replacedFragment),e.createLeftOf(t)}else{const e=new zt;e.replaces(i),e.createLeftOf(t),t.insRightOf(e),this._replacedFragment&&this._replacedFragment.remove()}}};class le extends ft{constructor(t){super(),this.ctrlSeq=t}createLeftOf(t){for(const e of this.ctrlSeq)new qt(e).createLeftOf(t)}parser(){const t=new Dt;for(const e of this.ctrlSeq)new qt(e).adopt(t,t.ends[n]);return ct.succeed(t.children())}}for(const t in(new X).autoOperatorNames)"_maxLength"!==t&&(h[t]=le);h.operatorname=class extends pt{constructor(t,e,s){super(t,e,s),this.createLeftOf=i}numBlocks(){return 1}parser(){return Tt.block.map((t=>t.children()))}},h.f=class extends qt{constructor(){super("f",'<var class="mq-f">f</var>'),this.letter="f"}italicize(t){return this.elements.html("f"),this.elements.toggleClass("mq-f",t),super.italicize(t)}},h[" "]=h.space=o(mt,"\\ ","&nbsp;"),h["'"]=h.prime=o(mt,"'","&prime;"),h.backslash=o(mt,"\\backslash ","\\"),d["\\"]||(d["\\"]=h.backslash),h.$=o(mt,"\\$","$");class ae extends ft{constructor(t,e){super(t,`<span class="mq-non-symbola">${e||t}</span>`)}}h["@"]=ae,h["&"]=o(ae,"\\&","&amp;"),h["%"]=o(ae,"\\%","%"),h.alpha=h.beta=h.gamma=h.delta=h.zeta=h.eta=h.theta=h.iota=h.kappa=h.mu=h.nu=h.xi=h.rho=h.sigma=h.tau=h.chi=h.psi=h.omega=class extends xt{constructor(t){super(`\\${t} `,`&${t};`)}},h.phi=o(xt,"\\phi ","&#981;"),h.phiv=h.varphi=o(xt,"\\varphi ","&phi;"),h.epsilon=o(xt,"\\epsilon ","&#1013;"),h.epsiv=h.varepsilon=o(xt,"\\varepsilon ","&epsilon;"),h.piv=h.varpi=o(xt,"\\varpi ","&piv;"),h.sigmaf=h.sigmav=h.varsigma=o(xt,"\\varsigma ","&sigmaf;"),h.thetav=h.vartheta=h.thetasym=o(xt,"\\vartheta ","&thetasym;"),h.upsilon=h.upsi=o(xt,"\\upsilon ","&upsilon;"),h.gammad=h.Gammad=h.digamma=o(xt,"\\digamma ","&#989;"),h.kappav=h.varkappa=o(xt,"\\varkappa ","&#1008;"),h.rhov=h.varrho=o(xt,"\\varrho ","&#1009;"),h.pi=h["π"]=o(ae,"\\pi ","&pi;"),h.lambda=o(ae,"\\lambda ","&lambda;"),h.Upsilon=h.Upsi=h.upsih=h.Upsih=o(ft,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),h.Gamma=h.Delta=h.Theta=h.Lambda=h.Xi=h.Pi=h.Sigma=h.Phi=h.Psi=h.Omega=h.forall=class extends mt{constructor(t){super(`\\${t} `,`&${t};`)}};class ce extends pt{constructor(t){super(),this.latex=()=>t}createLeftOf(t){var e,i,r,o,l,a,c;const h=Tt.parse(this.latex());h.children().adopt(t.parent,t[s],t[n]),t[s]=h.ends[n],t.element.before(...h.domify().contents),h.finalizeInsert(t.options,t),null===(r=null===(i=null===(e=h.ends[n])||void 0===e?void 0:e[n])||void 0===i?void 0:i.siblingCreated)||void 0===r||r.call(i,t.options,s),null===(a=null===(l=null===(o=h.ends[s])||void 0===o?void 0:o[s])||void 0===l?void 0:l.siblingCreated)||void 0===a||a.call(l,t.options,n),null===(c=t.parent)||void 0===c||c.bubble("reflow")}parser(){const t=Tt.parse(this.latex());return ct.succeed(t.children())}}h["¹"]=o(ce,"^1"),h["²"]=o(ce,"^2"),h["³"]=o(ce,"^3"),h["¼"]=o(ce,"\\frac14"),h["½"]=o(ce,"\\frac12"),h["¾"]=o(ce,"\\frac34");class he extends vt{constructor(t,e,s){super(t,`<span>${e||t}</span>`,s,!0),this.siblingCreated=this.siblingDeleted=(t,e)=>this.contactWeld(t,e)}contactWeld(t,e){const i=t=>t[s]?!!(t[s]instanceof vt||/^[,;:([]$/.test(t[s].ctrlSeq)):!(t.parent&&t.parent.parent&&t.parent.parent.isStyleBlock())||i(t.parent.parent);if(e!==n)return this.isUnary=i(this),this.elements.firstElement.className=this.isUnary?"":"mq-binary-operator",this}}h["+"]=o(he,"+","+"),h["–"]=h["-"]=o(he,"-","&minus;"),h["±"]=h.pm=h.plusmn=h.plusminus=o(he,"\\pm ","&plusmn;"),h.mp=h.mnplus=h.minusplus=o(he,"\\mp ","&#8723;"),d["*"]=h.sdot=h.cdot=o(vt,"\\cdot ","&middot;","*");const de={ctrlSeq:"\\le ",html:"&le;",text:"<=",ctrlSeqStrict:"<",htmlStrict:"&lt;",textStrict:"<"},ue={ctrlSeq:"\\ge ",html:"&ge;",text:">=",ctrlSeqStrict:">",htmlStrict:"&gt;",textStrict:">"};h["<"]=h.lt=o(gt,de,!0),h[">"]=h.gt=o(gt,ue,!0),h["≤"]=h.le=h.leq=o(gt,de,!1),h["≥"]=h.ge=h.geq=o(gt,ue,!1),h["="]=bt,h["×"]=h.times=o(vt,"\\times ","&times;","*"),h["÷"]=h.div=h.divide=h.divides=o(vt,"\\div ","&divide;","/"),d["~"]=h.sim=o(vt,"\\sim ","~","~"),h.notin=h.cong=h.equiv=h.oplus=h.otimes=class extends vt{constructor(t){super(`\\${t} `,`&${t};`)}},h["≠"]=h.ne=h.neq=o(vt,"\\ne ","&ne;"),h["∗"]=h.ast=h.star=h.loast=h.lowast=o(vt,"\\ast ","&lowast;"),h.therefor=h.therefore=o(vt,"\\therefore ","&there4;"),h.cuz=h.because=o(vt,"\\because ","&#8757;"),h.prop=h.propto=o(vt,"\\propto ","&prop;"),h["≈"]=h.asymp=h.approx=o(vt,"\\approx ","&asymp;"),h.isin=h.in=o(vt,"\\in ","&isin;"),h.ni=h.contains=o(vt,"\\ni ","&ni;"),h.notni=h.niton=h.notcontains=h.doesnotcontain=o(vt,"\\not\\ni ","&#8716;"),h.sub=h.subset=o(vt,"\\subset ","&sub;"),h.sup=h.supset=h.superset=o(vt,"\\supset ","&sup;"),h.nsub=h.notsub=h.nsubset=h.notsubset=o(vt,"\\not\\subset ","&#8836;"),h.nsup=h.notsup=h.nsupset=h.notsupset=h.nsuperset=h.notsuperset=o(vt,"\\not\\supset ","&#8837;"),h.sube=h.subeq=h.subsete=h.subseteq=o(vt,"\\subseteq ","&sube;"),h.supe=h.supeq=h.supsete=h.supseteq=h.supersete=h.superseteq=o(vt,"\\supseteq ","&supe;"),h.nsube=h.nsubeq=h.notsube=h.notsubeq=h.nsubsete=h.nsubseteq=h.notsubsete=h.notsubseteq=o(vt,"\\not\\subseteq ","&#8840;"),h.nsupe=h.nsupeq=h.notsupe=h.notsupeq=h.nsupsete=h.nsupseteq=h.notsupsete=h.notsupseteq=h.nsupersete=h.nsuperseteq=h.notsupersete=h.notsuperseteq=o(vt,"\\not\\supseteq ","&#8841;"),h.mathbb=class extends pt{constructor(t,e,s){super(t,e,s),this.createLeftOf=i}numBlocks(){return 1}parser(){return ct.optWhitespace.then(ct.string("{")).then(ct.optWhitespace).then(ct.regex(/^[NPZQRCH]/)).skip(ct.optWhitespace).skip(ct.string("}")).map((t=>new h[t]))}},h.N=h.naturals=h.Naturals=o(mt,"\\mathbb{N}","&#8469;"),h.P=h.primes=h.Primes=h.projective=h.Projective=h.probability=h.Probability=o(mt,"\\mathbb{P}","&#8473;"),h.Z=h.integers=h.Integers=o(mt,"\\mathbb{Z}","&#8484;"),h.Q=h.rationals=h.Rationals=o(mt,"\\mathbb{Q}","&#8474;"),h.R=h.reals=h.Reals=o(mt,"\\mathbb{R}","&#8477;"),h.C=h.complex=h.Complex=h.complexes=h.Complexes=h.complexplane=h.Complexplane=h.ComplexPlane=o(mt,"\\mathbb{C}","&#8450;"),h.H=h.Hamiltonian=h.quaternions=h.Quaternions=o(mt,"\\mathbb{H}","&#8461;"),h.quad=h.emsp=o(mt,"\\quad ","    "),h.qquad=o(mt,"\\qquad ","        "),h.diamond=o(mt,"\\diamond ","&#9671;"),h.bigtriangleup=o(mt,"\\bigtriangleup ","&#9651;"),h.ominus=o(mt,"\\ominus ","&#8854;"),h.uplus=o(mt,"\\uplus ","&#8846;"),h.bigtriangledown=o(mt,"\\bigtriangledown ","&#9661;"),h.sqcap=o(mt,"\\sqcap ","&#8851;"),h.triangleleft=o(mt,"\\triangleleft ","&#8882;"),h.sqcup=o(mt,"\\sqcup ","&#8852;"),h.triangleright=o(mt,"\\triangleright ","&#8883;"),h.odot=h.circledot=o(mt,"\\odot ","&#8857;"),h.bigcirc=o(mt,"\\bigcirc ","&#9711;"),h.dagger=o(mt,"\\dagger ","&#0134;"),h.ddagger=o(mt,"\\ddagger ","&#135;"),h.wr=o(mt,"\\wr ","&#8768;"),h.amalg=o(mt,"\\amalg ","&#8720;"),h.models=o(mt,"\\models ","&#8872;"),h.prec=o(mt,"\\prec ","&#8826;"),h.succ=o(mt,"\\succ ","&#8827;"),h.preceq=o(mt,"\\preceq ","&#8828;"),h.succeq=o(mt,"\\succeq ","&#8829;"),h.simeq=o(mt,"\\simeq ","&#8771;"),h.mid=o(mt,"\\mid ","&#8739;"),h.ll=o(mt,"\\ll ","&#8810;"),h.gg=o(mt,"\\gg ","&#8811;"),h.parallel=o(mt,"\\parallel ","&#8741;"),h.nparallel=o(mt,"\\nparallel ","&#8742;"),h.bowtie=o(mt,"\\bowtie ","&#8904;"),h.sqsubset=o(mt,"\\sqsubset ","&#8847;"),h.sqsupset=o(mt,"\\sqsupset ","&#8848;"),h.smile=o(mt,"\\smile ","&#8995;"),h.sqsubseteq=o(mt,"\\sqsubseteq ","&#8849;"),h.sqsupseteq=o(mt,"\\sqsupseteq ","&#8850;"),h.doteq=o(mt,"\\doteq ","&#8784;"),h.frown=o(mt,"\\frown ","&#8994;"),h.vdash=o(mt,"\\vdash ","&#8870;"),h.dashv=o(mt,"\\dashv ","&#8867;"),h.nless=o(mt,"\\nless ","&#8814;"),h.ngtr=o(mt,"\\ngtr ","&#8815;"),h.longleftarrow=o(mt,"\\longleftarrow ","&#8592;"),h.longrightarrow=o(mt,"\\longrightarrow ","&#8594;"),h.Longleftarrow=o(mt,"\\Longleftarrow ","&#8656;"),h.Longrightarrow=o(mt,"\\Longrightarrow ","&#8658;"),h.longleftrightarrow=o(mt,"\\longleftrightarrow ","&#8596;"),h.updownarrow=o(mt,"\\updownarrow ","&#8597;"),h.Longleftrightarrow=o(mt,"\\Longleftrightarrow ","&#8660;"),h.Updownarrow=o(mt,"\\Updownarrow ","&#8661;"),h.mapsto=o(mt,"\\mapsto ","&#8614;"),h.nearrow=o(mt,"\\nearrow ","&#8599;"),h.hookleftarrow=o(mt,"\\hookleftarrow ","&#8617;"),h.hookrightarrow=o(mt,"\\hookrightarrow ","&#8618;"),h.searrow=o(mt,"\\searrow ","&#8600;"),h.leftharpoonup=o(mt,"\\leftharpoonup ","&#8636;"),h.rightharpoonup=o(mt,"\\rightharpoonup ","&#8640;"),h.swarrow=o(mt,"\\swarrow ","&#8601;"),h.leftharpoondown=o(mt,"\\leftharpoondown ","&#8637;"),h.rightharpoondown=o(mt,"\\rightharpoondown ","&#8641;"),h.nwarrow=o(mt,"\\nwarrow ","&#8598;"),h.ldots=o(mt,"\\ldots ","&#8230;"),h.cdots=o(mt,"\\cdots ","&#8943;"),h.vdots=o(mt,"\\vdots ","&#8942;"),h.ddots=o(mt,"\\ddots ","&#8945;"),h.surd=o(mt,"\\surd ","&#8730;"),h.triangle=o(mt,"\\triangle ","&#9651;"),h.ell=o(mt,"\\ell ","&#8467;"),h.top=o(mt,"\\top ","&#8868;"),h.flat=o(mt,"\\flat ","&#9837;"),h.natural=o(mt,"\\natural ","&#9838;"),h.sharp=o(mt,"\\sharp ","&#9839;"),h.wp=o(mt,"\\wp ","&#8472;"),h.bot=o(mt,"\\bot ","&#8869;"),h.clubsuit=o(mt,"\\clubsuit ","&#9827;"),h.diamondsuit=o(mt,"\\diamondsuit ","&#9826;"),h.heartsuit=o(mt,"\\heartsuit ","&#9825;"),h.spadesuit=o(mt,"\\spadesuit ","&#9824;"),h.parallelogram=o(mt,"\\parallelogram ","&#9649;"),h.square=o(mt,"\\square ","&#11036;"),h.oint=o(mt,"\\oint ","&#8750;"),h.bigcap=o(mt,"\\bigcap ","&#8745;"),h.bigcup=o(mt,"\\bigcup ","&#8746;"),h.bigsqcup=o(mt,"\\bigsqcup ","&#8852;"),h.bigvee=o(mt,"\\bigvee ","&#8744;"),h.bigwedge=o(mt,"\\bigwedge ","&#8743;"),h.bigodot=o(mt,"\\bigodot ","&#8857;"),h.bigotimes=o(mt,"\\bigotimes ","&#8855;"),h.bigoplus=o(mt,"\\bigoplus ","&#8853;"),h.biguplus=o(mt,"\\biguplus ","&#8846;"),h.lfloor=o(mt,"\\lfloor ","&#8970;"),h.rfloor=o(mt,"\\rfloor ","&#8971;"),h.lceil=o(mt,"\\lceil ","&#8968;"),h.rceil=o(mt,"\\rceil ","&#8969;"),h.opencurlybrace=h.lbrace=o(mt,"\\lbrace ","{"),h.closecurlybrace=h.rbrace=o(mt,"\\rbrace ","}"),h.lbrack=o(mt,"["),h.rbrack=o(mt,"]"),h.slash=o(mt,"/"),h.vert=o(mt,"|"),h.perp=h.perpendicular=o(mt,"\\perp ","&perp;"),h.nabla=h.del=o(mt,"\\nabla ","&nabla;"),h.hbar=o(mt,"\\hbar ","&#8463;"),h.AA=h.Angstrom=h.angstrom=o(mt,"\\text\\AA ","&#8491;"),h.ring=h.circ=h.circle=o(mt,"\\circ ","&#8728;"),h.bull=h.bullet=o(mt,"\\bullet ","&bull;"),h.setminus=h.smallsetminus=o(mt,"\\setminus ","&#8726;"),h.not=h["¬"]=h.neg=o(mt,"\\neg ","&not;"),h["…"]=h.dots=h.ellip=h.hellip=h.ellipsis=h.hellipsis=o(mt,"\\dots ","&hellip;"),h.converges=h.darr=h.dnarr=h.dnarrow=h.downarrow=o(mt,"\\downarrow ","&darr;"),h.dArr=h.dnArr=h.dnArrow=h.Downarrow=o(mt,"\\Downarrow ","&dArr;"),h.diverges=h.uarr=h.uparrow=o(mt,"\\uparrow ","&uarr;"),h.uArr=h.Uparrow=o(mt,"\\Uparrow ","&uArr;"),h.to=o(vt,"\\to ","&rarr;"),h.rarr=h.rightarrow=o(mt,"\\rightarrow ","&rarr;"),h.implies=o(vt,"\\Rightarrow ","&rArr;"),h.rArr=h.Rightarrow=o(mt,"\\Rightarrow ","&rArr;"),h.gets=o(vt,"\\gets ","&larr;"),h.larr=h.leftarrow=o(mt,"\\leftarrow ","&larr;"),h.impliedby=o(vt,"\\Leftarrow ","&lArr;"),h.lArr=h.Leftarrow=o(mt,"\\Leftarrow ","&lArr;"),h.harr=h.lrarr=h.leftrightarrow=o(mt,"\\leftrightarrow ","&harr;"),h.iff=o(vt,"\\Leftrightarrow ","&hArr;"),h.hArr=h.lrArr=h.Leftrightarrow=o(mt,"\\Leftrightarrow ","&hArr;"),h.Re=h.Real=h.real=o(mt,"\\Re ","&real;"),h.Im=h.imag=h.image=h.imagin=h.imaginary=h.Imaginary=o(mt,"\\Im ","&image;"),h.part=h.partial=o(mt,"\\partial ","&part;"),h.inf=h.infty=h.infin=h.infinity=o(mt,"\\infty ","&infin;","inf"),h.pounds=o(mt,"\\pounds ","&pound;"),h.alef=h.alefsym=h.aleph=h.alephsym=o(mt,"\\aleph ","&alefsym;"),h.xist=h.xists=h.exist=h.exists=o(mt,"\\exists ","&exist;"),h.nexists=h.nexist=o(mt,"\\nexists ","&#8708;"),h.and=h.land=h.wedge=o(vt,"\\wedge ","&and;"),h.or=h.lor=h.vee=o(vt,"\\vee ","&or;"),h.o=h.O=h.empty=h.emptyset=h.oslash=h.Oslash=h.nothing=h.varnothing=o(vt,"\\varnothing ","&empty;"),h.U=h.cup=h.union=o(vt,"\\cup ","&cup;","U"),h.cap=h.intersect=h.intersection=o(vt,"\\cap ","&cap;"),h.deg=h.degree=class extends mt{constructor(){super("\\degree ","&deg;")}text(){var t,e;const i=null===(t=this[s])||void 0===t?void 0:t.text(),r=null===(e=this[n])||void 0===e?void 0:e.text();return`${i&&" "!==i?" ":""}deg${r&&/^[^FCK]$/.test(r)?" ":""}`}},h.ang=h.angle=o(mt,"\\angle ","&ang;"),h.measuredangle=o(mt,"\\measuredangle ","&#8737;");class pe{static getInterface(){const t={},s=t=>{var s,n;if(!(t instanceof HTMLElement))return;const i=null!==(n=null===(s=t.querySelector(".mq-root-block"))||void 0===s?void 0:s.getAttribute(e))&&void 0!==n&&n,r=i?st.byId[parseInt(i)].controller:void 0;return null==r?void 0:r.apiClass};s.saneKeyboardEvents=nt,s.config=t=>(X.config(X.prototype,t),s),s.registerEmbed=(t,e)=>{if(!/^[a-z][a-z0-9]*$/i.test(t))throw"Embed name must start with letter and be only letters and digits";p[t]=e};for(const[e,n]of Object.entries({StaticMath:Gt,MathField:Zt,InnerMathField:Xt,TextField:Yt}))t[e]=n,(s[e]=(n,i)=>{const r=s(n);if(r instanceof t[e]||!(n instanceof HTMLElement))return r;const o=new Ut(new t[e].RootBlock,n,new X);return o.KIND_OF_MQ=e,new t[e](o).config(i).__mathquillify()}).prototype=t[e].prototype;return s}static noConflict(){return window.MathQuill=this.origMathQuill,pe}}pe.origMathQuill=window.MathQuill;pe.VERSION="0.10.1",window.MathQuill=pe})();