(()=>{"use strict";
/* @license
 * MathQuill, by Han, Jeanine, and Mary
 * http://mathquill.com | maintainers@mathquill.com
 *
 * Rewritten for the purposes of WeBWorK.
 * https://github.com/openwebwork
 *
 * This Source Code Form is subject to the terms of the
 * Mozilla Public License, v. 2.0. If a copy of the MPL
 * was not distributed with this file, You can obtain
 * one at http://mozilla.org/MPL/2.0/.
 */
const t="data-mathquill-command-id",e="data-mathquill-block-id",s=-1,n=1,i=()=>{},r=t=>(e,s,n)=>t("function"==typeof e?e:t=>{if(e in t)return t[e](s,n)}),o=(t,...e)=>class extends t{constructor(...t){super(...e)}},a=(t,e=!1)=>{if(!e)throw new Error(`prayer failed: ${t}`)},l=t=>{a("a direction was passed",t===s||1===t)},c=(t,e,n)=>{a("a parent is always present",!!t),a("leftward is properly set up",e?e[1]===n&&e.parent===t:t?.ends[s]===n),a("rightward is properly set up",n?n[s]===e&&n.parent===t:t?.ends[1]===e)},h={},d={},p={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{","\\{":"\\}","\\}":"\\{","&lang;":"&rang;","&rang;":"&lang;","\\langle ":"\\rangle ","\\rangle ":"\\langle ","|":"|","\\lVert ":"\\rVert ","\\rVert ":"\\lVert "},u={},f={};for(const t of["arg","det","dim","gcd","hom","ker","lg","lim","max","min","sup","limsup","liminf","injlim","projlim","Pr"])f[t]=1;const m={limsup:1,liminf:1,projlim:1,injlim:1};var g,b,w,x,v,q,O,k,E,y,S,L,C,_,T,$,D,A,I,R,B,M,z,F,W,N,P,U,j,H,V,Q,K,G=function(t,e,s,n){if("a"===s&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(t):n?n.value:e.get(t)},Z=function(t,e,s,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(t,s):i?i.value=s:e.set(t,s),s};class X{constructor(){w.set(this,void 0),v.set(this,void 0),O.set(this,void 0),E.set(this,void 0),S.set(this,void 0),C.set(this,void 0),T.set(this,void 0),D.set(this,void 0),I.set(this,void 0),B.set(this,void 0),z.set(this,void 0),W.set(this,void 0),P.set(this,void 0),j.set(this,void 0),V.set(this,void 0),K.set(this,void 0),this.ignoreNextMousedown=()=>!1}static config(t,e){Object.assign(t,e)}get mouseEvents(){return G(this,w,"f")??G(g,g,"f",b)}set mouseEvents(t){this instanceof g?Z(this,w,t,"f"):Z(g,g,t,"f",b)}get autoCommands(){return G(this,v,"f")??G(g,g,"f",x)}set autoCommands(t){if("object"==typeof t)return void(this instanceof g?(Z(this,v,{_maxLength:0},"f"),Object.assign(G(this,v,"f"),t)):Object.assign(G(g,g,"f",x),t));if(!/^\s*[a-z]+(?:\s+[a-z]+)*\s*$/i.test(t))throw`"${t}" not a space-delimited list of only letters`;const e=t.trim().split(/\s+/),s={_maxLength:0};for(const t of e){if(t.length<2)throw`autocommand "${t}" not minimum length of 2`;if(t in f)throw`"${t}" is a built-in operator name`;s[t]=1,s._maxLength=Math.max(s._maxLength,t.length)}this instanceof g?Z(this,v,s,"f"):Z(g,g,s,"f",x)}addAutoCommands(t){if(G(this,v,"f")||(this.autoCommands=G(g,g,"f",x)),!G(this,v,"f"))throw"autoCommands setter not working";const e=t instanceof Array?t.map((t=>t.trim())):[t.trim()];for(const t of e){if(/\s/.test(t)||!/^[a-z]*$/i.test(t))throw`${t} is not a valid autocommand name`;if(t.length<2)throw`autocommand "${t}" not minimum length of 2`;if(t in f)throw`"${t}" is a built-in operator name`;G(this,v,"f")[t]=1,G(this,v,"f")._maxLength=Math.max(G(this,v,"f")._maxLength,t.length)}}removeAutoCommands(t){if(G(this,v,"f")||(this.autoCommands=G(g,g,"f",x)),!G(this,v,"f"))throw"autoCommands setter not working";const e=t instanceof Array?t.map((t=>t.trim())):[t.trim()];for(const t of e)delete G(this,v,"f")[t];G(this,v,"f")._maxLength=Object.keys(G(this,v,"f")).reduce(((t,e)=>"_maxLength"===e?t:e.length>t?e.length:t),0)}get autoOperatorNames(){return G(this,O,"f")??G(g,g,"f",q)}set autoOperatorNames(t){if("object"==typeof t)return void(this instanceof g?(Z(this,O,{_maxLength:0},"f"),Object.assign(G(this,O,"f"),t)):Object.assign(G(g,g,"f",q),t));if(!/^\s*[a-z]+(?:\s+[a-z]+)*\s*$/i.test(t))throw`"${t}" not a space-delimited list of only letters`;const e=t.trim().split(/\s+/),s={_maxLength:0};for(const t of e){if(t.length<2)throw`"${t}" not minimum length of 2`;s[t]=1,s._maxLength=Math.max(s._maxLength,t.length)}this instanceof g?Z(this,O,s,"f"):Z(g,g,s,"f",q)}addAutoOperatorNames(t){if(G(this,O,"f")||(this.autoOperatorNames=G(g,g,"f",q)),!G(this,O,"f"))throw"autoOperatorNames setter not working";const e=t instanceof Array?t.map((t=>t.trim())):[t.trim()];for(const t of e){if(/\s/.test(t)||!/^[a-z]*$/i.test(t))throw`${t} is not a valid autocommand name`;if(t.length<2)throw`"${t}" not minimum length of 2`;G(this,O,"f")[t]=1,G(this,O,"f")._maxLength=Math.max(G(this,O,"f")._maxLength,t.length)}}removeAutoOperatorNames(t){if(G(this,O,"f")||(this.autoOperatorNames=G(g,g,"f",q)),!G(this,O,"f"))throw"autoOperatorNames setter not working";const e=t instanceof Array?t.map((t=>t.trim())):[t.trim()];for(const t of e)delete G(this,O,"f")[t];G(this,O,"f")._maxLength=Object.keys(G(this,O,"f")).reduce(((t,e)=>"_maxLength"===e?t:e.length>t?e.length:t),0)}get charsThatBreakOutOfSupSub(){return G(this,E,"f")??G(g,g,"f",k)}set charsThatBreakOutOfSupSub(t){this instanceof g?Z(this,E,t,"f"):Z(g,g,t,"f",k)}get statelessClipboard(){return G(this,S,"f")??G(g,g,"f",y)}set statelessClipboard(t){this instanceof g?Z(this,S,t,"f"):Z(g,g,t,"f",y)}get spaceBehavesLikeTab(){return G(this,C,"f")??G(g,g,"f",L)}set spaceBehavesLikeTab(t){this instanceof g?Z(this,C,t,"f"):Z(g,g,t,"f",L)}get leftRightIntoCmdGoes(){return G(this,T,"f")??G(g,g,"f",_)}set leftRightIntoCmdGoes(t){if(t&&"up"!==t&&"down"!==t)throw`"up" or "down" required for leftRightIntoCmdGoes option, got "${t}"`;this instanceof g?Z(this,T,t,"f"):Z(g,g,t,"f",_)}get restrictMismatchedBrackets(){return G(this,D,"f")??G(g,g,"f",$)}set restrictMismatchedBrackets(t){this instanceof g?Z(this,D,t,"f"):Z(g,g,t,"f",$)}get sumStartsWithNEquals(){return G(this,I,"f")??G(g,g,"f",A)}set sumStartsWithNEquals(t){this instanceof g?Z(this,I,t,"f"):Z(g,g,t,"f",A)}get supSubsRequireOperand(){return G(this,B,"f")??G(g,g,"f",R)}set supSubsRequireOperand(t){this instanceof g?Z(this,B,t,"f"):Z(g,g,t,"f",R)}get rootsAreExponents(){return G(this,z,"f")??G(g,g,"f",M)}set rootsAreExponents(t){this instanceof g?Z(this,z,t,"f"):Z(g,g,t,"f",M)}get logsChangeBase(){return G(this,W,"f")??G(g,g,"f",F)}set logsChangeBase(t){this instanceof g?Z(this,W,t,"f"):Z(g,g,t,"f",F)}get maxDepth(){return G(this,P,"f")??G(g,g,"f",N)}set maxDepth(t){"number"==typeof t&&(this instanceof g?Z(this,P,t,"f"):Z(g,g,t,"f",N))}get autoSubscriptNumerals(){return G(this,j,"f")??G(g,g,"f",U)}set autoSubscriptNumerals(t){this instanceof g?Z(this,j,t,"f"):Z(g,g,t,"f",U)}get typingSlashWritesDivisionSymbol(){return G(this,V,"f")??G(g,g,"f",H)}set typingSlashWritesDivisionSymbol(t){this instanceof g?Z(this,V,t,"f"):Z(g,g,t,"f",H)}get typingAsteriskWritesTimesSymbol(){return G(this,K,"f")??G(g,g,"f",Q)}set typingAsteriskWritesTimesSymbol(t){this instanceof g?Z(this,K,t,"f"):Z(g,g,t,"f",Q)}substituteTextarea(){const t=document.createElement("textarea");return t.setAttribute("autocapitalize","off"),t.setAttribute("autocomplete","off"),t.setAttribute("spellcheck","false"),t}}g=X,w=new WeakMap,v=new WeakMap,O=new WeakMap,E=new WeakMap,S=new WeakMap,C=new WeakMap,T=new WeakMap,D=new WeakMap,I=new WeakMap,B=new WeakMap,z=new WeakMap,W=new WeakMap,P=new WeakMap,j=new WeakMap,V=new WeakMap,K=new WeakMap,b={value:!0},x={value:{_maxLength:0}},q={value:(()=>{const t={_maxLength:9};for(const e of["arg","det","dim","gcd","hom","ker","lg","lim","max","min","sup","limsup","liminf","injlim","projlim","Pr"])t[e]=1;for(const e of["gcf","hcf","lcm","proj","span"])t[e]=1;return t})()},k={value:""},y={value:!1},L={value:!1},_={value:void 0},$={value:!1},A={value:!1},R={value:!1},M={value:!1},F={value:!1},N={value:void 0},U={value:!1},H={value:!1},Q={value:!1};class Y{constructor(t){if(this.contents=[],t instanceof Y)this.contents.push(...t.contents);else if(t instanceof Node)this.contents.push(t);else if(t instanceof Array)this.contents.push(...t);else if(t){const e=document.createRange().createContextualFragment(t);this.contents.push(...e.children)}}add(t){this.contents.push(...t instanceof Y?t.contents:t instanceof Array?t:[t]),this.contents.sort(((t,e)=>{if(t===e)return 0;const s=t.compareDocumentPosition(e);return s&Node.DOCUMENT_POSITION_FOLLOWING||s&Node.DOCUMENT_POSITION_CONTAINED_BY?-1:s&Node.DOCUMENT_POSITION_PRECEDING||s&Node.DOCUMENT_POSITION_CONTAINS?1:0}))}get first(){return this.contents[0]instanceof Element||this.contents[0]instanceof CharacterData?this.contents[0]:document.createElement("span")}get last(){const t=this.contents[this.contents.length-1];return t instanceof Element||t instanceof CharacterData?t:document.createElement("span")}get firstElement(){return this.first instanceof HTMLElement?this.first:document.createElement("span")}get lastElement(){return this.last instanceof HTMLElement?this.last:document.createElement("span")}detach(){this.contents.forEach((t=>t.remove()))}remove(){this.detach(),this.contents=[]}empty(){this.contents.forEach((t=>{for(;t.firstChild;)t.firstChild.remove();t.textContent=""}))}children(t){return new Y(this.contents.reduce(((e,s)=>(e.push(...Array.from(s.childNodes).filter((e=>3!==e.nodeType&&(!t||e instanceof Element&&e.matches(t))))),e)),[]))}find(t){return new Y(this.contents.reduce(((e,s)=>(e.push(...s.querySelectorAll(t)),e)),[]))}addClass(...t){this.contents.forEach((e=>{e instanceof Element&&e.classList.add(...t)}))}removeClass(...t){this.contents.forEach((e=>{e instanceof Element&&e.classList.remove(...t)}))}toggleClass(t,e){this.contents.forEach((s=>{s instanceof Element&&s.classList.toggle(t,e)}))}hasClass(t){for(const e of this.contents)if(e instanceof Element&&e.classList.contains(t))return!0;return!1}html(t){return"string"==typeof t?(this.contents.forEach((e=>{e instanceof Element&&(e.innerHTML=t)})),this):this.firstElement?.innerHTML??""}text(t){return t?(this.contents.forEach((e=>{e instanceof Element&&(e.textContent=t)})),this):this.contents.reduce(((t,e)=>`${t}${e.textContent??""}`),"")}insDirOf(t,e){e instanceof Y&&!e.contents.length||(t===s?(e instanceof Y?e.first:e).before(...this.contents):(e instanceof Y?e.last:e).after(...this.contents))}insAtDirEnd(t,e){e instanceof Y&&!e.contents.length||(t===s?(e instanceof Y?e.firstElement:e).prepend(...this.contents):(e instanceof Y?e.lastElement:e).append(...this.contents))}}class J{constructor(t,e,n=s){if(this.elements=new Y,this.ends={},this.each=r((t=>{let e=this.ends[s];if(!e)return this;for(;e!==this.ends[1]?.[1]&&!1!==t(e);e=e?.[1]);return this})),a("no half-empty fragments",!t==!e),!t)return;a("withDir is passed to Fragment",t instanceof st),a("oppDir is passed to Fragment",e instanceof st),a("withDir and oppDir have the same parent",t.parent===e?.parent),this.ends[n]=t,this.ends[n===s?1:s]=e;const i=this.fold([],((t,e)=>(t.push(...e.elements.contents),t)));this.elements.add(i)}withDirAdopt(t,e,n,i){return t===s?this.adopt(e,n,i):this.adopt(e,i,n)}adopt(t,e,n){c(t,e,n),this.disowned=!1;const i=this.ends[s];if(!i)return this;const r=this.ends[1];return e||(t.ends[s]=i),n?n[s]=r:t.ends[1]=r,this.ends[1][1]=n,this.each((n=>{n[s]=e,n.parent=t,e&&(e[1]=n),e=n})),this}disown(){const t=this.ends[s];if(!t||this.disowned)return this;this.disowned=!0;const e=this.ends[1],n=t.parent;return c(n,t[s],t),c(n,e,e?.[1]),t[s]?t[s][1]=e?.[1]:n.ends[s]=e?.[1],e?.[1]?e[1][s]=t[s]:n.ends[1]=t[s],this}remove(){return this.elements.remove(),this.each("postOrder","dispose"),this.disown()}fold(t,e){let s=t;return this.each((t=>{s=e(s,t)})),s}}class tt extends J{constructor(t,e,n=s){super(t,e,n);const i=document.createElement("span");i.classList.add("mq-selection"),this.elements.first.before(i),i.append(...this.elements.contents),this.elements=new Y(i)}adopt(t,e,s){const n=this.elements.children();return this.elements.first.replaceWith(...n.contents),this.elements=n,super.adopt(t,e,s)}clear(){return this.elements.first.replaceWith(...this.elements.first.childNodes),this}join(t){return this.fold("",((e,s)=>e+s[t]()))}}const et=t=>a(`"${t}" should be overridden or never called on this node`);class st{constructor(){this.elements=new Y,this.ends={},this.ctrlSeq="",this.bubble=r((t=>{for(let e=this;e&&!1!==t(e);e=e.parent);return this})),this.postOrder=r((t=>(function e(s){s.eachChild(e),t(s)}(this),this))),this.id=st.uniqueNodeId(),st.byId[this.id]=this}dispose(){delete st.byId[this.id]}toString(){return`{{ MathQuill TNode #${this.id} }}`}addToElements(t){this.elements.add(t)}domify(s){const n=s instanceof Y?s:new Y(this.html()),i=s=>{if(s instanceof HTMLElement){const n=parseInt(s.getAttribute(t)??"0"),i=parseInt(s.getAttribute(e)??"0");n&&st.byId[n].addToElements(s),i&&st.byId[i].addToElements(s)}for(let t=s.firstChild;t;t=t.nextSibling)i(t)};return n.contents.forEach((t=>i(t))),n}createDir(t,e){return l(t),this.domify(),this.elements.insDirOf(t,e.element),e[t]=this.adopt(e.parent,e[s],e[1]),this}createLeftOf(t){this.createDir(s,t)}selectChildren(t,e){return new tt(t,e)}isEmpty(){return!this.ends[s]&&!this.ends[1]}isStyleBlock(){return!1}children(){return new J(this.ends[s],this.ends[1])}eachChild(t,e){return this.children().each(t,e),this}foldChildren(t,e){return this.children().fold(t,e)}withDirAdopt(t,e,s,n){return new J(this,this).withDirAdopt(t,e,s,n),this}adopt(t,e,s){return new J(this,this).adopt(t,e,s),this}disown(){return new J(this,this).disown(),this}remove(){return this.elements.remove(),this.postOrder("dispose"),this.disown()}keystroke(t,e,n){const i=n.cursor;switch(t){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":n.ctrlDeleteDir(s);break;case"Shift-Backspace":case"Backspace":n.backspace();break;case"Escape":case"Tab":return void n.escapeDir(1,t,e);case"Shift-Tab":case"Shift-Escape":return void n.escapeDir(s,t,e);case"End":n.notify("move").cursor.insAtRightEnd(i.parent);break;case"Ctrl-End":n.notify("move").cursor.insAtRightEnd(n.root);break;case"Shift-End":for(;i[1];)n.selectRight();break;case"Ctrl-Shift-End":for(;i[1]||i.parent!==n.root;)n.selectRight();break;case"Home":n.notify("move").cursor.insAtLeftEnd(i.parent);break;case"Ctrl-Home":n.notify("move").cursor.insAtLeftEnd(n.root);break;case"Shift-Home":for(;i[s];)n.selectLeft();break;case"Ctrl-Shift-Home":for(;i[s]||i.parent!==n.root;)n.selectLeft();break;case"Left":n.moveLeft();break;case"Shift-Left":n.selectLeft();break;case"Ctrl-Left":case"Ctrl-Right":case"Ctrl-Up":case"Ctrl-Down":break;case"Right":n.moveRight();break;case"Shift-Right":n.selectRight();break;case"Up":n.moveUp();break;case"Down":n.moveDown();break;case"Shift-Up":if(i[s])for(;i[s];)n.selectLeft();else n.selectLeft();break;case"Shift-Down":if(i[1])for(;i[1];)n.selectRight();else n.selectRight();break;case"Ctrl-Shift-Delete":case"Ctrl-Delete":n.ctrlDeleteDir(1);break;case"Shift-Delete":case"Delete":n.deleteForward();break;case"Meta-A":case"Ctrl-A":for(n.notify("move").cursor.insAtRightEnd(n.root);i[s];)n.selectLeft();break;default:return}e.preventDefault(),n.scrollHoriz()}html(){return""}text(){return""}latex(){return""}focus(){}blur(t){}seek(t,e){}writeLatex(t,e){}finalizeInsert(t,e){}write(t,e){}replaces(t){}setOptions(t){return this}chToCmd(t,e){return this}getController(){return function t(e){return e.controller?e.controller:e.parent?t(e.parent):void 0}(this)}moveOutOf(t,e,s){et("moveOutOf")}moveTowards(t,e,s){et("moveTowards")}deleteOutOf(t,e){et("deleteOutOf")}deleteTowards(t,e){et("deleteTowards")}unselectInto(t,e){et("unselectInto")}selectOutOf(t,e){et("selectOutOf")}selectTowards(t,e){et("selectTowards")}}st.id=0,st.byId={},st.uniqueNodeId=()=>++st.id;const nt=(()=>{const t={ArrowRight:"Right",ArrowLeft:"Left",ArrowDown:"Down",ArrowUp:"Up"," ":"Spacebar"};return(e,n)=>{let i=!1;const r=(t,e)=>{n.options.overrideKeystroke?n.options.overrideKeystroke(t,e):n.keystroke(t,e)};return e.addEventListener("keydown",(s=>{s.target===e&&(i="Unidentified"===s.key,r((e=>{const s=1===(n=e.key).length&&n>="a"&&n<="z"?e.key.toUpperCase():t[e.key]??e.key;var n;const i=[];return e.ctrlKey&&i.push("Ctrl"),e.metaKey&&i.push("Meta"),e.altKey&&i.push("Alt"),e.shiftKey&&i.push("Shift"),i.length?("Alt"!==s&&"Control"!==s&&"Meta"!==s&&"Shift"!==s&&i.push(s),i.join("-")):s})(s),s))})),e.addEventListener("cut",(()=>{n.options.overrideCut?n.options.overrideCut():n.cut()})),e.addEventListener("copy",(()=>{n.options.overrideCopy?n.options.overrideCopy():n.copy()})),e.addEventListener("paste",(t=>{if(t.target!==e)return;e.focus();const s=t.clipboardData?.getData("text")??"";e.value="",s&&(n.options.overridePaste?n.options.overridePaste(s):n.paste(s))})),e.addEventListener("input",(t=>{if("insertFromPaste"===t.inputType)return;const o=t.data??"";1===o.length?n.options.overrideTypedText?n.options.overrideTypedText(o):" "===o&&i&&n.options.spaceBehavesLikeTab&&n.cursor.depth()>1&&","!==n.cursor[s]?.ctrlSeq?(r("Spacebar",t),setTimeout((()=>e.value=""))):(n.typedText(o),setTimeout((()=>e.value=""))):e.value.length>1&&e.select()})),{select:t=>{e.value=t,t&&e instanceof HTMLTextAreaElement&&e.select()}}}})();class it{constructor(t,e,n){this.parent=t,this[s]=e,this[1]=n}static copy(t){return new it(t.parent,t[s],t[1])}}const rt=t=>{t.moveOutOf=e=>t.controller?.handle("moveOutOf",e),t.deleteOutOf=e=>t.controller?.handle("deleteOutOf",e),t.selectOutOf=e=>t.controller?.handle("selectOutOf",e),t.upOutOf=e=>t.controller?.handle("upOutOf",e),t.downOutOf=e=>t.controller?.handle("downOutOf",e),t.reflow=()=>{t.controller?.handle("reflow"),t.controller?.handle("edited"),t.controller?.handle("edit")}},ot=t=>class extends t{moveTowards(t,e,n){const i=n&&this[`${n}Into`];e.insAtDirEnd(t===s?1:s,i||this.ends[t===s?1:s])}deleteTowards(t,e){this.isEmpty()?e[t]=this.remove()[t]:this.moveTowards(t,e)}selectTowards(t,e){e[t===s?1:s]=this,e[t]=this[t]}},at=(t,e,s)=>t.forEach((t=>t.style.transform=`scale(${e},${s})`)),lt=t=>class extends t{constructor(){super(...arguments),this.reflow=()=>{const t=this.content?getComputedStyle(this.content):void 0,e=this.content?.getBoundingClientRect(),s=(e?.height??0)/parseFloat(t?.fontSize??"1");at(this.delims,Math.min(1+.2*(s-1),1.2),1.2*s)}}addToElements(t){super.addToElements(t);const e=this.elements.children();this.delims=[e.firstElement,e.lastElement],this.content=e.contents[1]}};class ct{constructor(t){this._=t}parse(t){return this.skip(ct.eof)._(`${t}`,((t,e)=>e),((t,e)=>{throw`Parse Error: ${e} at ${t||"EOF"}`}))}or(t){return a("or is passed a parser",t instanceof ct),new ct(((e,s,n)=>this._(e,s,(()=>t._(e,s,n)))))}then(t){return new ct(((e,s,n)=>this._(e,((e,i)=>{const r=t instanceof ct?t:"function"==typeof t?t(i):void 0;return a("a parser is returned",r instanceof ct),r._(e,s,n)}),n)))}many(){return new ct(((t,e)=>{const s=[];for(;this._(t,((e,n)=>(t=e,s.push(n),!0)),(()=>!1)););return e(t,s)}))}times(t,e=t){return new ct(((s,n,i)=>{const r=[];let o=!0;for(let n=0;n<e&&o;++n){let e;if(o=this._(s,((t,e)=>(r.push(e),s=t,!0)),((t,n)=>(e=n,s=t,!1))),n<t&&!o)return i(s,e)}return n(s,r)}))}result(t){return this.then(ct.succeed(t))}atMost(t){return this.times(0,t)}atLeast(t){return this.times(t).then((t=>this.many().map((e=>t.concat(e)))))}map(t){return this.then((e=>"function"==typeof t&&/^\s*class\s+/.test(t.toString())?ct.succeed(new t(e)):"function"==typeof t?ct.succeed(t(e)):ct.fail("Invalid map function")))}skip(t){return this.then((e=>t.result(e)))}static string(t){return new ct(((e,s,n)=>{const i=e.slice(0,t.length);return i===t?s(e.slice(t.length),i):n(e,`expected '${t}'`)}))}static regex(t){return a("regexp parser is anchored","^"===t.toString().charAt(1)),new ct(((e,s,n)=>{const i=t.exec(e);return i?s(e.slice(i[0].length),i[0]):n(e,`expected ${t.toString()}`)}))}static succeed(t){return new ct(((e,s)=>s(e,t)))}static fail(t){return new ct(((e,s,n)=>n(e,t)))}}ct.letter=ct.regex(/^[a-z]/i),ct.letters=ct.regex(/^[a-z]*/i),ct.digit=ct.regex(/^[0-9]/),ct.digits=ct.regex(/^[0-9]*/),ct.whitespace=ct.regex(/^\s+/),ct.optWhitespace=ct.regex(/^\s*/),ct.any=new ct(((t,e,s)=>t?e(t.slice(1),t.charAt(0)):s(t,"expected any character"))),ct.all=new ct(((t,e)=>e("",t))),ct.eof=new ct(((t,e,s)=>t?s(t,"expected EOF"):e(t,t)));const ht=t=>class extends t{focusBlurEvents(){this.focusHandler=()=>{this.blurred=!1,this.container.classList.add("mq-focused"),this.cursor.parent||this.cursor.insAtRightEnd(this.root),this.cursor.selection?(this.cursor.selection.elements.removeClass("mq-blur"),this.selectionChanged?.()):this.cursor.show()},this.textarea?.addEventListener("focus",this.focusHandler),this.blurHandler=()=>{this.blurred=!0,this.container.classList.remove("mq-focused"),this.cursor.hide().parent?.blur(),this.cursor.selection&&this.cursor.selection.elements.addClass("mq-blur")},this.textarea?.addEventListener("blur",this.blurHandler),this.blurred=!0,this.cursor.hide().parent?.blur()}unbindFocusBlurEvents(){this.focusHandler&&this.textarea?.removeEventListener("focus",this.focusHandler),this.blurHandler&&this.textarea?.removeEventListener("blur",this.blurHandler),delete this.focusHandler,delete this.blurHandler}},dt=t=>class extends t{focus(){this.elements.addClass("mq-has-cursor"),this.elements.removeClass("mq-empty")}blur(){this.elements.removeClass("mq-has-cursor"),this.isEmpty()&&this.elements.addClass("mq-empty")}};class pt extends st{finalizeInsert(t,e){this.postOrder("finalizeTree",t),this.postOrder("contactWeld",e),this.postOrder("blur"),this.postOrder("reflow"),this[1]?.siblingCreated?.(t,s),this[s]?.siblingCreated?.(t,1),this.bubble("reflow")}prepareInsertionAt(t){const e=t.options.maxDepth;if(void 0!==e){const s=t.depth();if(s>e)return!1;this.removeNodesDeeperThan(e-s)}return!0}removeNodesDeeperThan(t){let e=0;const s=[[this,e]];for(;s.length;){const n=s.shift();n?.[0].children()?.each((i=>{const r=i instanceof At?1:0;e=n[1]+r,e<=t?s.push([i,e]):(r?i.children():i).remove()}))}}}class ut extends(ot(pt)){constructor(t,e,s){super(),this.contentIndex=0,this.blocks=[],this.ctrlSeq=t??"",this.htmlTemplate=e??"",this.textTemplate=s??[""]}replaces(t){t?.disown(),this.replacedFragment=t}isEmpty(){return this.foldChildren(!0,((t,e)=>t&&e.isEmpty()))}parser(){return $t.block.times(this.numBlocks()).map((t=>{this.blocks=t;for(const e of t)e.adopt(this,this.ends[1]);return this}))}createLeftOf(t){const e=this.replacedFragment;this.createBlocks(),super.createLeftOf(t),e&&(e.adopt(this.blocks[this.contentIndex]),this.blocks[this.contentIndex]?.elements.firstElement.append(...e.elements.contents),this.placeCursor(t),this.prepareInsertionAt(t)),this.finalizeInsert(t.options,t),this.placeCursor(t)}createBlocks(){const t=this.numBlocks();this.blocks=Array(t);for(let e=0;e<t;++e)this.blocks[e]=new At,this.blocks[e].adopt(this,this.ends[1])}placeCursor(t){t.insAtRightEnd(this.foldChildren(this.ends[s],((t,e)=>t.isEmpty()?t:e)))}selectChildren(){return new tt(this,this)}unselectInto(t,e){e.insAtDirEnd(t===s?1:s,e.anticursor?.ancestors?.[this.id])}seek(t,e){const i=t=>{const e=t.elements.firstElement.getBoundingClientRect();return{[s]:e.left,[n]:e.left+e.width}},r=i(this);if(t<r[s])return void e.insLeftOf(this);if(t>r[1])return void e.insRightOf(this);let o=r[s];this.eachChild((n=>{const a=i(n);return t<a[s]?(t-o<a[s]-t?n[s]?e.insAtRightEnd(n[s]):e.insLeftOf(this):e.insAtLeftEnd(n),!1):t>a[1]?void(n[1]?o=a[1]:r[1]-t<t-a[1]?e.insRightOf(this):e.insAtRightEnd(n)):(n.seek(t,e),!1)}))}numBlocks(){const t=this.htmlTemplate.match(/&\d+/g);return t?t.length:0}html(){const s=this.blocks,n=` ${t}=${this.id}`,i=this.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);a("no unmatched angle brackets",i.join("")===this.htmlTemplate);for(let t=0,e=i[0];e;++t,e=i[t])if(e.endsWith("/>"))i[t]=`${e.slice(0,-2)}${n}/>`;else if(e.startsWith("<")){a("not an unmatched top-level close tag","/"!==e.charAt(1)),i[t]=`${e.slice(0,-1)}${n}>`;let s=1;do{t+=1,e=i[t],a("no missing close tags",!!e),e.startsWith("</")?s-=1:e.startsWith("<")&&!e.endsWith("/>")&&(s+=1)}while(s>0)}return i.join("").replace(/>&(\d+)/g,((t,n)=>` ${e}=${s[n]?.id??""}>${s[n]?.join("html")??""}`))}latex(){return this.foldChildren(this.ctrlSeq,((t,e)=>`${t}{${e.latex()||" "}}`))}text(){let t=0;return this.foldChildren(this.textTemplate[t],((e,s)=>{++t;const n=s.text();return e&&"("===this.textTemplate[t]&&n.startsWith("(")&&n.endsWith(")")?e+n.slice(1,-1)+this.textTemplate[t]:e+n+(this.textTemplate[t]||"")}))}}class ft extends ut{constructor(t,e,s){const n=s||(t&&t.length>1?t.slice(1):t??"");super(t,e,[n]),this.createBlocks=i,this.isSymbol=!0}parser(){return ct.succeed(this)}numBlocks(){return 0}replaces(t){t?.remove()}moveTowards(t,e){t===s?this.elements.first.before(e.element):this.elements.last.after(e.element),e[t===s?1:s]=this,e[t]=this[t]}deleteTowards(t,e){e[t]=this.remove()[t]}seek(t,e){const s=this.elements.firstElement.getBoundingClientRect();t-s.left<s.width/2?e.insLeftOf(this):e.insRightOf(this)}latex(){return this.ctrlSeq}text(){return this.textTemplate.join("")}placeCursor(){}isEmpty(){return!0}}class mt extends ft{constructor(t,e,s){super(t,`<span>${e||t}</span>`,s)}}class gt extends ft{constructor(t,e,s,n=!1){super(t,!0===n?e:`<span class="mq-binary-operator">${e??""}</span>`,s),this.isUnary=!1}}class bt extends gt{constructor(t,e){const s=e?"Strict":"";super(t[`ctrlSeq${s}`],t[`html${s}`],t[`text${s}`]),this.data=t,this.strict=e}swap(t){this.strict=t;const e=t?"Strict":"";this.ctrlSeq=this.data[`ctrlSeq${e}`],this.elements.html(this.data[`html${e}`]),this.textTemplate=[this.data[`text${e}`]]}deleteTowards(t,e){if(t===s&&!this.strict)return this.swap(!0),void this.bubble("reflow");super.deleteTowards(t,e)}}class wt extends bt{constructor(t,e){super(t,e),this.isUnary=e}swap(t){this.isUnary=t,this.contactWeld(),super.swap(t)}contactWeld(){return this.isUnary?this.elements.firstElement.className="":this.elements.firstElement.className="mq-binary-operator",this}}class xt extends gt{constructor(){super("=","=")}createLeftOf(t){if(t[s]instanceof bt&&t[s].strict)return t[s].swap(!1),void t[s]?.bubble("reflow");super.createLeftOf(t)}}class vt extends mt{createLeftOf(t){t.options.autoSubscriptNumerals&&t.parent!==t.parent?.parent?.sub&&(t[s]instanceof qt&&!1!==t[s].isItalic||t[s]instanceof St&&t[s]?.[s]instanceof qt&&!1!==t[s]?.[s].isItalic)?((new h._).createLeftOf(t),super.createLeftOf(t),t.insRightOf(t.parent.parent)):super.createLeftOf(t)}}class qt extends ft{constructor(t,e){super(t,`<var>${e||t}</var>`),this.isItalic=!1,this.isPartOfOperator=!1}text(){let t=this.ctrlSeq;return t.startsWith("\\")?t=t.startsWith("\\operatorname{")?t.slice(14,t.length):t.slice(1,t.length):(t.endsWith(" ")||t.endsWith("}"))&&(t=t.slice(0,-1),this[1]instanceof _t||this[1]instanceof Et||this[1]instanceof St||(t+=" ")),t}}class Ot extends qt{constructor(t,e){super(t,e),this.letter=t,this.siblingDeleted=this.siblingCreated=(t,e)=>this.finalizeTree(t,e)}createLeftOf(t){super.createLeftOf(t);const e=t.options.autoCommands,n=e._maxLength;if(n>0){let i="",r=this,o=0;for(;r instanceof Ot&&r?.ctrlSeq===r?.letter&&o<n;)i=r.letter+i,r=r[s],++o;for(;i.length;){if(e[i]){for(o=1,r=this;o<i.length;++o,r=r?.[s]);return new J(r,this).remove(),t[s]=r?.[s],new h[i](i).createLeftOf(t)}i=i.slice(1)}}}italicize(t){return this.isItalic=t,this.isPartOfOperator=!t,this.elements.toggleClass("mq-operator-name",!t),this}finalizeTree(t,e){e!==s&&this[1]instanceof Ot||this.autoUnItalicize(t)}autoUnItalicize(t){const e=t.autoOperatorNames;if(0===e._maxLength)return;let n=this.letter,i=this[s],r=this[1];for(;i instanceof Ot;i=i[s])n=i.letter+n;for(;r instanceof Ot;r=r[1])n+=r.letter;new J(i?.[1]||this.parent?.ends[s],r?.[s]||this.parent?.ends[1]).each((t=>{t.italicize(!0).elements.removeClass("mq-first","mq-last","mq-followed-by-supsub"),t.ctrlSeq=t.letter}));for(let r=0,o=i?.[1]||this.parent?.ends[s];r<n.length;++r,o=o?.[1])for(let i=Math.min(e._maxLength,n.length-r);i>0;--i){const a=n.slice(r,r+i);if(e[a]){let e;for(let t=0,s=o;t<i;t+=1,s=s?.[1])s.italicize(!1),e=s;const n=f[a];if(o.ctrlSeq=(n?"\\":"\\operatorname{")+(o?.ctrlSeq??""),e.ctrlSeq+=n?" ":"}",a in m&&e?.[s]?.[s]?.[s]?.elements.addClass("mq-last"),this.shouldOmitPadding(o?.[s])||o?.elements.addClass("mq-first"),!this.shouldOmitPadding(e?.[1])){const s=e?.[1];s instanceof St?s.siblingCreated?.(t):e?.elements.toggleClass("mq-last",!(s instanceof _t))}r+=i-1,o=e;break}}}shouldOmitPadding(t){return!t||t instanceof gt||t instanceof Lt}}function kt(t){const e=this.parent;let s=t;do{if(s?.[1])return t.insLeftOf(e);s=s?.parent?.parent}while(s!==e);t.insRightOf(e)}class Et extends ut{constructor(){super(),this.ctrlSeq="\\frac",this.htmlTemplate='<span class="mq-fraction mq-non-leaf"><span class="mq-numerator">&0</span><span class="mq-denominator">&1</span><span style="display:inline-block;width:0">&#8203;</span></span>',this.textTemplate=["((",")/(","))"]}text(){let t=this[s];for(;t&&"\\ "===t.ctrlSeq;t=t[s]);const e=t=>{let e=!1,n=0,i=!1,r=0;this.ends[t]?.eachChild((t=>(t instanceof vt&&(i=!0),t instanceof mt&&"."===t.ctrlSeq&&++r,t instanceof vt||t instanceof mt&&"."===t.ctrlSeq&&r<2&&!n||t instanceof gt&&t.isUnary||t instanceof St||++n,(i&&n||n>1||r>1||t instanceof gt&&!t.isUnary||"text"in h&&t instanceof h.text||t instanceof Lt||t instanceof Et||"\\ "===t.ctrlSeq||/^[,;:]$/.test(t.ctrlSeq))&&(e=!0),!e)));const o=t===s?0:1,a=" "!==this.ends[t]?.text()&&this.ends[t]?.text();return a?e?`(${a})`:a:o};return t instanceof gt&&t.isUnary||t?.elements.hasClass("mq-operator-name")||t instanceof St&&t[s]?.elements.hasClass("mq-operator-name")?`(${e(s)}/${e(1)})`:` ${e(s)}/${e(1)} `}finalizeTree(){this.upInto=this.ends[1].upOutOf=this.ends[s],this.downInto=this.ends[s].downOutOf=this.ends[1]}}const yt=(t,e)=>{let s=!1,n=0,i=!1,r=0;e?.eachChild((t=>(t instanceof vt&&(i=!0),t instanceof mt&&"."===t.ctrlSeq&&++r,t instanceof vt||t instanceof mt&&"."===t.ctrlSeq&&r<2&&!n||t instanceof gt&&t.isUnary||++n,(i&&n||n>1||r>1||t instanceof gt&&!t.isUnary||"text"in h&&t instanceof h.text||t instanceof Lt||t instanceof Et||"\\ "===t.ctrlSeq||/^[,;:]$/.test(t.ctrlSeq))&&(s=!0),!s)));const o=" "!==e?.text()&&e?.text();return o?t+(s?`(${o})`:o):""};class St extends ut{constructor(t,e,n){super("_{...}^{...}",e,n),this.supsub="sup",this.reflow=()=>{const t=this.elements,e=t.first.previousElementSibling;if(!e)return;const s=t.children(".mq-sup").firstElement;if(s){const t=getComputedStyle(s),n=s.getBoundingClientRect(),i=parseInt(t.fontSize),r=n.top+n.height-parseFloat(t.paddingTop)-parseFloat(t.paddingBottom)-e.getBoundingClientRect().top-.7*i,o=parseInt(t.marginBottom);s.style.marginBottom=`${o+r}px`}},this.siblingCreated=this.siblingDeleted=t=>{this[s]instanceof Ot&&this[s].isPartOfOperator&&this[1]&&!(this[1]instanceof gt||this[1]instanceof Lt||this[1]instanceof _t)?this.elements.addClass("mq-after-operator-name"):this.elements.removeClass("mq-after-operator-name"),this.maybeFlatten(t)}}hasValidBase(t,e,s){return!t.supSubsRequireOperand||e&&"\\ "!==e.ctrlSeq&&!(e instanceof gt)&&!/^[,;:]$/.test(e.ctrlSeq??"")||!e&&s?.parent instanceof Tt&&s==s.parent.blocks[0]}createLeftOf(t){if(this.hasValidBase(t.options,t[s],t.parent)){if(t[s]instanceof Et){const e=new _t(1,"(",")","(",")");t.selection=t[s].selectChildren(),e.replaces(t.replaceSelection()),e.createLeftOf(t)}super.createLeftOf(t)}else this.replacedFragment&&(this.replacedFragment.adopt(t.parent,t[s],t[1]),t[s]=this.replacedFragment.ends[1])}contactWeld(t){for(const e of[s,1])if(this[e]instanceof St){let n;for(const t of["sub","sup"]){const i=this[t],r=this[e][t];if(i){if(r)if(i.isEmpty())n=new it(r,void 0,r.ends[s]);else{i.elements.children().insAtDirEnd(e===s?1:s,r.elements);const t=i.children().disown();n=new it(r,t.ends[1],r.ends[s]),e===s?t.adopt(r,r.ends[1]):t.adopt(r,void 0,r.ends[s])}else this[e].addBlock(i.disown());this.placeCursor=t=>t.insAtDirEnd(e===s?1:s,r||i)}}return this.remove(),void(t&&(t[s]===this?1===e&&n?n[s]?t.insRightOf(n[s]):t.insAtLeftEnd(n.parent):t.insRightOf(this[e]):n?.[1]&&t.insRightOf(n[1])))}if(this.maybeFlatten(t.options),this.parent?.parent instanceof Tt&&this.parent==this.parent.parent.blocks[0]&&(!this.sup||!this.sub)){const t=this.parent.parent.blocks[0];for(const e of["sub","sup"]){const s=this[e];s&&(s.deleteOutOf=(e,n)=>{s.isEmpty()&&this.remove(),n.insAtDirEnd(e,t)})}}}finalizeTree(){this.ends[s].isSupSubLeft=!0}maybeFlatten(t){const e=this.getController()?.cursor,n=e?.[1]===this?e[s]:this[s];if(!this.hasValidBase(t,n,this.parent)||n instanceof Et){for(const t of["sub","sup"]){const e=this[t];e&&e.children().disown().adopt(this.parent,this[s],this).elements.insDirOf(s,this.elements)}this.remove(),n===e?.[s]&&(e?.[s]?.[1]?e.insLeftOf(e[s]?.[1]):e?.insAtDirEnd(s,e.parent))}}moveTowards(t,e,s){e.options.autoSubscriptNumerals&&!this.sup?e.insDirOf(t,this):super.moveTowards(t,e,s)}deleteTowards(t,e){if(e.options.autoSubscriptNumerals&&this.sub){const n=this.sub.ends[t===s?1:s];n instanceof ft?n.remove():n&&n.deleteTowards(t,e.insAtDirEnd(t===s?1:s,this.sub)),this.sub.isEmpty()&&(this.sub.deleteOutOf(s,e.insAtLeftEnd(this.sub)),this.sup&&e.insDirOf(t===s?1:s,this))}else super.deleteTowards(t,e)}latex(){const t=(t,e)=>{const s=e?.latex();return e?t+(1===s?.length?s:`{${s||" "}}`):""};return t("_",this.sub)+t("^",this.sup)}text(){const t=yt("_",this.sub)+yt("^",this.sup);return t+(t&&this[1]instanceof vt?" ":"")}addBlock(t){if("sub"===this.supsub){this.sup=this.upInto=this.sub.upOutOf=t,t.adopt(this,this.sub).downOutOf=this.sub;const s=document.createElement("span");s.classList.add("mq-sup"),s.append(...t.elements.children().contents),s.setAttribute(e,t.id.toString()),this.elements.firstElement.prepend(s),t.elements=new Y(s)}else{this.sub=this.downInto=this.sup.downOutOf=t,t.adopt(this,void 0,this.sup).upOutOf=this.sup;const s=document.createElement("span");s.classList.add("mq-sub"),s.append(...t.elements.children().contents),s.setAttribute(e,t.id.toString()),this.elements.removeClass("mq-sup-only"),this.elements.firstElement.append(s),t.elements=new Y(s);const n=document.createElement("span");n.style.display="inline-block",n.style.width="0",n.textContent="​",this.elements.firstElement.append(n)}for(const t of["sub","sup"]){const e="sub"===t?"sup":"sub",n="sub"===t?"down":"up",i=this[t];this.parent?.parent instanceof Tt&&this.parent===this.parent.parent.blocks[0]?i.deleteOutOf=(r,o)=>{if(i.isEmpty()){o[r===s?1:s]=i.ends[r],this.supsub=e,delete this[t],delete this[`${n}Into`];const a=this[e];a[`${n}OutOf`]=kt,a.deleteOutOf=(t,e)=>{a.isEmpty()&&this.remove(),e.insAtDirEnd(t,this.parent)},"sub"===t&&(this.elements.addClass("mq-sup-only"),this.elements.first.lastChild?.remove()),i.remove()}o.insDirOf(i[r]?r===s?1:s:r,i.parent)}:i.deleteOutOf=(r,o)=>{if(o.insDirOf(i[r]?r===s?1:s:r,i.parent),!i.isEmpty()){const t=i.ends[r];i.children().disown().withDirAdopt(r,o.parent,o[r],o[r===s?1:s]).elements.insDirOf(r===s?1:s,o.element),o[r===s?1:s]=t}this.supsub=e,delete this[t],delete this[`${n}Into`],this[e][`${n}OutOf`]=kt,delete this[e].deleteOutOf,"sub"===t&&(this.elements.addClass("mq-sup-only"),this.elements.first.lastChild?.remove()),i.remove()}}}}class Lt extends ut{latex(){const t=t=>1===t.length?t:`{${t||" "}}`;return`${this.ctrlSeq}_${t(this.ends[s]?.latex()??"")}^${t(this.ends[1]?.latex()??"")}`}text(){return`${this.ctrlSeq.slice(1,this.ctrlSeq.length-1)}(${this.ends[s]?.text()??""},${this.ends[1]?.text()??""})`}parser(){const t=this.blocks=[new At,new At];for(const e of t)e.adopt(this,this.ends[1]);return ct.optWhitespace.then(ct.string("_").or(ct.string("^"))).then((e=>{const s=t["_"===e?0:1];return $t.block.then((t=>(t.children().adopt(s,s.ends[1]),ct.succeed(this))))})).many().result(this)}finalizeTree(){this.downInto=this.ends[s],this.upInto=this.ends[1],this.ends[s].upOutOf=this.ends[1],this.ends[1].downOutOf=this.ends[s]}}const Ct=t=>class extends(lt(t)){constructor(){super(...arguments),this.side=s,this.sides={[s]:{ch:"(",ctrlSeq:"("},[n]:{ch:")",ctrlSeq:")"}},this.inserted=!1}matchBrack(t,e,n){return(n instanceof _t&&(!(this instanceof Tt)||")"===(!!n.side&&n.sides[n.side].ch))||n instanceof Tt&&!!this.side&&")"===this.sides[this.side].ch)&&!!n.side&&n.side!==(e===s?1:1===e?s:0)&&(!t.restrictMismatchedBrackets||this.side&&p[this.sides[this.side].ch]===n.sides[n.side].ch||{"(":"]","[":")"}[this.sides[s].ch]===n.sides[1].ch)&&n}closeOpposing(t){if(delete t.side,!this.side)return;t.sides[this.side]=this.sides[this.side];const e=t.delims?.[this.side===s?0:1];e&&(e.classList.remove("mq-ghost"),e.innerHTML=this.sides[this.side].ch)}createLeftOf(t){let e,n;if(!this.replacedFragment){const n=t.options;if("|"===this.sides[s].ch)e=this.matchBrack(n,1,t[1])||this.matchBrack(n,s,t[s])||this.matchBrack(n,void 0,t.parent?.parent);else{const i=this.side===s?1:s;e=this.matchBrack(n,i,t[i])||this.matchBrack(n,i,t.parent?.parent)}}if(e){if(n=this.side=e.side===s?1:s,e===t.parent?.parent&&t[n]&&new J(t[n],t.parent?.ends[n],n===s?1:s).disown().withDirAdopt(n===s?1:s,e.parent,e,e[n]).elements.insDirOf(n,e.elements),this instanceof Tt&&n===s){const n=e===t.parent?.parent&&t[1]!==e.ends[1]?.[1]?new J(t[1],e.ends[1]?.ends[1],s).disown():void 0;return t.insRightOf(e),delete this.side,n&&this.replaces(n),super.createLeftOf(t),e.remove(),void this.bubble("reflow")}this.closeOpposing(e),e.bubble("reflow")}else{if(this instanceof Tt&&!this.replacedFragment&&t[1]instanceof _t&&"("===t[1].sides[s].ch&&")"===t[1].sides[1].ch){const e=t[1];return this.side=e.side,this.replaces(new J(e.ends[s]?.ends[s],e.ends[1]?.ends[1],s)),super.createLeftOf(t),e.remove(),void this.bubble("reflow")}e=this,n=e.side,e.replacedFragment?delete e.side:t[n===s?1:s]&&(e.replaces(new J(t[n===s?1:s],t.parent?.ends[n===s?1:s],n)),delete t[n===s?1:s]),super.createLeftOf(t)}n===s?t.insAtLeftEnd(e.ends[s]):t.insRightOf(e)}unwrap(){const t=this.blocks[this.contentIndex].children().disown().adopt(this.parent,this,this[1]);t&&this.elements.last.after(...t.elements.contents),this.remove()}deleteSide(t,e,n){const i=this.parent,r=this[t],o=i.ends[t];if(t===this.side)return this.unwrap(),void(r?n.insDirOf(t===s?1:s,r):n.insAtDirEnd(t,i));const a=!this.side;if(this.side=t===s?1:s,this.matchBrack(n.options,t,this.blocks[this.contentIndex].ends[this.side])){this.closeOpposing(this.blocks[this.contentIndex].ends[this.side]);const e=this.blocks[this.contentIndex].ends[t];this.unwrap(),e?.siblingCreated?.(n.options,t),r?n.insDirOf(t===s?1:s,r):n.insAtDirEnd(t,i)}else{if(this.matchBrack(n.options,t,this.parent?.parent))(this.parent?.parent).closeOpposing(this),(this.parent?.parent).unwrap();else{if(e&&a)return this.unwrap(),void(r?n.insDirOf(t===s?1:s,r):n.insAtDirEnd(t,i));this.sides[t]={ch:p[this.sides[this.side].ch],ctrlSeq:p[this.sides[this.side].ctrlSeq]},this.delims?.forEach(((e,n)=>{e.classList.remove("mq-ghost"),n===(t===s?0:1)&&(e.classList.add("mq-ghost"),e.innerHTML=this.sides[t].ch)}))}if(r){const e=this.blocks[this.contentIndex].ends[t];this.blocks[this.contentIndex].elements.removeClass("mq-empty"),new J(r,o,t===s?1:s).disown().withDirAdopt(t===s?1:s,this.blocks[this.contentIndex],e).elements.insAtDirEnd(t,this.blocks[this.contentIndex].elements),e?.siblingCreated?.(n.options,t),n.insDirOf(t===s?1:s,r)}else e?n.insDirOf(t,this):n.insAtDirEnd(t,this.blocks[this.contentIndex])}}deleteTowards(t,e){this.deleteSide(t===s?1:s,!1,e)}finalizeTree(){if(!this.inserted)return this.blocks[this.contentIndex].deleteOutOf=(t,e)=>this.deleteSide(t,!0,e),void(this.inserted=!0);this.delims?.[this.side===s?1:0].classList.remove("mq-ghost"),delete this.side}};class _t extends(Ct(ut)){constructor(t,e,r,o,a){super(`\\left${o}`,void 0,[e,r]),this.side=t,this.sides={[s]:{ch:e,ctrlSeq:o},[n]:{ch:r,ctrlSeq:a}},this.placeCursor=i,this.siblingCreated=(t,e)=>{e===(this.side===s?1:s)&&this.finalizeTree()}}numBlocks(){return 1}html(){return this.htmlTemplate=`<span class="mq-non-leaf"><span class="mq-scaled mq-paren${1===this.side?" mq-ghost":""}">`+this.sides[s].ch+'</span><span class="mq-non-leaf">&0</span>'+`<span class="mq-scaled mq-paren${this.side===s?" mq-ghost":""}">`+this.sides[1].ch+"</span></span>",super.html()}latex(){return`\\left${this.sides[s]?.ctrlSeq??""}${this.ends[s]?.latex()??""}\\right${this.sides[1]?.ctrlSeq??""}`}text(){return`${this.sides[s]?.ch??""}${this.ends[s]?.text()??""}${this.sides[1]?.ch??""}`}}class Tt extends(Ct(ut)){constructor(t){super(t=t.replace(/\\a(sin|cos|tan|sec|csc|cot)/,"\\arc$1"),void 0,[`${t.slice(1)}(`,")"]),this.contentIndex=1,this.siblingCreated=(t,e)=>{1===e?this.finalizeTree():this.updateFirst()},this.siblingDeleted=()=>this.updateFirst()}updateFirst(){!this[s]||this[s]instanceof gt||this[s]instanceof qt&&this[s].isPartOfOperator?this.elements.first.classList.remove("mq-first"):this.elements.first.classList.add("mq-first")}addToElements(t){this.elements.add(t);const e=new Y(this.elements.children().last).children();this.delims=[e.contents[0],e.contents[2]],this.content=e.contents[1]}numBlocks(){return 2}html(){return this.htmlTemplate=`<span class="mq-non-leaf mq-math-function"><span class="mq-non-leaf mq-function-name">${this.ctrlSeq.slice(1)}</span><span class="mq-non-leaf mq-function-supsub">&0</span><span class="mq-non-leaf mq-function-params"><span class="mq-scaled mq-paren">(</span><span class="mq-non-leaf">&1</span><span class="mq-scaled mq-paren${this.side===s?" mq-ghost":""}">)</span></span></span>`,this.blocks[0].writeHandler=(t,e)=>"_"!==e&&"^"!==e&&(!t[s]&&h[`${this.ctrlSeq.slice(1)}${e}`]?.prototype instanceof Tt?(this.ctrlSeq=`${this.ctrlSeq}${e}`,this.elements.children().first.textContent+=e,this.bubble("reflow"),!0):(this.enterContentBlock(s,t),"("===e)),super.html()}enterContentBlock(t,e){t===s?e.insAtLeftEnd(this.blocks[1]):e.insAtRightEnd(this.blocks[1])}deleteSide(t,e,n){if(t!==s||this.blocks[0].isEmpty()&&this.blocks[1].isEmpty())super.deleteSide(t,e,n);else{let t,e;if(this.blocks[1].isEmpty()||(n.insLeftOf(this),t=new _t(s,"(",")","(",")"),t.replaces(this.blocks[1].children()),t.createLeftOf(n),this.side&&(t.delims?.[1].classList.add("mq-ghost"),t.side=s)),!this.blocks[0].isEmpty()&&this.blocks[0].ends[s]instanceof St){n.insLeftOf(t??this);const i=new qt("x");i.createLeftOf(n);const r=this.blocks[0].ends[s];for(const t of["sub","sup"]){const s=r[t];if(s){e&&n.insRightOf(e);const i=new h["sub"===t?"subscript":"superscript"];i.replaces(s.children()),i.createLeftOf(n),e||(e=i)}}i.remove()}this.remove(),e?n.insLeftOf(e):t&&n.insLeftOf(t)}}finalizeTree(){const t=this.inserted;super.finalizeTree(),t||(this.blocks[0].deleteOutOf=(t,e)=>{if(!e[s]&&h[this.ctrlSeq.slice(1,-1)]?.prototype instanceof Tt)return this.ctrlSeq=this.ctrlSeq.slice(0,-1),this.elements.children().first.textContent=this.ctrlSeq.slice(1),void this.bubble("reflow");t===s?this.deleteSide(t,!0,e):this.enterContentBlock(s,e)},this.blocks[1].deleteOutOf=(t,e)=>{t===s?e?.insAtRightEnd(this.blocks[0]):this.deleteSide(t,!0,e)}),this.updateFirst()}latex(){return`${this.ctrlSeq}${this.blocks[0]?.latex()??""}\\left(${this.blocks[1]?.latex()??""}\\right)`}text(){return`${this[s]instanceof Ot?" ":""}${this.ctrlSeq.slice(1)}${this.blocks[0]?.text()??""}(${this.blocks[1]?.text()??""})`}parser(){delete this.side,this.blocks=[new At,new At];for(const t of this.blocks)t.adopt(this,this.ends[1]);return ct.optWhitespace.then(ct.regex(/^(?=[_^])/)).then($t.block.map((t=>{t.children().adopt(this.blocks[0],this.blocks[0].ends[1])}))).many().or(ct.succeed(this)).then(ct.optWhitespace).then(ct.regex(/^(?=\))|^(?=\\right\))/).or(ct.string("\\left(").then($t.block.many().map((t=>{for(const e of t)e.children().adopt(this.blocks[1],this.blocks[1].ends[1])})).then(ct.optWhitespace).skip(ct.string("\\right)"))).or(ct.string("(").then($t.block.many().map((t=>{")"===t[t.length-1].text()&&t.splice(-1);for(const e of t)e.children().adopt(this.blocks[1],this.blocks[1].ends[1])})).then(ct.optWhitespace).skip(ct.string(")").or(ct.succeed(this)))).or(ct.regex(/^\d+\.?\d*|^\d*\.?\d+/).map((t=>{for(const e of t){("."===e?new mt("."):new vt(e)).adopt(this.blocks[1],this.blocks[1].ends[1])}})).or($t.block.map((t=>{t.children().adopt(this.blocks[1],this.blocks[1].ends[1])}))))).or(ct.succeed(this)))).result(this)}}const $t=(()=>{const t=t=>{const e=t[0]||new At;for(const s of t.slice(1))s.children().adopt(e,e.ends[1]);return e},e=ct.letter.map((t=>new Ot(t))),s=ct.regex(/^\d/).map((t=>new vt(t))),n=ct.regex(/^[^${}\\_^]/).map((t=>new mt(t))),i=ct.regex(/^[^\\a-eg-zA-Z]/).or(ct.string("\\").then(ct.regex(/^[a-z]+/i).or(ct.regex(/^\s+/).result(" ")).or(ct.any))).then((t=>{const e=h[t];return e?new e(t).parser():ct.fail(`unknown command: \\${t}`)})).or(e).or(s).or(n),r=ct.string("{").then((()=>a)).skip(ct.string("}")),o=ct.optWhitespace.then(r.or(i.map((t=>{const e=new At;return t.adopt(e),e})))),a=o.many().map(t).skip(ct.optWhitespace),l=ct.string("[").then(o.then((t=>"]"!==t.join("latex")?ct.succeed(t):ct.fail())).many().map(t).skip(ct.optWhitespace)).skip(ct.string("]")),c=a;return c.block=o,c.optBlock=l,c})(),Dt=t=>class extends t{chToCmd(t,e){const s=d[t]||h[t];return/^[a-eg-zA-Z]$/.exec(t)?new Ot(t):/^\d$/.test(t)?new vt(t):e&&e.typingSlashWritesDivisionSymbol&&"/"===t?new h["÷"](t):e&&e.typingAsteriskWritesTimesSymbol&&"*"===t?new h["×"](t):s?new s(t):new mt(t)}write(t,e){if(this.writeHandler?.(t,e))return;if(this.isSupSubLeft){if(t.options.autoSubscriptNumerals&&this===this.parent?.sub){if("_"===e)return;const s=this.chToCmd(e,t.options);return s.isSymbol?t.deleteSelection():t.clearSelection().insRightOf(this.parent),void s.createLeftOf(t.show())}t[s]&&!t[1]&&!t.selection&&t.options.charsThatBreakOutOfSupSub.includes(e)&&t.insRightOf(this.parent)}const n=this.chToCmd(e,t.options);t.selection&&n.replaces(t.replaceSelection()),t.isTooDeep()||n.createLeftOf(t.show())}};class At extends(dt(Dt(pt))){join(t){return this.foldChildren("",((e,s)=>e+s[t]()))}html(){return this.join("html")}latex(){return this.join("latex")}text(){return this.ends[s]&&this.ends[s]===this.ends[1]?this.ends[s]?.text()??"":this.join("text")}keystroke(t,e,n){return n.options.spaceBehavesLikeTab&&n.cursor.depth()>1&&("Spacebar"===t||"Shift-Spacebar"===t)&&","!==n.cursor[s]?.ctrlSeq?(e.preventDefault(),void n.escapeDir("Shift-Spacebar"===t?s:1,t,e)):super.keystroke(t,e,n)}moveOutOf(t,e,n){!(n&&this.parent?.[`${n}Into`])&&this[t]?e.insAtDirEnd(t===s?1:s,this[t]):e.insDirOf(t,this.parent)}selectOutOf(t,e){e.insDirOf(t,this.parent)}deleteOutOf(t,e){e.unwrapGramp()}seek(t,e){let n=this.ends[1];const i=n?.elements.firstElement.getBoundingClientRect()??void 0;if(!n||(i?.left??0)+(i?.width??0)<t)e.insAtRightEnd(this);else if(t<(this.ends[s]?.elements.firstElement.getBoundingClientRect().left??0))e.insAtLeftEnd(this);else{for(;t<(n?.elements.firstElement.getBoundingClientRect().left??0);)n=n?.[s];n?.seek(t,e)}}writeLatex(t,e){const n=ct.all,i=ct.eof,r=$t.skip(i).or(n.result(!1)).parse(e);if(r&&!r.isEmpty()&&r.prepareInsertionAt(t)){r.children().adopt(t.parent,t[s],t[1]);const e=r.domify();t.element.before(...e.contents),t[s]=r.ends[1],r.finalizeInsert(t.options,t),r.ends[1]?.[1]?.siblingCreated?.(t.options,s),r.ends[s]?.[s]?.siblingCreated?.(t.options,1),t.parent?.bubble("reflow")}}focus(){return super.focus(),this}blur(){return super.blur(),this}}class It extends At{constructor(){super(),rt(this)}}class Rt extends(Dt(ut)){constructor(t){super("$"),this.cursor=t,this.htmlTemplate='<span class="mq-math-mode">&0</span>'}createBlocks(){super.createBlocks();const t=this.ends[s];t.write=(e,n)=>{"$"!==n?this.write(e,n):t.isEmpty()?(e.insRightOf(t.parent),t.parent?.deleteTowards(s,e),new mt("\\$","$").createLeftOf(e.show())):e[1]?e[s]?this.write(e,n):e.insLeftOf(t.parent):e.insRightOf(t.parent)}}latex(){return`$${this.ends[s]?.latex()??""}$`}}class Bt extends it{constructor(t,e){super(t),this.element=document.createElement("span"),this.upDownCache={},this.blink=()=>this.element.classList.toggle("mq-blink"),this.options=e,this.element.classList.add("mq-cursor"),this.element.textContent="​"}show(){return this.element.classList.remove("mq-blink"),this.element.style.display="",this.intervalId?clearInterval(this.intervalId):(this[1]?this.selection&&this.selection.ends[s]?.[s]===this[s]?this.selection.elements.first.before(this.element):this[1].elements.first.before(this.element):this.parent.elements.firstElement.append(this.element),this.parent?.focus()),this.intervalId=setInterval(this.blink,500),this}hide(){return this.intervalId&&clearInterval(this.intervalId),delete this.intervalId,this.element.style.display="none",this.element.remove(),this}withDirInsertAt(t,e,n,i){const r=this.parent;this.parent=e,this[t]=n,this[t===s?1:s]=i,r!==e&&r.blur&&r.blur(this)}insDirOf(t,e){return l(t),t===s?e.elements.first.before(this.element):e.elements.last.after(this.element),this.withDirInsertAt(t,e.parent,e[t],e),this.parent?.elements.addClass("mq-has-cursor"),this}insLeftOf(t){return this.insDirOf(s,t)}insRightOf(t){return this.insDirOf(1,t)}insAtDirEnd(t,e){return l(t),t===s?e.elements.firstElement.prepend(this.element):e.elements.lastElement.append(this.element),this.withDirInsertAt(t,e,void 0,e.ends[t]),e.focus(),this}insAtLeftEnd(t){return this.insAtDirEnd(s,t)}insAtRightEnd(t){return this.insAtDirEnd(1,t)}jumpUpDown(t,e){this.upDownCache[t.id]=it.copy(this);const s=this.upDownCache[e.id];s?s[1]?this.insLeftOf(s[1]):this.insAtRightEnd(s.parent):e.seek(this.offset().left,this)}offset(){return this.element.getBoundingClientRect()}unwrapGramp(){const t=this.parent.parent,e=t.parent,n=t[1];let i=t[s];if(t.disown().eachChild((s=>{s.isEmpty()||(s.children().adopt(e,i,n).each((e=>{t.elements.first.before(...e.elements.contents)})),i=s.ends[1])})),!this[1])if(this[s])this[1]=this[s]?.[1];else for(;!this[1];){if(this.parent=this.parent?.[1],!this.parent){this[1]=t[1],this.parent=e;break}this[1]=this.parent?.ends[s]}this[1]?this.insLeftOf(this[1]):this.insAtRightEnd(e),t.elements.remove(),t[s]?.siblingDeleted&&t[s]?.siblingDeleted?.(this.options,1),t[1]?.siblingDeleted&&t[1]?.siblingDeleted?.(this.options,s)}startSelection(){this.anticursor=it.copy(this),this.anticursor.ancestors={};for(let t=this.anticursor;t.parent;t=t.parent)this.anticursor.ancestors[t.parent.id]=t}endSelection(){delete this.anticursor}select(){if(this[s]===this.anticursor?.[s]&&this.parent===this.anticursor?.parent)return!1;if(a("selection well formed",!!this.anticursor&&!!this.anticursor.ancestors),!this.anticursor?.ancestors)return!1;let t=this,e=null;for(;t.parent;t=t.parent)if(t.parent.id in this.anticursor.ancestors){e=t.parent;break}a("cursor and anticursor in the same tree",!!e);const n=this.anticursor.ancestors[e?.id??0];let i,r,o=1;if(t[s]!==n)for(let e=t;e;e=e[1])if(e[1]===n[1]){o=s,i=t,r=n;break}return 1===o&&(i=n,r=t),i instanceof it&&(i=i[1]),r instanceof it&&(r=r[s]),this.hide().selection=e?.selectChildren(i,r),this.insDirOf(o,this.selection.ends[o]),this.selectionChanged?.(),!0}clearSelection(){return this.selection&&(this.selection.clear(),delete this.selection,this.selectionChanged?.()),this}deleteSelection(){this.selection&&(this[s]=this.selection.ends[s]?.[s],this[1]=this.selection.ends[1]?.[1],this.selection.remove(),this.selectionChanged?.(),delete this.selection)}replaceSelection(){const t=this.selection;return t&&(this[s]=t.ends[s]?.[s],this[1]=t.ends[1]?.[1],delete this.selection),t}depth(){let t=this.parent,e=0;for(;t;)e+=t instanceof At?1:0,t=t.parent;return e}isTooDeep(t){if(void 0!==this.options.maxDepth)return this.depth()+(t||0)>this.options.maxDepth}}const Mt=t=>class extends t{scrollHoriz(){const t=this.root.elements.firstElement.getBoundingClientRect();let e=0;if(this.cursor.selection){const n=this.cursor.selection.elements.firstElement.getBoundingClientRect(),i=n.left-(t.left+20),r=n.right-(t.right-20);if(this.cursor.selection.ends[s]===this.cursor[1])if(i<0)e=i;else{if(!(r>0))return;e=n.left-r<t.left+20?i:r}else if(r>0)e=r;else{if(!(i<0))return;e=n.right-i>t.right-20?r:i}}else{const s=this.cursor.element.getBoundingClientRect().left;if(s>t.right-20)e=s-(t.right-20);else{if(!(s<t.left+20))return;e=s-(t.left+20)}}setTimeout((()=>this.root.elements.firstElement.scrollLeft+=e),100)}},zt=t=>class extends t{exportLatex(){return this.root.latex().replace(/(\\[a-z]+) (?![a-z])/gi,"$1")}writeLatex(t){const e=this.notify("edit").cursor;return e.parent?.writeLatex(e,t),this}renderLatexMath(t){const e=$t.skip(ct.eof).or(ct.all.result(!1)).parse(t);if(this.root.eachChild("postOrder","dispose"),delete this.root.ends[s],delete this.root.ends[1],e instanceof At&&e.prepareInsertionAt(this.cursor)){e.children().adopt(this.root);const t=e.join("html");this.root.elements.html(t),this.root.domify(this.root.elements.children()),this.root.finalizeInsert(this.cursor.options,this.cursor)}else this.root.elements.empty();delete this.cursor.selection,this.cursor.insAtRightEnd(this.root)}renderLatexText(t){this.root.elements.children().contents.slice(1).forEach((t=>t.remove())),this.root.eachChild("postOrder","dispose"),delete this.root.ends[s],delete this.root.ends[1],delete this.cursor.selection,this.cursor.show().insAtRightEnd(this.root);const e=ct.string("$").then($t).skip(ct.string("$").or(ct.eof)).map((t=>{const e=new Rt(this.cursor);e.createBlocks();const n=e.ends[s];return t.children().adopt(n),e})),n=ct.string("\\$").result("$").or(ct.regex(/^[^$]/)).map(mt),i=e.or(n).many().skip(ct.eof).or(ct.all.result(!1)).parse(t);if(i){for(const t of i)t.adopt(this.root,this.root.ends[1]);this.root.elements.lastElement.append(...this.root.domify().contents),this.root.finalizeInsert(this.cursor.options,this.cursor)}}};class Ft extends(dt(ot(st))){constructor(){super(),this.anticursorPosition=0,this.ctrlSeq="\\text"}replaces(t){t instanceof J?this.replacedText=t.remove().elements.text():"string"==typeof t&&(this.replacedText=t)}addToElements(t){super.addToElements(t),this.ends[s]?.addToElements(this.elements.first.firstChild)}createLeftOf(t){if(super.createLeftOf(t),t.insAtRightEnd(this),this.replacedText)for(const e of this.replacedText)this.write(t,e);this[1]?.siblingCreated?.(t.options,s),this[s]?.siblingCreated?.(t.options,1),this.bubble("reflow")}parser(){return ct.optWhitespace.then(ct.string("{")).then(ct.regex(/^(\\}|[^}])*/)).skip(ct.string("}")).map((t=>0===t.length?new J:(new Wt(t.replace(/\\{/g,"{").replace(/\\}/g,"}")).adopt(this),this)))}textContents(){return this.foldChildren("",((t,e)=>t+e.text()))}text(){return this.textContents()}latex(){const t=this.textContents();return 0===t.length?"":"\\text{"+t.replace(/[{}]/g,"\\$&")+"}"}html(){return`<span class="mq-text-mode" ${t}=${this.id}>${this.textContents()}</span>`}moveTowards(t,e){e.insAtDirEnd(t===s?1:s,this)}moveOutOf(t,e){e.insDirOf(t,this)}unselectInto(t,e){e.insAtDirEnd(t===s?1:s,this);const n=e[t].splitRight(this.anticursorPosition);t===s&&(e[s]=n),e.anticursor=new it(this,n[s],n),e.anticursor.ancestors={};for(let t=e.anticursor;t.parent;t=t.parent)e.anticursor.ancestors[t.parent.id]=t}selectOutOf(t,e){this.anticursorPosition=t===s?(e.selection?.elements.first.textContent?.length??1)-1:this.textContents().length-(e.selection?.elements.first.textContent?.length??1)+1,e.insDirOf(t,this)}deleteOutOf(t,e){this.isEmpty()&&e.insRightOf(this)}write(t,e){if(t.show().deleteSelection(),"$"!==e)this.postOrder("reflow"),t[s]?t[s].appendText(e):new Wt(e).createLeftOf(t),this.bubble("reflow");else if(this.isEmpty())t.insRightOf(this),new mt("\\$","$").createLeftOf(t);else if(t[1])if(t[s]){const e=new Ft,n=this.ends[s];n.disown().elements.detach(),n.adopt(e),t.insLeftOf(this),super.createLeftOf.call(e,t)}else t.insLeftOf(this);else t.insRightOf(this);this.bubble("reflow")}writeLatex(t,e){t[s]?t[s].appendText(e):new Wt(e).createLeftOf(t),this.bubble("reflow")}seek(t,e){e.hide();const n=this.fuseChildren(),i=getComputedStyle(this.elements.firstElement),r=(this.elements.firstElement.getBoundingClientRect().width-parseFloat(i.paddingLeft)-parseFloat(i.paddingRight))/this.text().length,o=Math.round((t-this.elements.firstElement.getBoundingClientRect().left)/r);o<=0?e.insAtLeftEnd(this):o>=n.text().length?e.insAtRightEnd(this):e.insLeftOf(n.splitRight(o));let a=t-e.show().offset().left;const l=a&&a<0?s:1;let c=l;for(;e[l]&&a*c>0;)e[l]?.moveTowards(l,e),c=a,a=t-e.offset().left;if(l*a<-l*c&&e[l===s?1:s]?.moveTowards(l===s?1:s,e),e.anticursor){if(e.anticursor.parent===this){const t=e[s]?.text().length??0;if(this.anticursorPosition===t)e.startSelection();else{let n;this.anticursorPosition<t?(n=e[s].splitRight(this.anticursorPosition),e[s]=n):n=e[1].splitRight(this.anticursorPosition-t),e.anticursor=new it(this,n[s],n),e.anticursor.ancestors={};for(let t=e.anticursor;t.parent;t=t.parent)e.anticursor.ancestors[t.parent.id]=t}}}else this.anticursorPosition=e[s]?.text().length??0}blur(t){super.blur(),t&&(""===this.textContents()?(this.remove(),t[s]===this?t[s]=this[s]:t[1]===this&&(t[1]=this[1])):(this.elements.find(".mq-selection").contents.length&&t.clearSelection(),this.fuseChildren()),this?.getController()?.handle("textBlockExit"))}fuseChildren(){this.elements.first.normalize();const t=this.elements.first.firstChild;if(!t)return;a("only node in TextBlock span is Text node",3===t.nodeType);const e=new Wt(t.data);return e.addToElements(t),this.children().disown(),e.adopt(this)}focus(){super.focus(),this.getController()?.handle("textBlockEnter")}}class Wt extends st{constructor(t){super(),this.textStr=t}text(){return this.textStr}addToElements(t){this.dom=t,this.elements=new Y(t)}domify(){return this.addToElements(document.createTextNode(this.textStr)),this.elements}appendText(t){this.textStr+=t,this.dom?.appendData(t)}prependText(t){this.textStr=t+this.textStr,this.dom?.insertData(0,t)}insTextAtDirEnd(t,e){l(e),1===e?this.appendText(t):this.prependText(t)}splitRight(t){const e=new Wt(this.textStr.slice(t)).adopt(this.parent,this,this[1]);return e.addToElements(this.dom.splitText(t)),this.textStr=this.textStr.slice(0,t),e}endChar(t,e){return e.charAt(t===s?0:-1+e.length)}moveTowards(t,e){l(t);const n=this.endChar(t===s?1:s,this.textStr),i=this[t===s?1:s];return i?i.insTextAtDirEnd(n,t):new Wt(n).createDir(t===s?1:s,e),this.deleteTowards(t,e)}latex(){return this.textStr}deleteTowards(t,e){this.textStr.length>1?1===t?(this.dom?.deleteData(0,1),this.textStr=this.textStr.slice(1)):(this.dom?.deleteData(-1+this.textStr.length,1),this.textStr=this.textStr.slice(0,-1)):(this.remove(),this.elements.remove(),e[t]=this[t])}selectTowards(t,e){l(t);const n=e.anticursor,i=this.endChar(t===s?1:s,this.textStr);if(n?.[t]===this){const s=new Wt(i).createDir(t,e);n[t]=s,e.insDirOf(t,s)}else{const r=this[t===s?1:s];if(r)r.insTextAtDirEnd(i,t);else{const n=new Wt(i).createDir(t===s?1:s,e);e.selection&&n.elements.insDirOf(t===s?1:s,e.selection.elements)}1===this.textStr.length&&n?.[t===s?1:s]===this&&(n[t===s?1:s]=this[t===s?1:s])}return this.deleteTowards(t,e)}}h.text=h.textnormal=h.textrm=h.textup=d['"']=h.textmd=Ft;const Nt=(t,e,s)=>class extends Ft{constructor(){super(),this.ctrlSeq=t,this.htmlTemplate=`<${e} ${s}>&0</${e}>`}};h.em=h.italic=h.italics=h.emph=h.textit=h.textsl=Nt("\\textit","i",'class="mq-text-mode"'),h.strong=h.bold=h.textbf=Nt("\\textbf","b",'class="mq-text-mode"'),h.sf=h.textsf=Nt("\\textsf","span",'class="mq-sans-serif mq-text-mode"'),h.tt=h.texttt=Nt("\\texttt","span",'class="mq-monospace mq-text-mode"'),h.textsc=Nt("\\textsc","span",'style="font-variant:small-caps" class="mq-text-mode"'),h.uppercase=Nt("\\uppercase","span",'style="text-transform:uppercase" class="mq-text-mode"'),h.lowercase=Nt("\\lowercase","span",'style="text-transform:lowercase" class="mq-text-mode"');const Pt=n=>class extends n{delegateMouseEvents(){const t=this.root.elements.firstElement;this.mouseDownHandler=n=>{const r=n.target.closest(".mq-root-block"),o=st.byId[parseInt((r?.getAttribute(e)||t?.getAttribute(e))??"0")];if(!o.controller)throw"controller undefined... what?";const a=o.controller,l=a.cursor,c=l.blink,h=a.textareaSpan,d=a.textarea;if(n.preventDefault(),l.options.ignoreNextMousedown(n))return;l.options.ignoreNextMousedown=()=>!1,l.endSelection();const p=n.target.ownerDocument;let u;const f=t=>u=t.target,m=t=>{l.anticursor||l.startSelection(),a.seek(u,t.pageX??0).cursor.select(),u=void 0},g=()=>{l.blink=c,l.selection||(a.editable?l.show():h?.remove()),r?.removeEventListener("mousemove",f),p.removeEventListener("mousemove",m),p.removeEventListener("mouseup",g)};if(3!==n.detail){if(2===n.detail){if(a.seek(n.target,n.pageX??0),l[1]||l[s]?.parent!==o||a.moveLeft(),l[1]instanceof Ot){const t=l[1];for(;l[s]&&l[s]instanceof Ot&&l[s].isPartOfOperator===t.isPartOfOperator;)a.moveLeft();for(l.startSelection();l[1]&&l[1]instanceof Ot&&l[1].isPartOfOperator===t.isPartOfOperator;)a.selectRight()}else if(l[1]instanceof vt){for(;l[s]&&l[s]instanceof vt;)a.moveLeft();for(l.startSelection();l[1]&&l[1]instanceof vt;)a.selectRight()}else l.startSelection(),a.selectRight();return l[s]?.parent instanceof Ft&&(l[s].parent.moveOutOf(s,l),a.selectRight()),void g()}a.blurred&&(a.editable||r?.prepend(h),d?.focus()),l.blink=i,a.seek(n.target,n.pageX??0).cursor.startSelection(),r?.addEventListener("mousemove",f),p.addEventListener("mousemove",m),p.addEventListener("mouseup",g)}else{for(a.notify("move").cursor.insAtRightEnd(a.root);l[s];)a.selectLeft();g()}},this.container.addEventListener("mousedown",this.mouseDownHandler)}seek(s,n){const i=this.notify("select").cursor;let r=0;if(s&&(r=parseInt((s.getAttribute(e)||s.getAttribute(t))??"0"),!r)){const n=s.parentElement;r=parseInt((n?.getAttribute(e)||n?.getAttribute(t))??"0")}const o=r?st.byId[r]:this.root;return a("nodeId is the id of some TNode that exists",!!o),i.clearSelection().show(),o.seek(n,i),this.scrollHoriz(),this}},Ut=t=>class extends t{exportText(){return this.root.foldChildren("",((t,e)=>t+e.text()))}},jt=t=>class extends t{createTextarea(){this.textareaSpan=document.createElement("span"),this.textareaSpan.classList.add("mq-textarea");const t=this.options.substituteTextarea();if(!t.nodeType)throw"substituteTextarea() must return a DOM element";this.textareaSpan.append(t),this.textarea=t,this.cursor.selectionChanged=()=>this.selectionChanged()}selectionChanged(){this.textareaSelectionTimeout||(this.textareaSelectionTimeout=setTimeout((()=>this.setTextareaSelection())))}setTextareaSelection(){delete this.textareaSelectionTimeout;let t="";this.cursor.selection&&(t=this.cursor.selection.join("latex"),this.options.statelessClipboard&&(t=`$${t}$`)),this.selectFn?.(t)}staticMathTextareaEvents(){const t=document.createElement("span");t.classList.add("mq-selectable"),t.textContent=`$${this.exportLatex()}$`,this.container.prepend(t),this.blurred=!0,this.textarea?.addEventListener("cut",(t=>{t.stopPropagation(),t.preventDefault()})),this.textarea?.addEventListener("paste",(t=>{t.stopPropagation(),t.preventDefault()})),this.textarea?.addEventListener("copy",(()=>this.setTextareaSelection())),this.textarea?.addEventListener("focus",(()=>this.blurred=!1)),this.textarea?.addEventListener("blur",(()=>{this.cursor.selection&&this.cursor.selection.clear(),setTimeout((()=>{this.textareaSpan?.remove(),this.blurred=!0}))})),this.selectFn=t=>{this.textarea&&(this.textarea.value=t),t&&this.textarea?.select()}}editablesTextareaEvents(){const{select:t}=nt(this.textarea,this);this.selectFn=e=>t(e),this.container.prepend(this.textareaSpan),this.focusBlurEvents()}unbindEditablesEvents(){this.selectFn=t=>{this.textarea&&(this.textarea.value=t),t&&this.textarea?.select()},this.textareaSpan?.remove(),this.unbindFocusBlurEvents(),this.blurred=!0,this.textarea?.addEventListener("cut",(t=>{t.stopPropagation(),t.preventDefault()})),this.textarea?.addEventListener("paste",(t=>{t.stopPropagation(),t.preventDefault()}))}keystroke(t,e){this.cursor.parent?.keystroke(t,e,this)}typedText(t){if("\n"===t)return this.handle("enter");const e=this.notify().cursor;e.parent?.write(e,t),this.scrollHoriz()}cut(){this.cursor.selection&&setTimeout((()=>{this.notify("edit"),this.cursor.parent?.bubble("reflow")}))}copy(){this.setTextareaSelection()}paste(t){this.options.statelessClipboard&&(t=t.startsWith("$")&&t.endsWith("$")?t.slice(1,-1):`\\text{${t}}`),this.writeLatex(t).cursor.show()}};class Ht{constructor(t,e,s){this.KIND_OF_MQ="",this.editable=!1,this.id=t.id,this.root=t,this.container=e,this.options=s,this.cursor=new Bt(t,s)}handle(t,e){const n=this.options.handlers;n?.[t]&&(e===s||1===e?n[t]?.(e,this.apiClass):n[t]?.(this.apiClass))}notify(t){return"move"!==t&&"upDown"!==t||this.cursor.show().clearSelection(),"upDown"!==t&&(this.cursor.upDownCache={}),"edit"===t&&this.cursor.show().deleteSelection(),"select"!==t&&this.cursor.endSelection(),this}selectionChanged(){}}class Vt extends(Ut(jt(zt(ht(Pt(Mt(Ht))))))){constructor(t,e,s){super(t,e,s),t.controller=this}escapeDir(t,e,s){l(t);const n=this.cursor;if(n.parent!==this.root&&s.preventDefault(),n.parent!==this.root)return n.parent?.moveOutOf(t,n),this.notify("move")}moveDir(t){l(t);const e=this.cursor,s=e.options.leftRightIntoCmdGoes;return e.selection?e.insDirOf(t,e.selection.ends[t]):e[t]?e[t]?.moveTowards(t,e,s):e.parent?.moveOutOf(t,e,s),this.notify("move")}moveLeft(){return this.moveDir(s)}moveRight(){return this.moveDir(1)}moveUpDown(t){const e=this.notify("upDown").cursor,n=`${t}Into`,i=`${t}OutOf`;return e[1]?.[n]?e.insAtLeftEnd(e[1]?.[n]):e[s]?.[n]?e.insAtRightEnd(e[s]?.[n]):e.parent?.bubble((t=>{if(t[i]&&("function"==typeof t[i]&&t[i](e),t[i]instanceof st&&e.jumpUpDown(t,t[i]),!0!==t[i]))return!1})),this}moveUp(){return this.moveUpDown("up")}moveDown(){return this.moveUpDown("down")}deleteDir(t){l(t);const e=this.cursor,n=e.selection;return this.notify("edit"),n||(e[t]?e[t]?.deleteTowards(t,e):e.parent?.deleteOutOf(t,e)),e[1]?.postOrder("contactWeld",e),e[s]?.siblingDeleted?.(e.options,1),e[1]?.siblingDeleted?.(e.options,s),e.parent?.bubble("reflow"),this}ctrlDeleteDir(t){l(t);const e=this.cursor;return!e[t]||e.selection?this.deleteDir(t):(this.notify("edit"),t===s?new J(e.parent?.ends[s],e[s]).remove():new J(e[1],e.parent?.ends[1]).remove(),e.insAtDirEnd(t,e.parent),e[1]?.postOrder("contactWeld",e),e[s]?.siblingDeleted?.(e.options,1),e[1]?.siblingDeleted?.(e.options,s),e.parent?.bubble("reflow"),this)}backspace(){return this.deleteDir(s)}deleteForward(){return this.deleteDir(1)}selectDir(t){const e=this.notify("select").cursor,n=e.selection;l(t),e.anticursor||e.startSelection();const i=e[t];i?n&&n?.ends[t]===i&&e.anticursor?.[t===s?1:s]!==i?i.unselectInto(t,e):i.selectTowards(t,e):e.parent?.selectOutOf(t,e),e.clearSelection(),e.select()||e.show()}selectLeft(){return this.selectDir(s)}selectRight(){return this.selectDir(1)}}class Qt{constructor(t){this.__controller=t,this.__controller.apiClass=this,this.__options=t.options,this.id=t.id}__mathquillify(...t){const s=this.__controller.root,n=this.__controller.container;this.__controller.createTextarea(),n.classList.add(...t);const i=Array.from(n.childNodes).map((t=>n.removeChild(t))),r=document.createElement("span");r.classList.add("mq-root-block"),r.setAttribute(e,s.id.toString()),s.elements.add(r),n.append(r),this.latex(i.reduce(((t,e)=>8===e.nodeType?t:`${t}${e.textContent??""}`),"")),this.revert=()=>{for(;n.firstChild;)n.firstChild.remove();return n.classList.remove("mq-editable-field","mq-math-mode","mq-text-mode"),this.__controller.mouseDownHandler&&n.removeEventListener("mousedown",this.__controller.mouseDownHandler),n.append(...i),n}}get options(){return this.__options}config(t){return X.config(this.__options,t),this}el(){return this.__controller.container}text(){return this.__controller.exportText()}latex(t){return void 0!==t?(this.__controller.renderLatexMath(t),this.__controller.blurred&&this.__controller.cursor.hide().parent?.blur(),this):this.__controller.exportLatex()}html(){return this.__controller.root.elements.html().replace(new RegExp(` (?:${e}|${t})="?\\d+"?`,"g"),"").replace(/<span class="?mq-cursor( mq-blink)?"?>.?<\/span>/i,"").replace(/ mq-has-cursor|mq-has-cursor ?/,"").replace(/ class=(""|(?= |>))/g,"")}reflow(){return this.__controller.root.postOrder("reflow"),this}}class Kt extends Qt{__mathquillify(...t){return super.__mathquillify(...t),this.__controller.editable=!0,this.__controller.delegateMouseEvents(),this.__controller.editablesTextareaEvents(),this}focus(){return document.activeElement===this.__controller.textarea?this.__controller.textarea?.dispatchEvent(new FocusEvent("focus")):this.__controller.textarea?.focus(),this}blur(){return document.activeElement!==this.__controller.textarea?this.__controller.textarea?.dispatchEvent(new FocusEvent("blur")):this.__controller.textarea?.blur(),this}write(t){return this.__controller.writeLatex(t),this.__controller.scrollHoriz(),this.__controller.blurred&&this.__controller.cursor.hide().parent?.blur(),this}empty(){const t=this.__controller.root,e=this.__controller.cursor;return t.eachChild("postOrder","dispose"),delete t.ends[s],delete t.ends[1],t.elements.empty(),delete e.selection,e.insAtRightEnd(t),this}cmd(t){const e=this.__controller.notify(),s=e.cursor;if(/^\\[a-z]+$/i.test(t)&&!s.isTooDeep()){t=t.slice(1);const e=h[t];if(e){const n=new e(t);s.selection&&n.replaces(s.replaceSelection()),n.createLeftOf(s.show()),this.__controller.scrollHoriz()}}else s.parent?.write(s,t);return e.blurred&&s.hide().parent?.blur(),this}select(){const t=this.__controller;for(t.notify("move").cursor.insAtRightEnd(t.root);t.cursor[s];)t.selectLeft();return this}clearSelection(){return this.__controller.cursor.clearSelection(),this}moveToDirEnd(t){return this.__controller.notify("move").cursor.insAtDirEnd(t,this.__controller.root),this}moveToLeftEnd(){return this.moveToDirEnd(s)}moveToRightEnd(){return this.moveToDirEnd(1)}keystroke(t){const e=t.replace(/^\s+|\s+$/g,"").split(/\s+/);for(const t of e){const e=new KeyboardEvent("noop");e.preventDefault=i,this.__controller.keystroke(t,e)}return this}typedText(t){for(const e of t)this.__controller.typedText(e);return this}dropEmbedded(t,e,s){const n=document.elementFromPoint(t-window.scrollX,e-window.scrollY);this.__controller.seek(n,t);(new h.embed).setOptions(s).createLeftOf(this.__controller.cursor)}clickAt(t,e,s){s=s||document.elementFromPoint(t,e);const n=this.__controller,i=n.root;return i.elements.firstElement.contains(s)||(s=i.elements.firstElement),n.seek(s,t+window.scrollX),n.blurred&&this.focus(),this}ignoreNextMousedown(t){return this.__controller.cursor.options.ignoreNextMousedown=t,this}}class Gt{push(t){this[Object.keys(this).length]=t}get length(){return Object.keys(this).length}get(t){for(const e of Object.keys(this)){const s=parseInt(e);if(this[s].name===t)return this[s]}}}class Zt extends Qt{constructor(t){super(t),this.__controller.root.postOrder("registerInnerField",this.innerFields=new Gt,Yt)}__mathquillify(){return super.__mathquillify("mq-math-mode"),this.__options.mouseEvents&&(this.__controller.delegateMouseEvents(),this.__controller.staticMathTextareaEvents()),this}latex(t){const e=super.latex(t);return void 0!==t&&this.__controller.root.postOrder("registerInnerField",this.innerFields=new Gt,Yt),e}}Zt.RootBlock=At;class Xt extends Kt{__mathquillify(){const t=this.__controller.root.reflow;return this.__controller.root.reflow=i,super.__mathquillify("mq-editable-field","mq-math-mode"),t?this.__controller.root.reflow=t:delete this.__controller.root.reflow,this}}Xt.RootBlock=It;class Yt extends Xt{constructor(){super(...arguments),this.name=""}makeStatic(){this.__controller.editable=!1,this.__controller.root.blur(),this.__controller.unbindEditablesEvents(),this.__controller.container.classList.remove("mq-editable-field")}makeEditable(){this.__controller.editable=!0,this.__controller.editablesTextareaEvents(),this.__controller.cursor.insAtRightEnd(this.__controller.root),this.__controller.container.classList.add("mq-editable-field")}}class Jt extends Kt{__mathquillify(){return super.__mathquillify("mq-editable-field","mq-text-mode")}latex(t){return void 0!==t?(this.__controller.renderLatexText(t),this.__controller.blurred&&this.__controller.cursor.hide().parent?.blur(),this):this.__controller.exportLatex()}}Jt.RootBlock=class extends It{keystroke(t,e,s){if("Spacebar"!==t&&"Shift-Spacebar"!==t)return super.keystroke(t,e,s)}write(t,e){t.show().deleteSelection(),"$"===e?new Rt(t).createLeftOf(t):new mt(e,"<"===e?"&lt;":">"===e?"&gt;":void 0).createLeftOf(t)}};class te extends ut{constructor(t,e,s){super(t,`<${e} ${s}>&0</${e}>`)}}h.mathrm=o(te,"\\mathrm","span",'class="mq-roman mq-font"'),h.mathit=o(te,"\\mathit","i",'class="mq-font"'),h.mathbf=o(te,"\\mathbf","b",'class="mq-font"'),h.mathsf=o(te,"\\mathsf","span",'class="mq-sans-serif mq-font"'),h.mathtt=o(te,"\\mathtt","span",'class="mq-monospace mq-font"'),h.underline=o(te,"\\underline","span",'class="mq-non-leaf mq-underline"'),h.overline=h.bar=o(te,"\\overline","span",'class="mq-non-leaf mq-overline"'),h.overrightarrow=o(te,"\\overrightarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-right"'),h.overleftarrow=o(te,"\\overleftarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-left"'),h.overleftrightarrow=o(te,"\\overleftrightarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-both"'),h.overarc=o(te,"\\overarc","span",'class="mq-non-leaf mq-overarc"'),h.dot=class extends ut{constructor(){super("\\dot",'<span class="mq-non-leaf"><span class="mq-dot-recurring-inner"><span class="mq-dot-recurring">&#x2d9;</span><span class="mq-empty-box">&0</span></span></span>')}},h.textcolor=class extends ut{setColor(t){this.color=t,this.htmlTemplate=`<span class="mq-textcolor" style="color:${t}">&0</span>`}latex(){return`\\textcolor{${this.color??""}}{${this.blocks[0].latex()}}`}parser(){return ct.optWhitespace.then(ct.string("{")).then(ct.regex(/^[#\w\s.,()%-]*/)).skip(ct.string("}")).then((t=>(this.setColor(t),super.parser())))}isStyleBlock(){return!0}},h.class=class extends ut{parser(){return ct.optWhitespace.then(ct.string("{")).then(ct.regex(/^[-\w\s\\\xA0-\xFF]*/)).skip(ct.string("}")).then((t=>(this.cls=t||"",this.htmlTemplate=`<span class="mq-class ${t}">&0</span>`,super.parser())))}latex(){return`\\class{${this.cls??""}}{${this.blocks[0].latex()}}`}isStyleBlock(){return!0}},h.subscript=h._=class extends St{constructor(){super(),this.supsub="sub",this.htmlTemplate='<span class="mq-supsub mq-non-leaf"><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203;</span></span>',this.textTemplate=["_"]}finalizeTree(){this.downInto=this.sub=this.ends[s],this.sub.upOutOf=kt,super.finalizeTree()}},h.superscript=h.supscript=h["^"]=class extends St{constructor(){super(),this.supsub="sup",this.htmlTemplate='<span class="mq-supsub mq-non-leaf mq-sup-only"><span class="mq-sup">&0</span></span>',this.textTemplate=["^(",")"]}finalizeTree(){this.upInto=this.sup=this.ends[1],this.sup.downOutOf=kt,super.finalizeTree()}};class ee extends Lt{constructor(t,e){super(t,`<span class="mq-large-operator mq-non-leaf"><span class="mq-to"><span>&1</span></span><big>${e}</big><span class="mq-from"><span>&0</span></span></span>`,[t.length>1?t.slice(1):t])}createLeftOf(t){super.createLeftOf(t),t.options.sumStartsWithNEquals&&!this.replacedFragment&&(new Ot("n").createLeftOf(t),(new xt).createLeftOf(t))}}h["∑"]=h.sum=h.summation=o(ee,"\\sum ","&sum;"),h["∏"]=h.prod=h.product=o(ee,"\\prod ","&prod;"),h.coprod=h.coproduct=o(ee,"\\coprod ","&#8720;"),h["∫"]=h.int=h.integral=class extends Lt{constructor(){super("\\int ",'<span class="mq-int mq-non-leaf"><big>&int;</big><span class="mq-supsub mq-non-leaf"><span class="mq-sup"><span class="mq-sup-inner">&1</span></span><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203</span></span></span>')}},h.frac=h.dfrac=h.cfrac=h.fraction=Et;const se=t=>class extends t{createLeftOf(t){if(!this.replacedFragment){let e=t[s];for(;e&&!(e instanceof gt||"text"in h&&e instanceof h.text||e instanceof Lt||"\\ "===e.ctrlSeq||/^[,;:]$/.test(e.ctrlSeq));)e=e[s];e instanceof Lt&&e[1]instanceof St&&(e=e[1],e&&e[1]instanceof St&&e[1]?.ctrlSeq!=e.ctrlSeq&&(e=e[1])),e===t[s]||t.isTooDeep(1)||t[s]?.elements.hasClass("mq-operator-name")||(this.replaces(new J(e?.[1]||t.parent?.ends[s],t[s])),t[s]=e)}super.createLeftOf(t)}};h.over=d["/"]=class extends(se(Et)){};for(const t of["sin","cos","tan","sec","csc","cot"])for(const e of[t,`arc${t}`,`a${t}`,`${t}h`,`arc${t}h`,`a${t}h`])h[e]=o(Tt,`\\${e}`);h.exp=o(Tt,"\\exp"),h.ln=o(Tt,"\\ln"),h.log=class extends Tt{constructor(){super("\\log")}text(){const t=this.blocks[0].ends[s]?.sub?.text()||"",e=this.blocks[1].text()||"",n=yt("^",this.blocks[0].ends[s]?.sup);if(t){if("10"===t)return n?`(log10(${e}))${n}`:`log10(${e})`;if(this.getController()?.options.logsChangeBase){let i=this[s];for(;i&&"\\ "===i.ctrlSeq;i=i[s]);return n||i&&!(i instanceof gt)||i instanceof gt&&i.isUnary?`(log(${e})/log(${t}))${n}`:`log(${e})/log(${t})`}return n?`(logb(${t},${e}))${n}`:`logb(${t},${e})`}return super.text()}};class ne extends ut{constructor(){super(),this.ctrlSeq="\\sqrt",this.htmlTemplate='<span class="mq-non-leaf"><span class="mq-scaled mq-sqrt-prefix">&radic;</span><span class="mq-non-leaf mq-sqrt-stem">&0</span></span>',this.textTemplate=["sqrt(",")"],this.reflow=()=>{const t=this.ends[1]?.elements.firstElement;t&&at([t.previousElementSibling],1,t.getBoundingClientRect().height/parseFloat(getComputedStyle(t).fontSize)-.1)}}parser(){return $t.optBlock.then((t=>$t.block.map((e=>{const s=new ie;return s.blocks=[t,e],t.adopt(s),e.adopt(s,t),s})))).or(super.parser())}}h.sqrt=h["√"]=ne,h.hat=class extends ut{constructor(){super("\\hat",'<span class="mq-non-leaf"><span class="mq-hat-prefix">^</span><span class="mq-hat-stem">&0</span></span>',["hat(",")"])}};class ie extends ne{constructor(){super(),this.htmlTemplate='<span class="mq-nthroot mq-non-leaf">&0</span><span class="mq-scaled"><span class="mq-sqrt-prefix mq-scaled">&radic;</span><span class="mq-sqrt-stem mq-non-leaf">&1</span></span>',this.textTemplate=["root(",",",")"]}latex(){return`\\sqrt[${this.ends[s]?.latex()??""}]{${this.ends[1]?.latex()??""}}`}text(){const t=this.ends[s]?.text()??"";if(""===t||"2"===t)return`sqrt(${this.ends[1]?.text()??""})`;if(this.getController()?.options.rootsAreExponents){const e=this[1]instanceof St&&"sup"===this[1].supsub;return`${e?"(":""}(${this.ends[1]?.text()??""})^(1/${t})${e?")":""}`}return`root(${t},${this.ends[1]?.text()??""})`}}h.root=h.nthroot=ie;class re extends ut{constructor(t,e,s){super(t,`<span class="mq-non-leaf"><span class="mq-diacritic-above">${e}</span><span class="mq-diacritic-stem">&0</span></span>`,s)}}h.vec=o(re,"\\vec","&rarr;",["vec(",")"]),h.tilde=o(re,"\\tilde","~",["tilde(",")"]);const oe=(t,e)=>{const n=e||t,i=p[t],r=p[n];d[t]=o(_t,s,t,i,n,r),d[i]=o(_t,1,t,i,n,r)};oe("("),oe("["),oe("{","\\{"),h.langle=o(_t,s,"&lang;","&rang;","\\langle ","\\rangle "),h.rangle=o(_t,1,"&lang;","&rang;","\\langle ","\\rangle "),h.abs=d["|"]=o(_t,s,"|","|","|","|"),h.lVert=o(_t,s,"&#8741;","&#8741;","\\lVert ","\\rVert "),h.rVert=o(_t,1,"&#8741;","&#8741;","\\lVert ","\\rVert "),h.left=class extends ut{parser(){return ct.optWhitespace.then(ct.regex(/^(?:[([|]|\\\{|\\langle(?![a-zA-Z])|\\lVert(?![a-zA-Z]))/)).then((t=>{let e=t.startsWith("\\")?t.slice(1):t;return"\\langle"==t&&(e="&lang;",t+=" "),"\\lVert"==t&&(e="&#8741;",t+=" "),$t.then((s=>ct.string("\\right").skip(ct.optWhitespace).then(ct.regex(/^(?:[\])|]|\\\}|\\rangle(?![a-zA-Z])|\\rVert(?![a-zA-Z]))/)).map((n=>{let i=n.startsWith("\\")?n.slice(1):n;"\\rangle"==n&&(i="&rang;",n=`${n} `),"\\rVert"==n&&(i="&#8741;",n=`${n} `);const r=new _t(void 0,e,i,t,n);return r.blocks=[s],s.adopt(r),r}))))}))}},h.right=class extends ut{parser(){return ct.fail("unmatched \\right")}};class ae extends(lt(ut)){constructor(){super("\\binom",'<span class="mq-non-leaf"><span class="mq-paren mq-scaled">(</span><span class="mq-non-leaf"><span class="mq-array mq-non-leaf"><span>&0</span><span>&1</span></span></span><span class="mq-paren mq-scaled">)</span></span>',["choose(",",",")"])}}h.binom=h.binomial=ae,h.choose=class extends(se(ae)){},h.editable=h.MathQuillMathField=class extends ut{constructor(){super("\\MathQuillMathField",'<span class="mq-editable-field"><span class="mq-root-block">&0</span></span>'),this.name=""}parser(){return ct.string("[").then(ct.regex(/^[a-z][a-z0-9]*/i)).skip(ct.string("]")).map((t=>this.name=t)).or(ct.succeed()).then(super.parser())}finalizeTree(t){const e=new Vt(this.ends[s],this.elements.firstElement,t);e.KIND_OF_MQ="MathField",this.field=new Yt(e),this.field.name=this.name,e.editable=!0,e.createTextarea(),e.editablesTextareaEvents(),e.cursor.insAtRightEnd(e.root),rt(e.root),this.field.blur()}registerInnerField(t){t.push(this.field)}latex(){return this.ends[s]?.latex()??""}text(){return this.ends[s]?.text()??""}},h.embed=class extends ft{setOptions(t){const e=()=>"";return this.text=t.text||e,this.htmlTemplate=t.htmlString||"",this.latex=t.latex||e,this}parser(){return ct.string("{").then(ct.regex(/^[a-z][a-z0-9]*/i)).skip(ct.string("}")).then((t=>ct.string("[").then(ct.regex(/^[-\w\s]*/)).skip(ct.string("]")).or(ct.succeed()).map((e=>this.setOptions(u[t](e))))))}},d["\\"]=class extends ut{constructor(){super(),this.ctrlSeq="\\",this.htmlTemplate='<span class="mq-latex-command-input mq-non-leaf">\\<span>&0</span></span>',this.textTemplate=["\\"]}replaces(t){this._replacedFragment=t?.disown(),this.isEmpty=()=>!1}createBlocks(){super.createBlocks();const t=this.ends[s];t.focus=()=>(t.parent?.elements.addClass("mq-has-cursor"),t.isEmpty()&&t.parent?.elements.removeClass("mq-empty"),t),t.blur=()=>(t.parent?.elements.removeClass("mq-has-cursor"),t.isEmpty()&&t.parent?.elements.addClass("mq-empty"),t),t.write=(e,s)=>{e.show().deleteSelection(),/[a-z]/i.exec(s)?new mt(s).createLeftOf(e):(t.parent.renderCommand(e),"\\"===s&&t.isEmpty()||e.parent?.write(e,s))},t.keystroke=(e,s,n)=>"Tab"===e||"Enter"===e||"Spacebar"===e?(t.parent.renderCommand(n.cursor),void s.preventDefault()):super.keystroke(e,s,n)}createLeftOf(t){if(super.createLeftOf(t),this._replacedFragment){const t=this.elements.first;this._replacedFragment.elements.addClass("mq-blur"),this.elements.first.before(...this._replacedFragment.elements.contents),this.elements.add(this._replacedFragment.elements);const e=e=>{e.stopPropagation(),e.preventDefault(),t.dispatchEvent(new MouseEvent(e.type,e))};this.elements.firstElement.addEventListener("mousedown",e),this.elements.firstElement.addEventListener("mousemove",e)}}latex(){return"\\"+(this.ends[s]?.latex()??"")+" "}renderCommand(t){this.elements=new Y(this.elements.last),this.remove(),this[1]?t.insLeftOf(this[1]):t.insAtRightEnd(this.parent);const e=this.ends[s]?.latex()||" ";if(e in h){const s=new h[e](e);this._replacedFragment&&s.replaces(this._replacedFragment),s.createLeftOf(t)}else{const s=new Ft;s.replaces(e),s.createLeftOf(t),t.insRightOf(s),this._replacedFragment&&this._replacedFragment.remove()}}};class le extends ft{constructor(t){super(),this.ctrlSeq=t}createLeftOf(t){for(const e of this.ctrlSeq)new Ot(e).createLeftOf(t)}parser(){const t=new At;for(const e of this.ctrlSeq)new Ot(e).adopt(t,t.ends[1]);return ct.succeed(t.children())}}for(const t in(new X).autoOperatorNames)"_maxLength"!==t&&(h[t]=le);h.operatorname=class extends ut{constructor(t,e,s){super(t,e,s),this.createLeftOf=i}numBlocks(){return 1}parser(){return $t.block.map((t=>t.children()))}},h.f=class extends Ot{constructor(){super("f",'<var class="mq-f">f</var>'),this.letter="f"}italicize(t){return this.elements.html("f"),this.elements.toggleClass("mq-f",t),super.italicize(t)}},h[" "]=h.space=o(mt,"\\ ","&nbsp;"),h["'"]=h.prime=o(mt,"'","&prime;"),h.backslash=o(mt,"\\backslash ","\\"),d["\\"]||(d["\\"]=h.backslash),h.$=o(mt,"\\$","$");class ce extends ft{constructor(t,e){super(t,`<span class="mq-non-symbola">${e||t}</span>`)}}h["@"]=ce,h["&"]=o(ce,"\\&","&amp;"),h["%"]=o(ce,"\\%","%"),h.alpha=h.beta=h.gamma=h.delta=h.zeta=h.eta=h.theta=h.iota=h.kappa=h.mu=h.nu=h.xi=h.rho=h.sigma=h.tau=h.chi=h.psi=h.omega=class extends qt{constructor(t){super(`\\${t} `,`&${t};`)}},h.phi=o(qt,"\\phi ","&#981;"),h.phiv=h.varphi=o(qt,"\\varphi ","&phi;"),h.epsilon=o(qt,"\\epsilon ","&#1013;"),h.epsiv=h.varepsilon=o(qt,"\\varepsilon ","&epsilon;"),h.piv=h.varpi=o(qt,"\\varpi ","&piv;"),h.sigmaf=h.sigmav=h.varsigma=o(qt,"\\varsigma ","&sigmaf;"),h.thetav=h.vartheta=h.thetasym=o(qt,"\\vartheta ","&thetasym;"),h.upsilon=h.upsi=o(qt,"\\upsilon ","&upsilon;"),h.gammad=h.Gammad=h.digamma=o(qt,"\\digamma ","&#989;"),h.kappav=h.varkappa=o(qt,"\\varkappa ","&#1008;"),h.rhov=h.varrho=o(qt,"\\varrho ","&#1009;"),h.pi=h["π"]=o(ce,"\\pi ","&pi;"),h.lambda=o(ce,"\\lambda ","&lambda;"),h.Upsilon=h.Upsi=h.upsih=h.Upsih=o(ft,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),h.Gamma=h.Delta=h.Theta=h.Lambda=h.Xi=h.Pi=h.Sigma=h.Phi=h.Psi=h.Omega=h.forall=class extends mt{constructor(t){super(`\\${t} `,`&${t};`)}};class he extends ut{constructor(t){super(),this.latex=()=>t}createLeftOf(t){const e=$t.parse(this.latex());e.children().adopt(t.parent,t[s],t[1]),t[s]=e.ends[1],t.element.before(...e.domify().contents),e.finalizeInsert(t.options,t),e.ends[1]?.[1]?.siblingCreated?.(t.options,s),e.ends[s]?.[s]?.siblingCreated?.(t.options,1),t.parent?.bubble("reflow")}parser(){const t=$t.parse(this.latex());return ct.succeed(t.children())}}h["¹"]=o(he,"^1"),h["²"]=o(he,"^2"),h["³"]=o(he,"^3"),h["¼"]=o(he,"\\frac14"),h["½"]=o(he,"\\frac12"),h["¾"]=o(he,"\\frac34");class de extends gt{constructor(t,e,s){super(t,`<span>${e||t}</span>`,s,!0),this.siblingCreated=this.siblingDeleted=(t,e)=>this.contactWeld(t,e)}contactWeld(t,e){const n=t=>t[s]?!!(t[s]instanceof gt||/^[,;:([]$/.test(t[s].ctrlSeq)):!t.parent?.parent?.isStyleBlock()||n(t.parent.parent);if(1!==e)return this.isUnary=n(this),this.elements.firstElement.className=this.isUnary?"":"mq-binary-operator",this}}h["+"]=o(de,"+","+"),h["–"]=h["-"]=o(de,"-","&minus;"),h["±"]=h.pm=h.plusmn=h.plusminus=o(de,"\\pm ","&plusmn;"),h.mp=h.mnplus=h.minusplus=o(de,"\\mp ","&#8723;"),d["*"]=h.sdot=h.cdot=o(gt,"\\cdot ","&middot;","*");const pe={ctrlSeq:"\\le ",html:"&le;",text:"<=",ctrlSeqStrict:"<",htmlStrict:"&lt;",textStrict:"<"},ue={ctrlSeq:"\\ge ",html:"&ge;",text:">=",ctrlSeqStrict:">",htmlStrict:"&gt;",textStrict:">"},fe={ctrlSeq:"\\ne ",html:"&ne;",text:"!=",ctrlSeqStrict:"!",htmlStrict:"!",textStrict:"!"};h["<"]=h.lt=o(bt,pe,!0),h[">"]=h.gt=o(bt,ue,!0),h["!"]=h.factorial=o(wt,fe,!0),h["≤"]=h.le=h.leq=o(bt,pe,!1),h["≥"]=h.ge=h.geq=o(bt,ue,!1),h["≠"]=h.ne=h.neq=o(wt,fe,!1),h["="]=xt,h["×"]=h.times=o(gt,"\\times ","&times;","*"),h["÷"]=h.div=h.divide=h.divides=o(gt,"\\div ","&divide;","/"),d["~"]=h.sim=o(gt,"\\sim ","~","~"),h.notin=h.cong=h.equiv=h.oplus=h.otimes=class extends gt{constructor(t){super(`\\${t} `,`&${t};`)}},h["∗"]=h.ast=h.star=h.loast=h.lowast=o(gt,"\\ast ","&lowast;"),h.therefor=h.therefore=o(gt,"\\therefore ","&there4;"),h.cuz=h.because=o(gt,"\\because ","&#8757;"),h.prop=h.propto=o(gt,"\\propto ","&prop;"),h["≈"]=h.asymp=h.approx=o(gt,"\\approx ","&asymp;"),h.isin=h.in=o(gt,"\\in ","&isin;"),h.ni=h.contains=o(gt,"\\ni ","&ni;"),h.notni=h.niton=h.notcontains=h.doesnotcontain=o(gt,"\\not\\ni ","&#8716;"),h.sub=h.subset=o(gt,"\\subset ","&sub;"),h.sup=h.supset=h.superset=o(gt,"\\supset ","&sup;"),h.nsub=h.notsub=h.nsubset=h.notsubset=o(gt,"\\not\\subset ","&#8836;"),h.nsup=h.notsup=h.nsupset=h.notsupset=h.nsuperset=h.notsuperset=o(gt,"\\not\\supset ","&#8837;"),h.sube=h.subeq=h.subsete=h.subseteq=o(gt,"\\subseteq ","&sube;"),h.supe=h.supeq=h.supsete=h.supseteq=h.supersete=h.superseteq=o(gt,"\\supseteq ","&supe;"),h.nsube=h.nsubeq=h.notsube=h.notsubeq=h.nsubsete=h.nsubseteq=h.notsubsete=h.notsubseteq=o(gt,"\\not\\subseteq ","&#8840;"),h.nsupe=h.nsupeq=h.notsupe=h.notsupeq=h.nsupsete=h.nsupseteq=h.notsupsete=h.notsupseteq=h.nsupersete=h.nsuperseteq=h.notsupersete=h.notsuperseteq=o(gt,"\\not\\supseteq ","&#8841;"),h.mathbb=class extends ut{constructor(t,e,s){super(t,e,s),this.createLeftOf=i}numBlocks(){return 1}parser(){return ct.optWhitespace.then(ct.string("{")).then(ct.optWhitespace).then(ct.regex(/^[NPZQRCH]/)).skip(ct.optWhitespace).skip(ct.string("}")).map((t=>new h[t]))}},h.N=h.naturals=h.Naturals=o(mt,"\\mathbb{N}","&#8469;"),h.P=h.primes=h.Primes=h.projective=h.Projective=h.probability=h.Probability=o(mt,"\\mathbb{P}","&#8473;"),h.Z=h.integers=h.Integers=o(mt,"\\mathbb{Z}","&#8484;"),h.Q=h.rationals=h.Rationals=o(mt,"\\mathbb{Q}","&#8474;"),h.R=h.reals=h.Reals=o(mt,"\\mathbb{R}","&#8477;"),h.C=h.complex=h.Complex=h.complexes=h.Complexes=h.complexplane=h.Complexplane=h.ComplexPlane=o(mt,"\\mathbb{C}","&#8450;"),h.H=h.Hamiltonian=h.quaternions=h.Quaternions=o(mt,"\\mathbb{H}","&#8461;"),h.quad=h.emsp=o(mt,"\\quad ","    "),h.qquad=o(mt,"\\qquad ","        "),h.diamond=o(mt,"\\diamond ","&#9671;"),h.bigtriangleup=o(mt,"\\bigtriangleup ","&#9651;"),h.ominus=o(mt,"\\ominus ","&#8854;"),h.uplus=o(mt,"\\uplus ","&#8846;"),h.bigtriangledown=o(mt,"\\bigtriangledown ","&#9661;"),h.sqcap=o(mt,"\\sqcap ","&#8851;"),h.triangleleft=o(mt,"\\triangleleft ","&#8882;"),h.sqcup=o(mt,"\\sqcup ","&#8852;"),h.triangleright=o(mt,"\\triangleright ","&#8883;"),h.odot=h.circledot=o(mt,"\\odot ","&#8857;"),h.bigcirc=o(mt,"\\bigcirc ","&#9711;"),h.dagger=o(mt,"\\dagger ","&#0134;"),h.ddagger=o(mt,"\\ddagger ","&#135;"),h.wr=o(mt,"\\wr ","&#8768;"),h.amalg=o(mt,"\\amalg ","&#8720;"),h.models=o(mt,"\\models ","&#8872;"),h.prec=o(mt,"\\prec ","&#8826;"),h.succ=o(mt,"\\succ ","&#8827;"),h.preceq=o(mt,"\\preceq ","&#8828;"),h.succeq=o(mt,"\\succeq ","&#8829;"),h.simeq=o(mt,"\\simeq ","&#8771;"),h.mid=o(mt,"\\mid ","&#8739;"),h.ll=o(mt,"\\ll ","&#8810;"),h.gg=o(mt,"\\gg ","&#8811;"),h.parallel=o(mt,"\\parallel ","&#8741;"),h.nparallel=o(mt,"\\nparallel ","&#8742;"),h.bowtie=o(mt,"\\bowtie ","&#8904;"),h.sqsubset=o(mt,"\\sqsubset ","&#8847;"),h.sqsupset=o(mt,"\\sqsupset ","&#8848;"),h.smile=o(mt,"\\smile ","&#8995;"),h.sqsubseteq=o(mt,"\\sqsubseteq ","&#8849;"),h.sqsupseteq=o(mt,"\\sqsupseteq ","&#8850;"),h.doteq=o(mt,"\\doteq ","&#8784;"),h.frown=o(mt,"\\frown ","&#8994;"),h.vdash=o(mt,"\\vdash ","&#8870;"),h.dashv=o(mt,"\\dashv ","&#8867;"),h.nless=o(mt,"\\nless ","&#8814;"),h.ngtr=o(mt,"\\ngtr ","&#8815;"),h.longleftarrow=o(mt,"\\longleftarrow ","&#8592;"),h.longrightarrow=o(mt,"\\longrightarrow ","&#8594;"),h.Longleftarrow=o(mt,"\\Longleftarrow ","&#8656;"),h.Longrightarrow=o(mt,"\\Longrightarrow ","&#8658;"),h.longleftrightarrow=o(mt,"\\longleftrightarrow ","&#8596;"),h.updownarrow=o(mt,"\\updownarrow ","&#8597;"),h.Longleftrightarrow=o(mt,"\\Longleftrightarrow ","&#8660;"),h.Updownarrow=o(mt,"\\Updownarrow ","&#8661;"),h.mapsto=o(mt,"\\mapsto ","&#8614;"),h.nearrow=o(mt,"\\nearrow ","&#8599;"),h.hookleftarrow=o(mt,"\\hookleftarrow ","&#8617;"),h.hookrightarrow=o(mt,"\\hookrightarrow ","&#8618;"),h.searrow=o(mt,"\\searrow ","&#8600;"),h.leftharpoonup=o(mt,"\\leftharpoonup ","&#8636;"),h.rightharpoonup=o(mt,"\\rightharpoonup ","&#8640;"),h.swarrow=o(mt,"\\swarrow ","&#8601;"),h.leftharpoondown=o(mt,"\\leftharpoondown ","&#8637;"),h.rightharpoondown=o(mt,"\\rightharpoondown ","&#8641;"),h.nwarrow=o(mt,"\\nwarrow ","&#8598;"),h.ldots=o(mt,"\\ldots ","&#8230;"),h.cdots=o(mt,"\\cdots ","&#8943;"),h.vdots=o(mt,"\\vdots ","&#8942;"),h.ddots=o(mt,"\\ddots ","&#8945;"),h.surd=o(mt,"\\surd ","&#8730;"),h.triangle=o(mt,"\\triangle ","&#9651;"),h.ell=o(mt,"\\ell ","&#8467;"),h.top=o(mt,"\\top ","&#8868;"),h.flat=o(mt,"\\flat ","&#9837;"),h.natural=o(mt,"\\natural ","&#9838;"),h.sharp=o(mt,"\\sharp ","&#9839;"),h.wp=o(mt,"\\wp ","&#8472;"),h.bot=o(mt,"\\bot ","&#8869;"),h.clubsuit=o(mt,"\\clubsuit ","&#9827;"),h.diamondsuit=o(mt,"\\diamondsuit ","&#9826;"),h.heartsuit=o(mt,"\\heartsuit ","&#9825;"),h.spadesuit=o(mt,"\\spadesuit ","&#9824;"),h.parallelogram=o(mt,"\\parallelogram ","&#9649;"),h.square=o(mt,"\\square ","&#11036;"),h.oint=o(mt,"\\oint ","&#8750;"),h.bigcap=o(mt,"\\bigcap ","&#8745;"),h.bigcup=o(mt,"\\bigcup ","&#8746;"),h.bigsqcup=o(mt,"\\bigsqcup ","&#8852;"),h.bigvee=o(mt,"\\bigvee ","&#8744;"),h.bigwedge=o(mt,"\\bigwedge ","&#8743;"),h.bigodot=o(mt,"\\bigodot ","&#8857;"),h.bigotimes=o(mt,"\\bigotimes ","&#8855;"),h.bigoplus=o(mt,"\\bigoplus ","&#8853;"),h.biguplus=o(mt,"\\biguplus ","&#8846;"),h.lfloor=o(mt,"\\lfloor ","&#8970;"),h.rfloor=o(mt,"\\rfloor ","&#8971;"),h.lceil=o(mt,"\\lceil ","&#8968;"),h.rceil=o(mt,"\\rceil ","&#8969;"),h.opencurlybrace=h.lbrace=o(mt,"\\lbrace ","{"),h.closecurlybrace=h.rbrace=o(mt,"\\rbrace ","}"),h.lbrack=o(mt,"["),h.rbrack=o(mt,"]"),h.slash=o(mt,"/"),h.vert=o(mt,"|"),h.perp=h.perpendicular=o(mt,"\\perp ","&perp;"),h.nabla=h.del=o(mt,"\\nabla ","&nabla;"),h.hbar=o(mt,"\\hbar ","&#8463;"),h.AA=h.Angstrom=h.angstrom=o(mt,"\\AA ","&#8491;","Å"),h.ring=h.circ=h.circle=o(mt,"\\circ ","&#8728;"),h.bull=h.bullet=o(mt,"\\bullet ","&bull;"),h.setminus=h.smallsetminus=o(mt,"\\setminus ","&#8726;"),h.not=h["¬"]=h.neg=o(mt,"\\neg ","&not;"),h["…"]=h.dots=h.ellip=h.hellip=h.ellipsis=h.hellipsis=o(mt,"\\dots ","&hellip;"),h.converges=h.darr=h.dnarr=h.dnarrow=h.downarrow=o(mt,"\\downarrow ","&darr;"),h.dArr=h.dnArr=h.dnArrow=h.Downarrow=o(mt,"\\Downarrow ","&dArr;"),h.diverges=h.uarr=h.uparrow=o(mt,"\\uparrow ","&uarr;"),h.uArr=h.Uparrow=o(mt,"\\Uparrow ","&uArr;"),h.to=o(gt,"\\to ","&rarr;"),h.rarr=h.rightarrow=o(mt,"\\rightarrow ","&rarr;"),h.implies=o(gt,"\\Rightarrow ","&rArr;"),h.rArr=h.Rightarrow=o(mt,"\\Rightarrow ","&rArr;"),h.gets=o(gt,"\\gets ","&larr;"),h.larr=h.leftarrow=o(mt,"\\leftarrow ","&larr;"),h.impliedby=o(gt,"\\Leftarrow ","&lArr;"),h.lArr=h.Leftarrow=o(mt,"\\Leftarrow ","&lArr;"),h.harr=h.lrarr=h.leftrightarrow=o(mt,"\\leftrightarrow ","&harr;"),h.iff=o(gt,"\\Leftrightarrow ","&hArr;"),h.hArr=h.lrArr=h.Leftrightarrow=o(mt,"\\Leftrightarrow ","&hArr;"),h.Re=h.Real=h.real=o(mt,"\\Re ","&real;"),h.Im=h.imag=h.image=h.imagin=h.imaginary=h.Imaginary=o(mt,"\\Im ","&image;"),h.part=h.partial=o(mt,"\\partial ","&part;"),h.inf=h.infty=h.infin=h.infinity=o(mt,"\\infty ","&infin;","inf"),h.pounds=o(mt,"\\pounds ","&pound;"),h.alef=h.alefsym=h.aleph=h.alephsym=o(mt,"\\aleph ","&alefsym;"),h.xist=h.xists=h.exist=h.exists=o(mt,"\\exists ","&exist;"),h.nexists=h.nexist=o(mt,"\\nexists ","&#8708;"),h.and=h.land=h.wedge=o(gt,"\\wedge ","&and;"),h.or=h.lor=h.vee=o(gt,"\\vee ","&or;"),h.o=h.O=h.empty=h.emptyset=h.oslash=h.Oslash=h.nothing=h.varnothing=o(gt,"\\varnothing ","&empty;"),h.U=h.cup=h.union=o(gt,"\\cup ","&cup;","U"),h.cap=h.intersect=h.intersection=o(gt,"\\cap ","&cap;"),h.deg=h.degree=class extends mt{constructor(){super("\\degree ","&deg;")}text(){const t=this[1]?.text();return"°"+(t&&/^[^FCK]$/.test(t)?" ":"")}},h.ang=h.angle=o(mt,"\\angle ","&ang;"),h.measuredangle=o(mt,"\\measuredangle ","&#8737;");class me{static getInterface(){const t={},s=t=>{if(!(t instanceof HTMLElement))return;const s=t.querySelector(".mq-root-block")?.getAttribute(e)??!1,n=s?st.byId[parseInt(s)].controller:void 0;return n?.apiClass};s.saneKeyboardEvents=nt,s.config=t=>(X.config(X.prototype,t),s),s.registerEmbed=(t,e)=>{if(!/^[a-z][a-z0-9]*$/i.test(t))throw"Embed name must start with letter and be only letters and digits";u[t]=e};for(const[e,n]of Object.entries({StaticMath:Zt,MathField:Xt,InnerMathField:Yt,TextField:Jt}))t[e]=n,s[e]=(n,i)=>{const r=s(n);if(r instanceof t[e]||!(n instanceof HTMLElement))return r;const o=new Vt(new t[e].RootBlock,n,new X);return o.KIND_OF_MQ=e,new t[e](o).config(i).__mathquillify()},Object.setPrototypeOf(s[e],t[e]);return s}static noConflict(){return window.MathQuill=this.origMathQuill,me}}me.origMathQuill=window.MathQuill;const ge=me;ge.VERSION="0.10.1",window.MathQuill=ge})();